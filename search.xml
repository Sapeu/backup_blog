<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Git é’©å­</title>
    <url>/2018/09/20/Git%E9%92%A9%E5%AD%90/</url>
    <content><![CDATA[<p>åŸåœ°å€åœ¨è¿™é‡Œï¼š<a href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90" target="_blank" rel="noopener">è‡ªå®šä¹‰ - Git-Git - é’©å­</a></p>
<blockquote class="blockquote-center"><h1 id="Gité’©å­"><a href="#Gité’©å­" class="headerlink" title="Gité’©å­"></a> Git é’©å­</h1><p>Git èƒ½åœ¨ç‰¹å®šçš„é‡è¦åŠ¨ä½œå‘ç”Ÿæ—¶è§¦å‘è‡ªå®šä¹‰è„šæœ¬ã€‚ æœ‰ä¸¤ç»„è¿™æ ·çš„é’©å­ï¼šå®¢æˆ·ç«¯çš„å’ŒæœåŠ¡å™¨ç«¯çš„ã€‚ å®¢æˆ·ç«¯é’©å­ç”±è¯¸å¦‚æäº¤å’Œåˆå¹¶è¿™æ ·çš„æ“ä½œæ‰€è°ƒç”¨ï¼Œè€ŒæœåŠ¡å™¨ç«¯é’©å­ä½œç”¨äºè¯¸å¦‚æ¥æ”¶è¢«æ¨é€çš„æäº¤è¿™æ ·çš„è”ç½‘æ“ä½œ</p>
</blockquote>
<a id="more"></a>
<h1 id="Gité’©å­åœ¨å“ª"><a href="#Gité’©å­åœ¨å“ª" class="headerlink" title="Gité’©å­åœ¨å“ª?"></a>Git é’©å­åœ¨å“ªï¼Ÿ</h1><p>é’©å­éƒ½è¢«å­˜å‚¨åœ¨ Git ç›®å½•ä¸‹çš„ hooks å­ç›®å½•ä¸­ã€‚ ä¹Ÿå³ç»å¤§éƒ¨åˆ†é¡¹ç›®ä¸­çš„ .git/hooks ã€‚ å½“ä½ ç”¨ git init åˆå§‹åŒ–ä¸€ä¸ªæ–°ç‰ˆæœ¬åº“æ—¶ï¼ŒGit é»˜è®¤ä¼šåœ¨è¿™ä¸ªç›®å½•ä¸­æ”¾ç½®ä¸€äº›ç¤ºä¾‹è„šæœ¬ã€‚è¿™äº›è„šæœ¬é™¤äº†æœ¬èº«å¯ä»¥è¢«è°ƒç”¨å¤–ï¼Œå®ƒä»¬è¿˜é€éœ²äº†è¢«è§¦å‘æ—¶æ‰€ä¼ å…¥çš„å‚æ•°ã€‚ æ‰€æœ‰çš„ç¤ºä¾‹éƒ½æ˜¯ shell è„šæœ¬ï¼Œå…¶ä¸­ä¸€äº›è¿˜æ··æ‚äº† Perl ä»£ç ï¼Œä¸è¿‡ï¼Œä»»ä½•æ­£ç¡®å‘½åçš„å¯æ‰§è¡Œè„šæœ¬éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ â€”â€” ä½ å¯ä»¥ç”¨ Ruby æˆ– Pythonï¼Œæˆ–å…¶å®ƒè¯­è¨€ç¼–å†™å®ƒä»¬ã€‚ è¿™äº›ç¤ºä¾‹çš„åå­—éƒ½æ˜¯ä»¥ .sample ç»“å°¾ï¼Œå¦‚æœä½ æƒ³å¯ç”¨å®ƒä»¬ï¼Œå¾—å…ˆç§»é™¤è¿™ä¸ªåç¼€ã€‚</p>
<p>æŠŠä¸€ä¸ªæ­£ç¡®å‘½åä¸”å¯æ‰§è¡Œçš„æ–‡ä»¶æ”¾å…¥ Git ç›®å½•ä¸‹çš„ hooks å­ç›®å½•ä¸­ï¼Œå³å¯æ¿€æ´»è¯¥é’©å­è„šæœ¬ã€‚ è¿™æ ·ä¸€æ¥ï¼Œå®ƒå°±èƒ½è¢« Git è°ƒç”¨</p>
<h1 id="å®¢æˆ·ç«¯é’©å­"><a href="#å®¢æˆ·ç«¯é’©å­" class="headerlink" title="å®¢æˆ·ç«¯é’©å­"></a>å®¢æˆ·ç«¯é’©å­</h1><p>æäº¤å·¥ä½œæµé’©å­ã€ç”µå­é‚®ä»¶å·¥ä½œæµé’©å­å’Œå…¶å®ƒé’©å­</p>
<h2 id="pre-commit"><a href="#pre-commit" class="headerlink" title="pre-commit"></a>pre-commit</h2><p>é’©å­åœ¨é”®å…¥æäº¤ä¿¡æ¯å‰è¿è¡Œã€‚ å®ƒç”¨äºæ£€æŸ¥å³å°†æäº¤çš„å¿«ç…§ï¼Œä¾‹å¦‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ‰€é—æ¼ï¼Œç¡®ä¿æµ‹è¯•è¿è¡Œï¼Œä»¥åŠæ ¸æŸ¥ä»£ç ã€‚ å¦‚æœè¯¥é’©å­ä»¥éé›¶å€¼é€€å‡ºï¼ŒGit å°†æ”¾å¼ƒæ­¤æ¬¡æäº¤ï¼Œä¸è¿‡ä½ å¯ä»¥ç”¨ git commit â€“no-verify æ¥ç»•è¿‡è¿™ä¸ªç¯èŠ‚ã€‚ ä½ å¯ä»¥åˆ©ç”¨è¯¥é’©å­ï¼Œæ¥æ£€æŸ¥ä»£ç é£æ ¼æ˜¯å¦ä¸€è‡´ï¼ˆè¿è¡Œç±»ä¼¼ lint çš„ç¨‹åºï¼‰ã€å°¾éšç©ºç™½å­—ç¬¦æ˜¯å¦å­˜åœ¨ï¼ˆè‡ªå¸¦çš„é’©å­å°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰ï¼Œæˆ–æ–°æ–¹æ³•çš„æ–‡æ¡£æ˜¯å¦é€‚å½“ã€‚</p>
<h2 id="prepare-commit-msg"><a href="#prepare-commit-msg" class="headerlink" title="prepare-commit-msg"></a>prepare-commit-msg</h2><p>prepare-commit-msg é’©å­åœ¨å¯åŠ¨æäº¤ä¿¡æ¯ç¼–è¾‘å™¨ä¹‹å‰ï¼Œé»˜è®¤ä¿¡æ¯è¢«åˆ›å»ºä¹‹åè¿è¡Œã€‚ å®ƒå…è®¸ä½ ç¼–è¾‘æäº¤è€…æ‰€çœ‹åˆ°çš„é»˜è®¤ä¿¡æ¯ã€‚ è¯¥é’©å­æ¥æ”¶ä¸€äº›é€‰é¡¹ï¼šå­˜æœ‰å½“å‰æäº¤ä¿¡æ¯çš„æ–‡ä»¶çš„è·¯å¾„ã€æäº¤ç±»å‹å’Œä¿®è¡¥æäº¤çš„æäº¤çš„ SHA-1 æ ¡éªŒã€‚ å®ƒå¯¹ä¸€èˆ¬çš„æäº¤æ¥è¯´å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼›ç„¶è€Œå¯¹é‚£äº›ä¼šè‡ªåŠ¨äº§ç”Ÿé»˜è®¤ä¿¡æ¯çš„æäº¤ï¼Œå¦‚æäº¤ä¿¡æ¯æ¨¡æ¿ã€åˆå¹¶æäº¤ã€å‹ç¼©æäº¤å’Œä¿®è®¢æäº¤ç­‰éå¸¸å®ç”¨ã€‚ ä½ å¯ä»¥ç»“åˆæäº¤æ¨¡æ¿æ¥ä½¿ç”¨å®ƒï¼ŒåŠ¨æ€åœ°æ’å…¥ä¿¡æ¯ã€‚</p>
<h2 id="commit-msg"><a href="#commit-msg" class="headerlink" title="commit-msg"></a>commit-msg</h2><p>commit-msg é’©å­æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œæ­¤å‚æ•°å³ä¸Šæ–‡æåˆ°çš„ï¼Œå­˜æœ‰å½“å‰æäº¤ä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶çš„è·¯å¾„ã€‚ å¦‚æœè¯¥é’©å­è„šæœ¬ä»¥éé›¶å€¼é€€å‡ºï¼ŒGit å°†æ”¾å¼ƒæäº¤ï¼Œå› æ­¤ï¼Œå¯ä»¥ç”¨æ¥åœ¨æäº¤é€šè¿‡å‰éªŒè¯é¡¹ç›®çŠ¶æ€æˆ–æäº¤ä¿¡æ¯ã€‚ åœ¨æœ¬ç« çš„æœ€åä¸€èŠ‚ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨è¯¥é’©å­æ¥æ ¸å¯¹æäº¤ä¿¡æ¯æ˜¯å¦éµå¾ªæŒ‡å®šçš„æ¨¡æ¿ã€‚</p>
<h2 id="post-commit"><a href="#post-commit" class="headerlink" title="post-commit"></a>post-commit</h2><p>post-commit é’©å­åœ¨æ•´ä¸ªæäº¤è¿‡ç¨‹å®Œæˆåè¿è¡Œã€‚ å®ƒä¸æ¥æ”¶ä»»ä½•å‚æ•°ï¼Œä½†ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡è¿è¡Œ git log -1 HEAD æ¥è·å¾—æœ€åä¸€æ¬¡çš„æäº¤ä¿¡æ¯ã€‚ è¯¥é’©å­ä¸€èˆ¬ç”¨äºé€šçŸ¥ä¹‹ç±»çš„äº‹æƒ…</p>
<h2 id="ç”µå­é‚®ä»¶å·¥ä½œæµé’©å­"><a href="#ç”µå­é‚®ä»¶å·¥ä½œæµé’©å­" class="headerlink" title="ç”µå­é‚®ä»¶å·¥ä½œæµé’©å­"></a>ç”µå­é‚®ä»¶å·¥ä½œæµé’©å­</h2><p>ä½ å¯ä»¥ç»™ç”µå­é‚®ä»¶å·¥ä½œæµè®¾ç½®ä¸‰ä¸ªå®¢æˆ·ç«¯é’©å­ã€‚ å®ƒä»¬éƒ½æ˜¯ç”± git am å‘½ä»¤è°ƒç”¨çš„ï¼Œå› æ­¤å¦‚æœä½ æ²¡æœ‰åœ¨ä½ çš„å·¥ä½œæµä¸­ç”¨åˆ°è¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥è·³åˆ°ä¸‹ä¸€èŠ‚ã€‚ å¦‚æœä½ éœ€è¦é€šè¿‡ç”µå­é‚®ä»¶æ¥æ”¶ç”± git format-patch äº§ç”Ÿçš„è¡¥ä¸ï¼Œè¿™äº›é’©å­ä¹Ÿè®¸ç”¨å¾—ä¸Šã€‚</p>
<h3 id="applypatch-msg"><a href="#applypatch-msg" class="headerlink" title="applypatch-msg"></a>applypatch-msg</h3><p>ç¬¬ä¸€ä¸ªè¿è¡Œçš„é’©å­æ˜¯ applypatch-msg ã€‚ å®ƒæ¥æ”¶å•ä¸ªå‚æ•°ï¼šåŒ…å«è¯·æ±‚åˆå¹¶ä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶çš„åå­—ã€‚ å¦‚æœè„šæœ¬è¿”å›éé›¶å€¼ï¼ŒGit å°†æ”¾å¼ƒè¯¥è¡¥ä¸ã€‚ ä½ å¯ä»¥ç”¨è¯¥è„šæœ¬æ¥ç¡®ä¿æäº¤ä¿¡æ¯ç¬¦åˆæ ¼å¼ï¼Œæˆ–ç›´æ¥ç”¨è„šæœ¬ä¿®æ­£æ ¼å¼é”™è¯¯ã€‚</p>
<h3 id="pre-applypatch"><a href="#pre-applypatch" class="headerlink" title="pre-applypatch"></a>pre-applypatch</h3><p>ä¸‹ä¸€ä¸ªåœ¨ git am è¿è¡ŒæœŸé—´è¢«è°ƒç”¨çš„æ˜¯ pre-applypatch ã€‚ æœ‰äº›éš¾ä»¥ç†è§£çš„æ˜¯ï¼Œå®ƒæ­£å¥½è¿è¡Œäºåº”ç”¨è¡¥ä¸ ä¹‹åï¼Œäº§ç”Ÿæäº¤ä¹‹å‰ï¼Œæ‰€ä»¥ä½ å¯ä»¥ç”¨å®ƒåœ¨æäº¤å‰æ£€æŸ¥å¿«ç…§ã€‚ ä½ å¯ä»¥ç”¨è¿™ä¸ªè„šæœ¬è¿è¡Œæµ‹è¯•æˆ–æ£€æŸ¥å·¥ä½œåŒºã€‚ å¦‚æœæœ‰ä»€ä¹ˆé—æ¼ï¼Œæˆ–æµ‹è¯•æœªèƒ½é€šè¿‡ï¼Œè„šæœ¬ä¼šä»¥éé›¶å€¼é€€å‡ºï¼Œä¸­æ–­ git am çš„è¿è¡Œï¼Œè¿™æ ·è¡¥ä¸å°±ä¸ä¼šè¢«æäº¤ã€‚</p>
<h3 id="post-applypatch"><a href="#post-applypatch" class="headerlink" title="post-applypatch"></a>post-applypatch</h3><p>post-applypatch è¿è¡Œäºæäº¤äº§ç”Ÿä¹‹åï¼Œæ˜¯åœ¨ git am è¿è¡ŒæœŸé—´æœ€åè¢«è°ƒç”¨çš„é’©å­ã€‚ ä½ å¯ä»¥ç”¨å®ƒæŠŠç»“æœé€šçŸ¥ç»™ä¸€ä¸ªå°ç»„æˆ–æ‰€æ‹‰å–çš„è¡¥ä¸çš„ä½œè€…ã€‚ ä½†ä½ æ²¡åŠæ³•ç”¨å®ƒåœæ­¢æ‰“è¡¥ä¸çš„è¿‡ç¨‹</p>
<h1 id="æœåŠ¡å™¨ç«¯é’©å­"><a href="#æœåŠ¡å™¨ç«¯é’©å­" class="headerlink" title="æœåŠ¡å™¨ç«¯é’©å­"></a>æœåŠ¡å™¨ç«¯é’©å­</h1><p>é™¤äº†å®¢æˆ·ç«¯é’©å­ï¼Œä½œä¸ºç³»ç»Ÿç®¡ç†å‘˜ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨è‹¥å¹²æœåŠ¡å™¨ç«¯çš„é’©å­å¯¹é¡¹ç›®å¼ºåˆ¶æ‰§è¡Œå„ç§ç±»å‹çš„ç­–ç•¥ã€‚ è¿™äº›é’©å­è„šæœ¬åœ¨æ¨é€åˆ°æœåŠ¡å™¨ä¹‹å‰å’Œä¹‹åè¿è¡Œã€‚ æ¨é€åˆ°æœåŠ¡å™¨å‰è¿è¡Œçš„é’©å­å¯ä»¥åœ¨ä»»ä½•æ—¶å€™ä»¥éé›¶å€¼é€€å‡ºï¼Œæ‹’ç»æ¨é€å¹¶ç»™å®¢æˆ·ç«¯è¿”å›é”™è¯¯æ¶ˆæ¯ï¼Œè¿˜å¯ä»¥ä¾ä½ æ‰€æƒ³è®¾ç½®è¶³å¤Ÿå¤æ‚çš„æ¨é€ç­–ç•¥ã€‚</p>
<h2 id="pre-receive"><a href="#pre-receive" class="headerlink" title="pre-receive"></a>pre-receive</h2><p>å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„æ¨é€æ“ä½œæ—¶ï¼Œæœ€å…ˆè¢«è°ƒç”¨çš„è„šæœ¬æ˜¯ pre-receiveã€‚ å®ƒä»æ ‡å‡†è¾“å…¥è·å–ä¸€ç³»åˆ—è¢«æ¨é€çš„å¼•ç”¨ã€‚å¦‚æœå®ƒä»¥éé›¶å€¼é€€å‡ºï¼Œæ‰€æœ‰çš„æ¨é€å†…å®¹éƒ½ä¸ä¼šè¢«æ¥å—ã€‚ ä½ å¯ä»¥ç”¨è¿™ä¸ªé’©å­é˜»æ­¢å¯¹å¼•ç”¨è¿›è¡Œéå¿«è¿›ï¼ˆnon-fast-forwardï¼‰çš„æ›´æ–°ï¼Œæˆ–è€…å¯¹è¯¥æ¨é€æ‰€ä¿®æ”¹çš„æ‰€æœ‰å¼•ç”¨å’Œæ–‡ä»¶è¿›è¡Œè®¿é—®æ§åˆ¶ã€‚</p>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p>update è„šæœ¬å’Œ pre-receive è„šæœ¬ååˆ†ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå®ƒä¼šä¸ºæ¯ä¸€ä¸ªå‡†å¤‡æ›´æ–°çš„åˆ†æ”¯å„è¿è¡Œä¸€æ¬¡ã€‚ å‡å¦‚æ¨é€è€…åŒæ—¶å‘å¤šä¸ªåˆ†æ”¯æ¨é€å†…å®¹ï¼Œpre-receive åªè¿è¡Œä¸€æ¬¡ï¼Œç›¸æ¯”ä¹‹ä¸‹ update åˆ™ä¼šä¸ºæ¯ä¸€ä¸ªè¢«æ¨é€çš„åˆ†æ”¯å„è¿è¡Œä¸€æ¬¡ã€‚ å®ƒä¸ä¼šä»æ ‡å‡†è¾“å…¥è¯»å–å†…å®¹ï¼Œè€Œæ˜¯æ¥å—ä¸‰ä¸ªå‚æ•°ï¼šå¼•ç”¨çš„åå­—ï¼ˆåˆ†æ”¯ï¼‰ï¼Œæ¨é€å‰çš„å¼•ç”¨æŒ‡å‘çš„å†…å®¹çš„ SHA-1 å€¼ï¼Œä»¥åŠç”¨æˆ·å‡†å¤‡æ¨é€çš„å†…å®¹çš„ SHA-1 å€¼ã€‚ å¦‚æœ update è„šæœ¬ä»¥éé›¶å€¼é€€å‡ºï¼Œåªæœ‰ç›¸åº”çš„é‚£ä¸€ä¸ªå¼•ç”¨ä¼šè¢«æ‹’ç»ï¼›å…¶ä½™çš„ä¾ç„¶ä¼šè¢«æ›´æ–°ã€‚</p>
<h2 id="post-receive"><a href="#post-receive" class="headerlink" title="post-receive"></a>post-receive</h2><p>post-receive æŒ‚é’©åœ¨æ•´ä¸ªè¿‡ç¨‹å®Œç»“ä»¥åè¿è¡Œï¼Œå¯ä»¥ç”¨æ¥æ›´æ–°å…¶ä»–ç³»ç»ŸæœåŠ¡æˆ–è€…é€šçŸ¥ç”¨æˆ·ã€‚ å®ƒæ¥å—ä¸ pre-receive ç›¸åŒçš„æ ‡å‡†è¾“å…¥æ•°æ®ã€‚ å®ƒçš„ç”¨é€”åŒ…æ‹¬ç»™æŸä¸ªé‚®ä»¶åˆ—è¡¨å‘ä¿¡ï¼Œé€šçŸ¥æŒç»­é›†æˆï¼ˆcontinous integrationï¼‰çš„æœåŠ¡å™¨ï¼Œæˆ–è€…æ›´æ–°é—®é¢˜è¿½è¸ªç³»ç»Ÿï¼ˆticket-tracking systemï¼‰ â€”â€” ç”šè‡³å¯ä»¥é€šè¿‡åˆ†ææäº¤ä¿¡æ¯æ¥å†³å®šæŸä¸ªé—®é¢˜ï¼ˆticketï¼‰æ˜¯å¦åº”è¯¥è¢«å¼€å¯ï¼Œä¿®æ”¹æˆ–è€…å…³é—­ã€‚ è¯¥è„šæœ¬æ— æ³•ç»ˆæ­¢æ¨é€è¿›ç¨‹ï¼Œä¸è¿‡å®¢æˆ·ç«¯åœ¨å®ƒç»“æŸè¿è¡Œä¹‹å‰å°†ä¿æŒè¿æ¥çŠ¶æ€ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³åšå…¶ä»–æ“ä½œéœ€è°¨æ…ä½¿ç”¨å®ƒï¼Œå› ä¸ºå®ƒå°†è€—è´¹ä½ å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´</p>
<hr>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>é’©å­</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab+Jenkins+K8S (ç”Ÿäº§ç¯å¢ƒå¯ CI/CD æ¨¡æ‹Ÿ)</title>
    <url>/2020/07/11/GitLab-Jenkins-K8S-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%8F%AFCI-CD%E6%A8%A1%E6%8B%9F/</url>
    <content><![CDATA[<p>è¯¥æ–‡æ¡£å¤åˆ¶è‡ª <a href="https://www.feiyiblog.com/2020/05/11/Docker-k8s-GitLab-Jenkins-%E7%94%9F%E6%88%90%E7%8E%AF%E5%A2%83%E5%8F%AFCI-CD%E6%A8%A1%E6%8B%9F/" target="_blank" rel="noopener">Docker+k8s+GitLab+Jenkins (ç”Ÿäº§ç¯å¢ƒå¯ CI/CD æ¨¡æ‹Ÿ)</a></p>
<p>è¿™ä¸ªç¯å¢ƒä»…åšå‚è€ƒ</p>
<blockquote class="blockquote-center"><p>é€šè¿‡ Docker+k8s æ¥éƒ¨ç½² web é›†ç¾¤ï¼ŒGitLab+Jenkins å®ç°ä»£ç è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œåœ¨ Jenkins ä¸­é€šè¿‡æ„å»ºè„šæœ¬ï¼Œå®ç° k8s å¯¹å®¹å™¨ web é›†ç¾¤ä»£ç è‡ªåŠ¨æ›´æ–°</p>
</blockquote>
<h1 id="è¿è¡Œç¯å¢ƒ"><a href="#è¿è¡Œç¯å¢ƒ" class="headerlink" title="è¿è¡Œç¯å¢ƒ"></a>è¿è¡Œç¯å¢ƒ</h1><table>
<thead>
<tr>
<th style="text-align:left">ip</th>
<th style="text-align:left"> æœåŠ¡</th>
<th style="text-align:left">å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"> 192.168.1.1</td>
<td style="text-align:left">GitLab</td>
<td style="text-align:left"> å†…å­˜ 4Gï¼ŒåŒæ ¸ CPUï¼ˆCentOS7.8ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">192.168.1.4</td>
<td style="text-align:left">Jenkins</td>
<td style="text-align:left"> å†…æ ¸ 2Gï¼ŒåŒæ ¸ CPUï¼ˆCentOS7.8ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">192.168.1.11</td>
<td style="text-align:left">Docker+k8s-master</td>
<td style="text-align:left"> å†…æ ¸ 2Gï¼ŒåŒæ ¸ CPUï¼ˆCentOS7.8ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">192.168.1.12</td>
<td style="text-align:left">Docker+k8s-node1</td>
<td style="text-align:left"> å†…æ ¸ 2Gï¼ŒåŒæ ¸ CPUï¼ˆCentOS7.8ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">192.168.1.13</td>
<td style="text-align:left">Docker+k8s-node2</td>
<td style="text-align:left"> å†…æ ¸ 2Gï¼ŒåŒæ ¸ CPUï¼ˆCentOS7.8ï¼‰</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h1 id="éƒ¨ç½²ç›®çš„"><a href="#éƒ¨ç½²ç›®çš„" class="headerlink" title="éƒ¨ç½²ç›®çš„"></a>éƒ¨ç½²ç›®çš„</h1><p>åœ¨å¼€å‘è¿›è¡Œä»£ç çš„æ›´æ–°åï¼Œä¸Šä¼ åˆ° GitLabï¼ŒJenkins æ ¹æ® webhook å‘ç°ä»£ç çš„æ›´æ–°åï¼Œè¿›è¡Œä»£ç æ„å»ºå’Œ k8s ä¸­çš„è‡ªåŠ¨éƒ¨ç½²ï¼Œå±•ç°åˆ° web ç•Œé¢ä¸­</p>
<h1 id="æ­å»ºGitLab"><a href="#æ­å»ºGitLab" class="headerlink" title="æ­å»ºGitLab"></a>æ­å»º GitLab</h1><p>å‚è€ƒæ–‡æ¡£ <a href="https://www.feiyiblog.com/2020/03/06/Gitç‰ˆæœ¬æ§åˆ¶/" target="_blank" rel="noopener">Git æ­å»º</a>å’Œ <a href="https://www.feiyiblog.com/2020/03/07/GitLabåœ¨çº¿ä»£ç ä»“åº“æ‰˜ç®¡/" target="_blank" rel="noopener">GitLab æ­å»º</a></p>
<p>é™¤äº†ç¨‹åºæ˜¯é€šè¿‡ yum å®‰è£…çš„æ²¡æœ‰ä»€ä¹ˆä¸åŒ</p>
<h2 id="192-168-1-1"><a href="#192-168-1-1" class="headerlink" title="192.168.1.1"></a>192.168.1.1</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># hostnamectl set-hostname gitlab</span></span><br><span class="line">[root@localhost ~]<span class="comment"># bash</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">192.168.1.1 gitlab</span><br><span class="line">192.168.1.4 jenkins</span><br></pre></td></tr></tbody></table></figure>
<p>å¼€å¯è·¯ç”±è½¬å‘</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># echo "net.ipv4.ip_forward = 1" &gt;&gt; /etc/sysctl.conf</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># sysctl -p</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£… Git</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># yum -y install git</span></span><br></pre></td></tr></tbody></table></figure>
<p>é…ç½® GitLab çš„ repo æº</p>
<p>ä½¿ç”¨æ¸…åå¤§å­¦çš„ repo æº</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># cat &lt;&lt;EOF&gt; /etc/yum.repos.d/gitlab-ce.repo</span></span><br><span class="line">[gitlab-ce]</span><br><span class="line">name=Gitlab CE Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£… GitLab</p>
<p>ä½¿ç”¨ yum å®‰è£…çš„æœ€æ–°ç‰ˆæœ¬å‘ç°å¯¹å¯†é’¥é—®é¢˜è¿˜æœ‰ç‚¹ä¸ç¨³å®š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># yum -y install gitlab-ce</span></span><br></pre></td></tr></tbody></table></figure>
<p>å°† SELinux è®¾ç½®ä¸ºç¦ç”¨ï¼Œå¯è§£å†³è®¾ç½® gitlab å…¬é’¥åä¸ç”Ÿæ•ˆï¼Œè€Œä¸”è¿˜éœ€è¦è¾“å…¥è´¦å·å¯†ç ï¼ˆè¿™ä¸ªé—®é¢˜æˆ‘æ‰¾äº†åå¤šä¸ªå°æ—¶ğŸ˜“ï¼‰</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ä¿®æ”¹è®¿é—® GitLab çš„åŸŸåæˆ–è€… ip</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/gitlab/gitlab.rb</span></span><br><span class="line"><span class="comment"># å°†external_url 'http://gitlab.example.com'</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸ºexternal_url 'http://192.168.1.1'ï¼Œæœ¬æœºåŸŸåæˆ–è€…ip</span></span><br></pre></td></tr></tbody></table></figure>
<p>åˆå§‹åŒ– GitLab</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># gitlab-ctl reconfigure   # ç¬¬ä¸€æ¬¡éœ€è¦å¾ˆé•¿æ—¶é—´</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¯åŠ¨ GitLab</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># gitlab-ctl start</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ”¾è¡Œç«¯å£</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># firewall-cmd --permanent --add-service=http</span></span><br><span class="line">success</span><br><span class="line">[root@gitlab ~]<span class="comment"># firewall-cmd --reload</span></span><br><span class="line">success</span><br></pre></td></tr></tbody></table></figure>
<p>ç™»é™†åˆ° Web ç®¡ç†ç•Œé¢è®¾ç½®çš„ç™»å½•å¯†ç </p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">http://192.168.1.1</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://www.feiyiblog.com/uploads/set_password.png" alt="GitLab"></p>
<p>é»˜è®¤ç”¨æˆ·ä¸º root</p>
<p><img src="https://www.feiyiblog.com/uploads/first_login.png" alt="GitLab"></p>
<p>ç™»å½•æˆåŠŸ</p>
<p><img src="https://www.feiyiblog.com/uploads/gitlab_login.png" alt="img"></p>
<h1 id="æ­å»ºJenkins"><a href="#æ­å»ºJenkins" class="headerlink" title="æ­å»ºJenkins"></a>æ­å»º Jenkins</h1><p>å‚è€ƒæ–‡æ¡£ <a href="https://www.feiyiblog.com/2020/03/10/Jenkinsä»£ç è‡ªåŠ¨åŒ–/" target="_blank" rel="noopener">Jenkins æ­å»º</a></p>
<p>é™¤äº†ç¨‹åºæ˜¯é€šè¿‡ yum å®‰è£…çš„æ²¡æœ‰ä»€ä¹ˆä¸åŒ</p>
<h2 id="192-168-1-4"><a href="#192-168-1-4" class="headerlink" title="192.168.1.4"></a>192.168.1.4</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># hostnamectl set-hostname jenkins</span></span><br><span class="line">[root@localhost ~]<span class="comment"># bash</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">192.168.1.1 gitlab</span><br><span class="line">192.168.1.4 jenkins</span><br><span class="line">192.168.1.11 k8s-master</span><br><span class="line">192.168.1.12 k8s-node1</span><br><span class="line">192.168.1.13 k8s-node2</span><br></pre></td></tr></tbody></table></figure>
<p>å‡†å¤‡ Java ç¯å¢ƒ</p>
<p>ä½¿ç”¨ 1.8 çš„ Java ç¯å¢ƒ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># yum -y install java-1.8.0-openjdk*</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç¼–å†™ Jenkins çš„ repo æº</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat &lt;&lt;EOF&gt; /etc/yum.repos.d/jenkins.repo</span></span><br><span class="line">[jenkins]</span><br><span class="line">name=Jenkins-stable</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/jenkins/redhat-stable/</span><br><span class="line">gpgcheck=1</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># å¯¼å…¥rpmå¯†é’¥</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span></span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£… Jenkins</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># yum -y install https://mirrors.tuna.tsinghua.edu.cn/jenkins/redhat-stable/jenkins-2.235.1-1.1.noarch.rpm</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># yum -y install git</span></span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£…åŠ é€Ÿç¥å¥‡ï¼ŒJenkins é»˜è®¤ä½¿ç”¨ google æ¥æœç´¢æ’ä»¶çš„ä¸‹è½½ï¼Œè€Œä¸”æ’ä»¶ä¹Ÿåœ¨å›½å¤–ç½‘ç«™ï¼Œè¿™é‡Œå°† updates ç›®å½•ä¸­çš„ <code>default.json</code> å†…çš„ url æ¢ä¸ºç™¾åº¦ï¼ˆæœç´¢å¼•æ“ï¼‰å’Œæ¸…åï¼ˆä¸‹è½½æ’ä»¶åœ°å€ï¼‰ï¼Œ<strong>å‰æå¿…é¡»å‡ºç°è¿‡ä»¥ä¸Šç•Œé¢æ‰ä¼šæœ‰ updates ç›®å½•</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># sed -i 's/http:\/\/www.google.com/https:\/\/www.baidu.com/g' /var/lib/jenkins/updates/default.json</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># sed -i 's/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g' /var/lib/jenkins/updates/default.json</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¯åŠ¨ Jenkinsï¼Œå¹¶æ”¾è¡Œ 8080 ç«¯å£</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># systemctl start jenkins</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># systemctl enable jenkins</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># firewall-cmd --permanent --add-port=8080/tcp</span></span><br><span class="line">success</span><br><span class="line">[root@jenkins ~]<span class="comment"># firewall-cmd --reload</span></span><br><span class="line">success</span><br></pre></td></tr></tbody></table></figure>
<p>è¿›å…¥ Jenkins çš„ web å®‰è£…ç•Œ</p>
<p>è®¿é—® <code>http://192.168.1.4:8080</code></p>
<p><img src="https://www.feiyiblog.com/uploads/wait_jiemian.png" alt="Jenkins"></p>
<p>åœ¨ Linux æœ¬åœ°æŸ¥çœ‹ç®¡ç†å‘˜å¯†ç </p>
<p><img src="https://www.feiyiblog.com/uploads/lock_jenkins.png" alt="Jenkins"></p>
<p>è¾“å…¥å¯†ç åï¼Œå¦‚æœå‡ºç°æ­¤ç•Œé¢</p>
<p><img src="https://www.feiyiblog.com/uploads/shaowait.png" alt="Jenkins"></p>
<p>å¦‚æœå‡ºç°ä»¥ä¸‹</p>
<p><img src="https://www.feiyiblog.com/uploads/lixian.png" alt="Jenkins"></p>
<p>è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">ç¬¬ä¸€æ­¥ æ‰“å¼€æ’ä»¶ç®¡ç†çš„é«˜çº§è®¾ç½®é¡µé¢</span><br><span class="line">http://192.168.1.4:8080/pluginManager/advanced</span><br><span class="line"></span><br><span class="line">ç¬¬äºŒæ­¥ ä¿®æ”¹æ›´æ–°ç«™ç‚¹åœ°å€</span><br><span class="line">å°†httpsæ”¹ä¸ºhttp  å¦‚æœä¸è¡Œ å¯ä»¥ç”¨æ¸…åçš„åŠ é€Ÿç«™ç‚¹ å¦‚ä¸‹</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£…æ¨èæ’ä»¶</p>
<p><img src="https://www.feiyiblog.com/uploads/install_chajian.png" alt="Jenkins"></p>
<p><img src="https://www.feiyiblog.com/uploads/wait_install.png" alt="Jenkins"></p>
<p>ç„¶åé‡å¯æœåŠ¡ï¼Œå¹¶é‡æ–°è®¿é—® Jenkins çš„ web ç•Œé¢</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># systemctl restart jenkins</span></span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£…å®Œæˆåï¼Œåˆ›å»ºç®¡ç†ç”¨æˆ·</p>
<p><img src="https://www.feiyiblog.com/uploads/create_jenkins_user.png" alt="Jenkins"></p>
<p><img src="https://www.feiyiblog.com/uploads/shili_config.png" alt="Jenkins"></p>
<p><img src="https://www.feiyiblog.com/uploads/jenkins_install_success.png" alt="Jenkins"></p>
<p>åœ¨æ’ä»¶ç®¡ç†ä¸­å®‰è£…ä¸‰ä¸ªå…³äº GitLab çš„æ’ä»¶ï¼Œç”¨äºæŒç»­é›†æˆ</p>
<blockquote>
<p>Gitlab Authentication</p>
<p>Gitlab</p>
<p>Gitlab Hook</p>
</blockquote>
<p>é€‰æ‹©å®‰è£…åè‡ªåŠ¨é‡å¯ Jenkins</p>
<h1 id="æ­å»ºKubernetesé›†ç¾¤"><a href="#æ­å»ºKubernetesé›†ç¾¤" class="headerlink" title="æ­å»ºKubernetesé›†ç¾¤"></a>æ­å»º Kubernetes é›†ç¾¤</h1><p>å‚è€ƒæœ¬ç«™æ–‡æ¡£ <a href="https://www.feiyiblog.com/2020/03/23/å®‰è£…Dockerâ€”â€”é•œåƒåŠ é€Ÿ/" target="_blank" rel="noopener">Docker å®‰è£…</a>å’Œ <a href="https://www.feiyiblog.com/2020/04/17/kuberneteså®‰è£…åŠé›†ç¾¤æ­å»º/" target="_blank" rel="noopener">Kubernetes é›†ç¾¤æ­å»º</a></p>
<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>æŒ‰ç…§è¿è¡Œç¯å¢ƒä¸­çš„ç³»ç»Ÿç‰ˆæœ¬å’Œç¡¬ä»¶è¦æ±‚</p>
<p>è¿™é‡Œä½¿ç”¨çš„ç°æˆçš„ Docker ç¯å¢ƒï¼Œæ²¡æœ‰çš„å¯ä»¥å‚è€ƒä»¥ä¸Šé“¾æ¥éƒ¨ç½²</p>
<h3 id="æ›´æ”¹ä¸»æœºå"><a href="#æ›´æ”¹ä¸»æœºå" class="headerlink" title="æ›´æ”¹ä¸»æœºå"></a>æ›´æ”¹ä¸»æœºå</h3><p><strong>192.168.1.11</strong></p>
<p>æ›´æ”¹ä¸»æœºåï¼Œå¹¶è®¾ç½®å¯¹å…¶ä»–ä¸¤å°èŠ‚ç‚¹çš„å…å¯†ç™»å½•</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># hostnamectl set-hostname k8s-master</span></span><br><span class="line">[root@localhost ~]<span class="comment"># bash</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">192.168.1.11 k8s-master</span><br><span class="line">192.168.1.12 k8s-node1</span><br><span class="line">192.168.1.13 k8s-node2</span><br><span class="line">[root@k8s-master ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Created directory <span class="string">'/root/.ssh'</span>.</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:y0cMv9gJDShPYbfH/+WUbwtLJivwGTNv4EVT6TpxXHQ root@k8s-master</span><br><span class="line">The key<span class="string">'s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|      o .     o.E|</span></span><br><span class="line"><span class="string">|     . + o   o ..|</span></span><br><span class="line"><span class="string">|    . o + o + .  |</span></span><br><span class="line"><span class="string">|     +   B = +  .|</span></span><br><span class="line"><span class="string">|      . S * *  .o|</span></span><br><span class="line"><span class="string">|       o @ * . +.|</span></span><br><span class="line"><span class="string">|        B &amp;..+. +|</span></span><br><span class="line"><span class="string">|         * o= o..|</span></span><br><span class="line"><span class="string">|          o. . . |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br><span class="line"><span class="string">[root@k8s-master ~]# ssh-copy-id -i root@k8s-node1</span></span><br><span class="line"><span class="string">[root@k8s-master ~]# ssh-copy-id -i root@k8s-node2</span></span><br></pre></td></tr></tbody></table></figure>
<p>å°† hosts æ–‡ä»¶ä¼ è¾“åˆ°å…¶ä»–ä¸¤å°èŠ‚ç‚¹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># scp /etc/hosts root@k8s-node1:/etc</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /etc/hosts root@k8s-node2:/etc</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>192.168.1.12</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># hostnamectl set-hostname k8s-node1</span></span><br><span class="line">[root@localhost ~]<span class="comment"># bash</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>192.168.1.13</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># hostnamectl set-hostname k8s-node2</span></span><br><span class="line">[root@localhost ~]<span class="comment"># bash</span></span><br><span class="line">[root@k8s-node2 ~]<span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å…³é—­æ²™ç›’"><a href="#å…³é—­æ²™ç›’" class="headerlink" title="å…³é—­æ²™ç›’"></a>å…³é—­æ²™ç›’</h3><p><strong>k8s-master/node1/node2</strong></p>
<p>å°† SELinux è®¾ç½®ä¸ºç¦ç”¨ï¼ˆä¹Ÿå¯ä»¥è®¾ç½®ä¸º permissive æ¨¡å¼ï¼‰</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¼€æ”¾æ‰€éœ€ç«¯å£"><a href="#å¼€æ”¾æ‰€éœ€ç«¯å£" class="headerlink" title="å¼€æ”¾æ‰€éœ€ç«¯å£"></a>å¼€æ”¾æ‰€éœ€ç«¯å£</h3><p>é˜²ç«å¢™æ”¾è¡Œç«¯å£ï¼Œå› ä¸ºæ¯”è¾ƒå¤šï¼Œçœäº‹å¯ä»¥ç›´æ¥ <code>systemctl stop firewalld</code></p>
<p><strong>master èŠ‚ç‚¹</strong></p>
<table>
<thead>
<tr>
<th>åè®®</th>
<th>æ–¹å‘</th>
<th>ç«¯å£èŒƒå›´</th>
<th>ä½œç”¨</th>
<th>ä½¿ç”¨è€…</th>
</tr>
</thead>
<tbody>
<tr>
<td> TCP</td>
<td> å…¥ç«™</td>
<td> 6443*</td>
<td>Kubernetes API æœåŠ¡å™¨</td>
<td>æ‰€æœ‰ç»„ä»¶</td>
</tr>
<tr>
<td> TCP</td>
<td> å…¥ç«™</td>
<td> 2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td> å…¥ç«™</td>
<td> 10250</td>
<td>Kubelet API</td>
<td>kubelet è‡ªèº«ã€æ§åˆ¶å¹³é¢ç»„ä»¶</td>
</tr>
<tr>
<td> TCP</td>
<td> å…¥ç«™</td>
<td> 10251</td>
<td>kube-scheduler</td>
<td>kube-scheduler è‡ªèº«</td>
</tr>
<tr>
<td> TCP</td>
<td> å…¥ç«™</td>
<td> 10252</td>
<td>kube-controller-manager</td>
<td>kube-controller-manager è‡ªèº« </td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># firewall-cmd --permanent --add-port=6443/tcp</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># firewall-cmd --permanent --add-port=64430-64439/tcp</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># firewall-cmd --permanent --add-port=2379-2380/tcp</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># firewall-cmd --permanent --add-port=10250-10252/tcp</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># firewall-cmd --reload</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>æ‰€æœ‰ node å·¥ä½œèŠ‚ç‚¹</strong></p>
<table>
<thead>
<tr>
<th>åè®®</th>
<th>æ–¹å‘</th>
<th>ç«¯å£èŒƒå›´</th>
<th>ä½œç”¨</th>
<th>ä½¿ç”¨è€…</th>
</tr>
</thead>
<tbody>
<tr>
<td> TCP</td>
<td> å…¥ç«™</td>
<td> 10250</td>
<td>Kubelet API</td>
<td>kubelet è‡ªèº«ã€æ§åˆ¶å¹³é¢ç»„ä»¶</td>
</tr>
<tr>
<td> TCP</td>
<td> å…¥ç«™</td>
<td> 30000-32767</td>
<td>NodePort æœåŠ¡ **</td>
<td> æ‰€æœ‰ç»„ä»¶ </td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># firewall-cmd --permanent --add-port=10250/tcp</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># firewall-cmd --permanent --add-port=30000-32767/tcp</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># firewall-cmd --reload</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="éªŒè¯èŠ‚ç‚¹UUID"><a href="#éªŒè¯èŠ‚ç‚¹UUID" class="headerlink" title="éªŒè¯èŠ‚ç‚¹UUID"></a>éªŒè¯èŠ‚ç‚¹ UUID</h3><p>æŸ¥çœ‹æ¯ä¸ªæœåŠ¡å™¨çš„ uuidï¼Œå¿…é¡»ä¸èƒ½é‡å¤</p>
<p><strong>k8s-master</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># cat /sys/class/dmi/id/product_uuid</span></span><br><span class="line">E2B74D56-23A9-4E8B-620C-555387355616</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å…³é—­swapåˆ†åŒº"><a href="#å…³é—­swapåˆ†åŒº" class="headerlink" title="å…³é—­swapåˆ†åŒº"></a>å…³é—­ swap åˆ†åŒº</h3><p>ä¸‰å°èŠ‚ç‚¹åŒæ ·çš„æ“ä½œ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># swapoff -a</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim /etc/fstab</span></span><br><span class="line"><span class="comment"># å°†åˆ†åŒºç±»å‹ä¸ºswapçš„ä¸€è¡Œæ³¨é‡Šæ‰</span></span><br><span class="line">/dev/mapper/centos-swap swap</span><br><span class="line"><span class="comment"># è¿˜æ˜¯éœ€è¦è°ƒæ•´å†…æ ¸å‚æ•°</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># æœ«å°¾æ·»åŠ </span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">[root@k8s-master ~]<span class="comment"># sysctl -p</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="è®¾ç½®å†…æ ¸å‚æ•°"><a href="#è®¾ç½®å†…æ ¸å‚æ•°" class="headerlink" title="è®¾ç½®å†…æ ¸å‚æ•°"></a>è®¾ç½®å†…æ ¸å‚æ•°</h3><p>è°ƒæ•´ iptables æ¡¥æ¥æµé‡ï¼Œä¾èµ–äº docker çš„å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦ç¡®ä¿ docker å·²ç»å¯åŠ¨</p>
<p><strong>k8s-master</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># æœ«å°¾æ·»åŠ </span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">[root@k8s-master ~]<span class="comment"># sysctl -p</span></span><br><span class="line"><span class="comment"># ä¸ºç¡®ä¿æ¡¥æ¥æµé‡ä¸æŠ¥é”™ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># modprobe ip_vs_rr</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># modprobe br_netfilter</span></span><br><span class="line"><span class="comment"># å°†ä¿®æ”¹å¥½çš„æ–‡ä»¶ä¼ è¾“åˆ°node1å’Œnode2</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /etc/sysctl.conf root@k8s-node1:/etc</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /etc/sysctl.conf root@k8s-node2:/etc</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>k8s-node1</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># sysctl -p</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># modprobe ip_vs_rr</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># modprobe br_netfilter</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>k8s-node2</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-node2 ~]<span class="comment"># sysctl -p</span></span><br><span class="line">[root@k8s-node2 ~]<span class="comment"># modprobe ip_vs_rr</span></span><br><span class="line">[root@k8s-node2 ~]<span class="comment"># modprobe br_netfilter</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å®‰è£…Kubernetes"><a href="#å®‰è£…Kubernetes" class="headerlink" title="å®‰è£…Kubernetes"></a>å®‰è£… Kubernetes</h2><h3 id="ç¼–å†™yumæº"><a href="#ç¼–å†™yumæº" class="headerlink" title="ç¼–å†™yumæº"></a>ç¼–å†™ yum æº</h3><p><strong>k8s-master</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></tbody></table></figure>
<p>å°† yum æºä¼ ç»™æ¯å°èŠ‚ç‚¹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># scp /etc/yum.repos.d/kubernetes.repo root@k8s-node1:/etc/yum.repos.d/</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /etc/yum.repos.d/kubernetes.repo root@k8s-node2:/etc/yum.repos.d/</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å®‰è£…k8s"><a href="#å®‰è£…k8s" class="headerlink" title="å®‰è£…k8s"></a>å®‰è£… k8s</h3><p><strong>k8s-master/node1/node2</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># yum -y install kubelet kubeadm kubectl</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæœ‰çš„èŠ‚ç‚¹åœ¨ yum å®‰è£…æ—¶ï¼ŒæŠ¥é”™ 404ï¼Œå°è¯•æ‰§è¡Œ <code>rm -rf /var/cache/yum/*</code> åï¼Œé‡æ–°å®‰è£…</p>
<p>æŸ¥çœ‹ k8s ç‰ˆæœ¬</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubeadm version</span></span><br><span class="line">kubeadm version: &amp;version.Info{Major:<span class="string">"1"</span>, Minor:<span class="string">"18"</span>, GitVersion:<span class="string">"v1.18.2"</span>,</span><br><span class="line">GitCommit:<span class="string">"52c56ce7a8272c798dbc29846288d7cd9fbae032"</span>, GitTreeState:<span class="string">"clean"</span>,</span><br><span class="line">BuildDate:<span class="string">"2020-04-16T11:54:15Z"</span>, GoVersion:<span class="string">"go1.13.9"</span>, Compiler:<span class="string">"gc"</span>,</span><br><span class="line">Platform:<span class="string">"linux/amd64"</span>}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>k8s-master</strong></p>
<p>å®‰è£… kubernetes çš„ tab å¿«æ·é”®ï¼Œåªéœ€è¦åœ¨ master å®‰è£…å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># yum -y install bash-completion</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc &amp;&amp; bash</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¯åŠ¨k8s"><a href="#å¯åŠ¨k8s" class="headerlink" title="å¯åŠ¨k8s"></a>å¯åŠ¨ k8s</h3><p><strong>k8s-master/node1/node2</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># systemctl enable --now kubelet</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Kubernetesé›†ç¾¤æ­å»º"><a href="#Kubernetesé›†ç¾¤æ­å»º" class="headerlink" title="Kubernetesé›†ç¾¤æ­å»º"></a>Kubernetes é›†ç¾¤æ­å»º</h2><p><strong>k8s-master</strong></p>
<p>åˆå§‹åŒ–é›†ç¾¤ï¼Œå®Œæˆåè·å– token å€¼</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubeadm init --apiserver-advertise-address 192.168.1.11 \</span></span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">--kubernetes-version v1.18.2 --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨ç®¡ç†ç”¨æˆ·ï¼ˆé rootï¼‰æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># mkdir -p $HOME/.kube</span></span><br><span class="line">[admin@k8s-master ~]$ sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">[admin@k8s-master ~]$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># echo "export KUBECONFIG=/etc/kubernetes/admin.conf" &gt;&gt; ~/.bashrc &amp;&amp; source ~/.bashrc</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="éƒ¨ç½²é›†ç¾¤ç½‘ç»œ"><a href="#éƒ¨ç½²é›†ç¾¤ç½‘ç»œ" class="headerlink" title="éƒ¨ç½²é›†ç¾¤ç½‘ç»œ"></a>éƒ¨ç½²é›†ç¾¤ç½‘ç»œ</h3><p>ä¸‹è½½ flannel ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œæœ‰æ—¶å€™ä¼šä¸‹è½½å¤±è´¥ï¼Œå‰å¾€ <a href="https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml" target="_blank" rel="noopener">coreos/flannel é¡¹ç›®</a>æ‰‹åŠ¨å°†å†…å®¹å¤åˆ¶åˆ° <code>kube-flannel.yml</code> æ–‡ä»¶ä¸­</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># curl -LO https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line"><span class="comment"># å°†quay.ioæ”¹ä¸ºå›½å†…quay-mirror.qiniu.com</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># sed -i s/quay.io/quay-mirror.qiniu.com/g kube-flannel.yml</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åæ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f kube-flannel.yml</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#èŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="headerlink" title="èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"></a>èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h3><p>å¦‚æœä¹‹å‰ç”Ÿæˆçš„ token å€¼å¿˜äº†ï¼ŒæŸ¥çœ‹ <code>kubeadm token list</code>ï¼Œè¿˜èƒ½å¾€ä¸Šç¿»çœ‹åˆ° token å€¼å°±è·³è¿‡è¿™æ­¥</p>
<p><strong>k8s-master</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubeadm token list</span></span><br><span class="line">TOKEN                     TTL         EXPIRES                     USAGES</span><br><span class="line">jppmrh.1hovp0cyt4xu2w1l   23h         2020-05-11T02:05:53+08:00   authentication,signing</span><br><span class="line"><span class="comment"># å°†å®ƒåˆ é™¤é‡æ–°ç”Ÿæˆ</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubeadm token delete jppmrh.1hovp0cyt4xu2w1l</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæ‰¾ä¸åˆ°äº†ï¼Œé‡æ–°ç”Ÿæˆ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubeadm token create --print-join-command</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>k8s-node1/node2</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># kubeadm join 192.168.1.11:6443 --token bdsiop.8ptt7ky6t088xyl8 \</span></span><br><span class="line">    --discovery-token-ca-cert-hash sha256:1b61fd611bd12f46c7c065995f304ad232f2a598cb99127ccc547612ea57eac0</span><br></pre></td></tr></tbody></table></figure>
<p>è¾“å‡ºä¿¡æ¯ä¸ºä»¥ä¸‹åˆ™æˆåŠŸ</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</span><br></pre></td></tr></tbody></table></figure>
<h3 id="éªŒè¯é›†ç¾¤èŠ‚ç‚¹"><a href="#éªŒè¯é›†ç¾¤èŠ‚ç‚¹" class="headerlink" title="éªŒè¯é›†ç¾¤èŠ‚ç‚¹"></a>éªŒè¯é›†ç¾¤èŠ‚ç‚¹</h3><p><strong>k8s-master</strong></p>
<p>ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç›´è‡³çŠ¶æ€å…¨éƒ¨ä¸º Ready</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-master   Ready    master   10m     v1.18.2</span><br><span class="line">k8s-node1    Ready    &lt;none&gt;   3m56s   v1.18.2</span><br><span class="line">k8s-node2    Ready    &lt;none&gt;   3m56s   v1.18.2</span><br></pre></td></tr></tbody></table></figure>
<p>é›†ç¾¤æ­å»ºæˆåŠŸ</p>
<h1 id="è¿è¡ŒDockerç§åº“â€”Registry"><a href="#è¿è¡ŒDockerç§åº“â€”Registry" class="headerlink" title="è¿è¡ŒDockerç§åº“â€”Registry"></a>è¿è¡Œ Docker ç§åº“ â€”Registry</h1><p>ä¸ºäº†åœ¨ç¯å¢ƒä¸­æ›´å¥½çš„ç®¡ç† Docker é•œåƒï¼Œå†³å®šä½¿ç”¨ Registry æ¥è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œç”¨æ¥å­˜æ”¾ docker é•œåƒï¼Œä¹Ÿå‡å°‘äº†é•œåƒå­˜å‚¨åœ¨å›½å¤–æºæˆ–è€…å›½å†…æºçš„ä¼ è¾“æ•ˆç‡ï¼Œå½“ç„¶ä¹Ÿèƒ½ä½¿ç”¨ harbor ç§åº“ä»£æ›¿ Registry</p>
<p><strong>k8s-master</strong></p>
<p>åˆ›å»ºé•œåƒå­˜æ”¾ç›®å½•</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># mkdir -p /data/docker/registry</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¸‹è½½é•œåƒ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># docker pull registry:2</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿è¡Œç§åº“å®¹å™¨</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># docker run -itd -p 5000:5000 --restart always \</span></span><br><span class="line">--volume /data/docker/registry/:/var/lib/registry registry:2</span><br></pre></td></tr></tbody></table></figure>
<p>æŸ¥çœ‹ç«¯å£æ˜¯å¦æ˜ å°„æˆåŠŸ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># netstat -anput | grep 5000</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ£€æŸ¥èƒ½å¦è®¿é—®åˆ°ç§åº“</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># firewall-cmd --permanent --add-port=5000/tcp</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># firewall-cmd --reload</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># curl 192.168.1.11:5000/v2/_catalog</span></span><br><span class="line">{<span class="string">"repositories"</span>:[]}</span><br></pre></td></tr></tbody></table></figure>
<p>è®¾ç½®ä¸‰å° docker éƒ½èƒ½è¯†åˆ«ç§åº“åœ°å€</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /usr/lib/systemd/system/docker.service</span></span><br><span class="line"><span class="comment"># ä»¥ExecStartå¼€å¤´çš„ä¸€è¡Œçš„æœ«å°¾æ·»åŠ --insecure-registry 192.168.1.11:5000</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /usr/lib/systemd/system/docker.service root@k8s-node1:/usr/lib/systemd/system/</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /usr/lib/systemd/system/docker.service root@k8s-node2:/usr/lib/systemd/system/</span></span><br></pre></td></tr></tbody></table></figure>
<p>å…¨éƒ¨é‡å¯ docker</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># systemctl daemon-reload &amp;&amp; systemctl restart docker</span></span><br></pre></td></tr></tbody></table></figure>
<p>åˆ¶ä½œä¸€ä¸ªé•œåƒä¸Šä¼ åˆ°ç§åº“æµ‹è¯•</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># wget http://nginx.org/download/nginx-1.11.1.tar.gz</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim Dockerfile</span></span><br><span class="line">FROM centos</span><br><span class="line">MAINTAINER FeiYi</span><br><span class="line">RUN yum -y install net-tools iproute pcre-devel openssl-devel gcc gcc-c++ make zlib-devel elinks</span><br><span class="line">ADD nginx-1.11.1.tar.gz /usr/src</span><br><span class="line">ENV NGINX_DIR /usr/src/nginx-1.11.1</span><br><span class="line">WORKDIR <span class="variable">$NGINX_DIR</span></span><br><span class="line">RUN ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --user=nginx --group=nginx &amp;&amp; make &amp;&amp; make install</span><br><span class="line">WORKDIR /</span><br><span class="line">RUN useradd nginx</span><br><span class="line">RUN ln -s /usr/<span class="built_in">local</span>/nginx/sbin/nginx /usr/sbin/nginx</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [<span class="string">"nginx"</span>, <span class="string">"-g"</span>, <span class="string">"daemon off;"</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>æ„å»ºé•œåƒ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># docker build -t 192.168.1.11:5000/bin-nginx:latest /root</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¸Šä¼ é•œåƒ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># docker push 192.168.1.11:5000/bin-nginx</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># curl 192.168.1.11:5000/v2/_catalog</span></span><br><span class="line">{<span class="string">"repositories"</span>:[<span class="string">"bin-nginx"</span>]}</span><br></pre></td></tr></tbody></table></figure>
<p>ç§åº“æˆåŠŸ</p>
<h1 id="ä½¿ç”¨k8så¯åŠ¨nginxå®¹å™¨"><a href="#ä½¿ç”¨k8så¯åŠ¨nginxå®¹å™¨" class="headerlink" title="ä½¿ç”¨k8så¯åŠ¨nginxå®¹å™¨"></a>ä½¿ç”¨ k8s å¯åŠ¨ nginx å®¹å™¨</h1><p><strong>k8s-master</strong></p>
<h2 id="ç¼–å†™Deploymentçš„æ¨¡æ¿æ–‡ä»¶"><a href="#ç¼–å†™Deploymentçš„æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="ç¼–å†™Deploymentçš„æ¨¡æ¿æ–‡ä»¶"></a>ç¼–å†™ Deployment çš„æ¨¡æ¿æ–‡ä»¶</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># vim nginx-deployment.yml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: 192.168.1.11:5000/bin-nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></tbody></table></figure>
<p>è¿è¡Œæ¨¡æ¿æ–‡ä»¶</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># kubectl apply -f nginx-deployment.yml</span></span><br><span class="line">deployment.apps/nginx created</span><br></pre></td></tr></tbody></table></figure>
<p>æŸ¥çœ‹æ˜¯å¦è¿è¡ŒæˆåŠŸ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE    IP           NODE</span><br><span class="line">nginx-66fb94d868-h2fkk   1/1     Running   0          2m5s   10.244.2.2   node2</span><br><span class="line">nginx-66fb94d868-zhkf8   1/1     Running   0          2m5s   10.244.1.2   node3</span><br></pre></td></tr></tbody></table></figure>
<p>å¯ä»¥çœ‹åˆ°å®¹å™¨çš„ ipï¼Œç°åœ¨åªèƒ½åœ¨è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹æ‰èƒ½å¤Ÿè®¿é—®åˆ°é¡µé¢å†…å®¹ï¼Œå¦‚æœæƒ³è®©å¤–éƒ¨ä¸»æœºè®¿é—®åˆ°ï¼Œéœ€è¦åšä¸€ä¸ª service æ¨¡æ¿ï¼Œç”¨æ¥æ˜ å°„ç«¯å£</p>
<h2 id="ç¼–å†™Serviceæ¨¡æ¿"><a href="#ç¼–å†™Serviceæ¨¡æ¿" class="headerlink" title="ç¼–å†™Serviceæ¨¡æ¿"></a>ç¼–å†™ Service æ¨¡æ¿</h2><p>å°†é›†ç¾¤ä¸­æ ‡ç­¾ä¸º app: nginx çš„å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„ä¸ºæœåŠ¡å™¨çš„ 30001</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># vim nginx-service.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    nodePort: 30001</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br></pre></td></tr></tbody></table></figure>
<p>è¿è¡Œ Service æ¨¡æ¿</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># kubectl apply -f nginx-service.yml</span></span><br><span class="line">service/nginx created</span><br></pre></td></tr></tbody></table></figure>
<p>è®¿é—®å®¿ä¸»æœºçš„ 30001 ç«¯å£</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">http://192.168.1.12:30001`å’Œ`http://192.168.1.13:30001</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_nginx.png" alt="k8s_nginx"></p>
<p>å®¹å™¨éƒ¨ç½²æˆåŠŸ</p>
<h1 id="æ•´åˆGitLabå’ŒJenkins"><a href="#æ•´åˆGitLabå’ŒJenkins" class="headerlink" title="æ•´åˆGitLabå’ŒJenkins"></a>æ•´åˆ GitLab å’Œ Jenkins</h1><p><strong>Jenkins</strong></p>
<p>åœ¨ Jenkins ç”Ÿæˆå¯†é’¥å¯¹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Created directory <span class="string">'/root/.ssh'</span>.</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:IITvkptc3nJrgxCxA0R0+ExWm5y/PfSIdKaQpD0NhUc root@jenkins</span><br><span class="line">The key<span class="string">'s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|++.oo.oE         |</span></span><br><span class="line"><span class="string">|..++..=.         |</span></span><br><span class="line"><span class="string">| .=+.Bo          |</span></span><br><span class="line"><span class="string">|  +o=.=.         |</span></span><br><span class="line"><span class="string">|   * = +S+       |</span></span><br><span class="line"><span class="string">|  + o + O o      |</span></span><br><span class="line"><span class="string">| . B o + + .     |</span></span><br><span class="line"><span class="string">|  + + =   .      |</span></span><br><span class="line"><span class="string">|     +.o         |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>GitLab</strong></p>
<p>ç™»å½• GitLab</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">http://192.168.1.1</span><br></pre></td></tr></tbody></table></figure>
<p>åˆ›å»ºé¡¹ç›®ä»“åº“</p>
<p><img src="https://jf.ssjinyao.com/uploads/admin_create_project.png" alt="gitlab"></p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_gitlab.png" alt="k8s_gitlab"></p>
<p>åœ¨ GitLab ä¸­æ·»åŠ  Jenkins çš„å…¬é’¥å€¼</p>
<p><img src="https://jf.ssjinyao.com/uploads/add_id_rsa_pub.png" alt="gitlab"></p>
<p>å¤åˆ¶ Jenkins æœåŠ¡å™¨çš„å…¬é’¥åˆ°ä¸‹å›¾ä½ç½®ï¼ŒæŸ¥çœ‹å…¬é’¥ <code>cat .ssh/id_rsa.pub</code></p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_gitlab1.png" alt="k8s_gitlab1"></p>
<p>åœ¨ GitLab çš„é¡¹ç›®ä»“åº“ï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•ä»£ç æ–‡ä»¶</p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_gitlab2.png" alt="k8s_gitlab2"></p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_gitlab3.png" alt="k8s_gitlab3"></p>
<p>å› ä¸ºå¯†é’¥ä¸Šä¼ çš„æ˜¯ Jenkins çš„ï¼Œæ‰€ä»¥åœ¨ Jenkins ä¸Šä¸‹è½½æŸ¥çœ‹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># git clone http://192.168.1.1/root/nginx-test.git</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># cd nginx-test/</span></span><br><span class="line">[root@jenkins nginx-test]<span class="comment"># cat index.html</span></span><br><span class="line">ChaiYanjiang</span><br></pre></td></tr></tbody></table></figure>
<p>æˆåŠŸ</p>
<p><strong>Jenkins</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">http://192.168.1.4:8080/</span><br></pre></td></tr></tbody></table></figure>
<p>åˆ›å»ºä»»åŠ¡ nginx-test</p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_jenkins.png" alt="k8s_jenkins"></p>
<p>è®¾ç½®æºç ç®¡ç†æ—¶åœ¨ Gitlab çš„åœ°å€ï¼Œå‡ºç°çº¢è‰²è¯´æ˜è¿æ¥ä¸åˆ°ï¼Œå› ä¸º GitLab å·²ç»æœ‰äº† Jenkins çš„å…¬é’¥ï¼Œè¿™é‡Œåªéœ€è¦å¡«å†™ Jenkins çš„ç§é’¥å³å¯</p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_jenkins2.png" alt="k8s_jenkins2"></p>
<p><img src="https://www.feiyiblog.com/uploads/create_con_gitlab.png" alt="Jenkins"></p>
<p>çº¢è‰²æŠ¥é”™æ¶ˆå¤±äº†</p>
<p><img src="https://www.feiyiblog.com/uploads/choose_pingzheng_gitlab.png" alt="Jenkins"></p>
<p>è®¾ç½®æ„å»ºè§¦å‘å™¨</p>
<p>å½“ gitlab å‘ç”Ÿä»£ç å˜åŒ–æ—¶ï¼Œå¼€å§‹è¿›è¡Œæ„å»ºä»»åŠ¡</p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_jenkins3.png" alt="k8s_jenkins3"></p>
<p>ç”Ÿæˆä¸€ä¸² token å€¼ï¼Œç”¨æ¥å¯¹ GitLab ä¸­çš„é¡¹ç›®ä»£ç è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™ä¸ªå€¼è¦æ”¾åˆ° GitLab ä¸­ï¼Œç”¨äºéªŒè¯å…è®¸ Jenkins æ¥æ‹¿å–ä»£ç ï¼Œç¨åä¼šå°†</p>
<p><img src="https://www.feiyiblog.com/uploads/sheng_token.png" alt="k8s_build"></p>
<p>è®¾ç½®æ„å»ºçš„å‘½ä»¤ï¼ˆCI/CDï¼‰</p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_build.png" alt="k8s_build"></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">backupcode=/data/backupcode/<span class="variable">$JOB_NAME</span>/</span><br><span class="line">mkdir -p <span class="variable">$backupcode</span></span><br><span class="line">chmod 644 <span class="variable">$JENKINS_HOME</span>/workspace/<span class="variable">$JOB_NAME</span>/*</span><br><span class="line">rsync -acP <span class="variable">$JENKINS_HOME</span>/workspace/<span class="variable">$JOB_NAME</span>/* <span class="variable">$backupcode</span></span><br><span class="line"><span class="built_in">echo</span> From 192.168.1.11:5000/bin-nginx &gt; <span class="variable">$JENKINS_HOME</span>/workspace/Dockerfile</span><br><span class="line"><span class="built_in">echo</span> COPY ./nginx-test/* /usr/<span class="built_in">local</span>/nginx/html/ &gt;&gt; <span class="variable">$JENKINS_HOME</span>/workspace/Dockerfile</span><br><span class="line">docker rmi 192.168.1.11:5000/bin-nginx:latest</span><br><span class="line">docker build -t 192.168.1.11:5000/bin-nginx:latest <span class="variable">$JENKINS_HOME</span>/workspace/</span><br><span class="line">docker push 192.168.1.11:5000/bin-nginx:latest</span><br><span class="line">ssh root@k8s-master kubectl delete deployment nginx</span><br><span class="line">ssh root@k8s-master kubectl apply -f nginx-deployment.yml</span><br></pre></td></tr></tbody></table></figure>
<p>ä¿å­˜å³å¯</p>
<p><strong>GitLab</strong></p>
<p>192.168.1.1 ä¸­è®¾ç½® Jenkins ä¸­çš„ token å€¼ï¼Œç”¨æ¥è§¦å‘ Jenkins æ„å»º</p>
<p>GitLab é»˜è®¤æƒ…å†µä¸‹ä¸å…è®¸é€šè¿‡æœ¬åœ°ç½‘ç»œè§¦å‘æ„å»ºï¼Œä»¥ä¸‹è¿™æ­¥æ˜¯ä¸ºäº†è®¾ç½®å…è®¸æœ¬åœ°ç½‘ç»œæ„å»ºï¼Œå¦‚æœä¸è®¾ç½®å…è®¸ä¼šåœ¨æ·»åŠ  token æ—¶æŠ¥é”™</p>
<p><img src="https://www.feiyiblog.com/uploads/admin_settings_integrations.png" alt="GitLab"></p>
<p><img src="https://www.feiyiblog.com/uploads/outbound_requests.png" alt="GitLab"></p>
<p><img src="https://www.feiyiblog.com/uploads/allow_webhooks.png" alt="GitLab"></p>
<p>ä¿å­˜</p>
<p>è®¾ç½®å…è®¸ä¹‹åï¼Œå°±å¯ä»¥è®¾ç½® GitLab é¡¹ç›®ä¸ Jenkins çš„æ„å»ºè§¦å‘å™¨è¿æ¥äº†</p>
<p><strong>è¿›å…¥é¡¹ç›®</strong>ä¸­é€‰æ‹©è®¾ç½®</p>
<p><img src="https://www.feiyiblog.com/uploads/cd_reops_settings.png" alt="gitlab"></p>
<p>å›¾ä¸­çš„ URL æ˜¯åœ¨ Jenkins ä¸­çš„é¡¹ç›®è·¯å¾„ï¼Œè¿™ä¸ªè·¯å¾„åœ¨æ„å»ºè§¦å‘å™¨çš„é‚£é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå¤åˆ¶å³å¯ï¼Œtoken åˆ™æ˜¯åˆšæ‰åœ¨ Jenkins çš„ç®¡ç†ç•Œé¢ä¸­ç”Ÿæˆçš„ token å€¼ï¼Œä¹Ÿæ˜¯åŒæ ·çš„ä½ç½®ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹ <code>add webhook</code></p>
<p><img src="https://jf.ssjinyao.com/uploads/gitlab_token.png" alt="gitlab_token"></p>
<p>add æˆåŠŸåï¼Œå¾€ä¸‹ç¿»åˆ°å¦‚å›¾æ‰€ç¤ºä½ç½®å¯ä»¥çœ‹æ·»åŠ æˆåŠŸçš„ URLï¼Œç„¶åè¿›è¡Œè¿æ¥æµ‹è¯•ï¼Œå‡ºç° 200 å³æˆåŠŸ</p>
<p><img src="https://jf.ssjinyao.com/uploads/gitlab_webhooktest.png" alt="gitlab_webhooktest"></p>
<h1 id="æ•´åˆJenkinså’ŒDocker"><a href="#æ•´åˆJenkinså’ŒDocker" class="headerlink" title="æ•´åˆJenkinså’ŒDocker"></a>æ•´åˆ Jenkins å’Œ Docker</h1><p><strong>Jenkins</strong></p>
<p>åœ¨ Jenkins ä¸­åšå¯¹ k8s-master çš„å…å¯†ç™»å½•ï¼Œå¾—å…ˆä¿®æ”¹ Jenkins çš„è¿è¡Œç”¨æˆ·ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç”¨ root ä»£æ›¿ï¼Œç”Ÿäº§ç¯å¢ƒè¯·å‚è€ƒè¿™é‡Œçš„ <a href="https://www.feiyiblog.com/2020/03/12/GitLab-Jenkins-Tomcat/" target="_blank" rel="noopener">scp æŠ¥é”™éƒ¨åˆ†</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># vim /etc/sysconfig/jenkins</span></span><br><span class="line"> ä¿®æ”¹jenkinsç”¨æˆ·</span><br><span class="line">JENKINS_USER=<span class="string">"jenkins"</span>   <span class="comment"># ä¿®æ”¹ä¸ºroot</span></span><br></pre></td></tr></tbody></table></figure>
<p>é‡å¯ Jenkins å¹¶ä¼ è¾“å¯†é’¥</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># systemctl restart jenkins</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># ssh-copy-id -i root@k8s-master</span></span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£… Dockerï¼Œå‚è€ƒæ–‡æ¡£ <a href="https://www.feiyiblog.com/2020/03/23/å®‰è£…Dockerâ€”â€”é•œåƒåŠ é€Ÿ/" target="_blank" rel="noopener">Docker å®‰è£…</a>ï¼Œå¹¶è®¾ç½®é•œåƒåŠ é€Ÿï¼Œå’ŒæŒ‡å®šç§åº“åœ°å€</p>
<h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>ä¿®æ”¹ GitLab çš„æµ‹è¯•æ–‡ä»¶æµ‹è¯• Jenkins çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æ˜¯å¦æˆåŠŸ</p>
<p><img src="https://jf.ssjinyao.com/uploads/gitlab_test.png" alt="gitlab_test"></p>
<p>ä¿å­˜åä¼šå¼€å§‹è‡ªåŠ¨æ„å»ºéƒ¨ç½²ï¼Œè®¿é—® <code>192.168.1.13:30001</code>ï¼Œå¦‚æœæ˜¯ä»¥ä¸‹åˆ™æˆåŠŸï¼Œå¦‚æœæ„å»ºå¤±è´¥ï¼Œåˆ™æ£€æŸ¥æ„å»ºè„šæœ¬ï¼Œæ…¢æ…¢æ’é”™</p>
<p><img src="https://jf.ssjinyao.com/uploads/k8s_cicd.png" alt="k8s_cicd"></p>
<hr>
]]></content>
      <categories>
        <category>éƒ¨ç½²</category>
      </categories>
      <tags>
        <tag>GitLab</tag>
        <tag>Jenkins</tag>
        <tag>K8S</tag>
      </tags>
  </entry>
  <entry>
    <title>Gogs æ— æ³•è¯»å–è¿œç¨‹ä»“åº“ï¼ˆfatal: XX/XX.git does not appear to be a git repositoryï¼‰</title>
    <url>/2018/09/21/Gogs%E6%97%A0%E6%B3%95%E8%AF%BB%E5%8F%96%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%EF%BC%88fatal-XX-XX-git-does-not-appear-to-be-a-git-repository%EF%BC%89/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>é”™è¯¯æè¿°ï¼š<code>fatal: 'XX/XX.git' does not appear to be a git repository</code></p>
</blockquote>
<h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><p>éƒ¨ç½²å®Œ Gogs åï¼Œåœ¨ Web é¡µé¢åˆ›å»ºå¥½ä»“åº“åï¼Œæœ¬åœ°å‘è¿œç¨‹æ¨é€å‡ºç°<code>æ— æ³•è¯»å–è¿œç¨‹ä»“åº“</code>çš„é—®é¢˜ï¼Œå¯èƒ½åŸå› ï¼š<code>~/.ssh/authorized_keys</code> æ–‡ä»¶ä¸­å­˜åœ¨é‡å¤çš„ SSH å¯†é’¥ï¼Œæ‰€ä»¥<a href="https://gogs.io/docs/intro/troubleshooting#%E5%85%AC%E9%92%A5%E4%BD%BF%E7%94%A8%E5%86%B2%E7%AA%81" target="_blank" rel="noopener">å…¬é’¥ä½¿ç”¨å†²çª</a>äº†</p>
<a id="more"></a>
<h1 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h1><p>åˆ é™¤ <code>~/.ssh/authorized_keys</code> æ–‡ä»¶é‡Œé™¤äº†å±äº Gogs è‡ªåŠ¨æ·»åŠ ä»¥å¤–çš„é‡å¤å¯†é’¥ï¼Œè¿™æ ·å°±å¯ä»¥æ­£å¸¸äº†</p>
<h1 id="æ–°çš„é—®é¢˜"><a href="#æ–°çš„é—®é¢˜" class="headerlink" title="æ–°çš„é—®é¢˜"></a>æ–°çš„é—®é¢˜</h1><p>ä½†æ˜¯è¿™æ ·åˆå‡ºç°äº†ä¸ªæ–°çš„é—®é¢˜ï¼Œå°±æ˜¯æˆ‘ç”¨ <code>ssh</code> ç™»ä¸ä¸Šæˆ‘çš„è¿œç¨‹æœåŠ¡å™¨äº†ï¼ŒåŸæ¥åˆšåˆšåˆ é™¤çš„é‚£ä¸ªç§˜é’¥æ˜¯ <code>ssh</code> è¿œç¨‹ç™»å½•å¯†é’¥ï¼Œè¿™æ ·å¯ä¸è¡Œçš„å‘€</p>
<h1 id="æ–°çš„æ–¹æ¡ˆ"><a href="#æ–°çš„æ–¹æ¡ˆ" class="headerlink" title="æ–°çš„æ–¹æ¡ˆ"></a>æ–°çš„æ–¹æ¡ˆ</h1><p>é¢å¤–å†ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†é’¥ <code>id_rsa_gogs</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">'é‚®ç®±æˆ–è€…å…¶ä»–æ ‡è¯†'</span> -f ~/.ssh/id_rsa_gogs</span><br></pre></td></tr></tbody></table></figure>
<p>å†åœ¨æœ¬åœ°æ–°å»ºï¼ˆå¦‚æœå­˜åœ¨å°±ä¿®æ”¹ï¼‰<code>~/.ssh/config</code> æ·»åŠ ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Host gogs</span><br><span class="line">    HostName example.com <span class="comment"># IPåœ°å€æˆ–è€…åŸŸå</span></span><br><span class="line">    Port 222 <span class="comment"># sshç«¯å£å·</span></span><br><span class="line">    User git <span class="comment"># è¿œç¨‹æœåŠ¡å™¨çš„ç”¨æˆ·å</span></span><br><span class="line">    IdentityFile ~/.ssh/id_rsa_gogs <span class="comment"># åˆšæ‰ç”Ÿæˆçš„å¯†é’¥çš„è·¯å¾„</span></span><br><span class="line">    IdentitiesOnly Yes <span class="comment"># åªä½¿ç”¨è¿™é‡Œè®¾ç½®çš„key</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ <code>gogs</code> è¿™ä¸ªåˆ«åæ¥ä»£æ›¿ <code>user@host:222</code> äº†</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥å‰ä»“åº“åœ°å€ä¸º</span></span><br><span class="line">user@host:222/repositories-path/xxx.git</span><br><span class="line"><span class="comment"># æ”¹ä¸ºç°åœ¨çš„åœ°å€</span></span><br><span class="line">gogs:/repositories-path/xxx.git</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ ·å°± OK äº†ï¼Œçœ‹çœ‹<a href="https://discuss.gogs.io/t/how-to-config-ssh-settings/34" target="_blank" rel="noopener">å…¶ä»–æ–¹æ¡ˆ</a></p>
<hr>
]]></content>
      <categories>
        <category>Gogs</category>
      </categories>
      <tags>
        <tag>Gogs</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo çš„å®‰è£…é…ç½®ä»¥åŠéƒ¨ç½²</title>
    <url>/2018/09/17/Hexo%E7%9A%84%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>Hexo æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ </p>
</blockquote>
<h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><p>åœ¨æœ¬åœ°ä½¿ç”¨ hexo æ¡†æ¶ï¼Œéœ€è¦ç”µè„‘ä¸­å·²å®‰è£… <a href="http://git-scm.com" target="_blank" rel="noopener">Git</a>ã€<a href="http://nodejs.org" target="_blank" rel="noopener">Node.js</a></p>
<h2 id="å®‰è£…Git"><a href="#å®‰è£…Git" class="headerlink" title="å®‰è£…Git"></a>å®‰è£… Git</h2><ul>
<li>Windowsï¼šä¸‹è½½å¹¶å®‰è£… <a href="https://git-scm.com/download/win" target="_blank" rel="noopener">Git</a></li>
<li>Macï¼šä½¿ç”¨ <a href="https://brew.sh/index_zh-cn" target="_blank" rel="noopener">Homebrew</a> ï¼š<code>brew install git --with-gettext</code></li>
<li>Linux (Ubuntu, Debian)ï¼š<code>sudo apt-get install git-core</code></li>
<li>Linux (Fedora, Red Hat, CentOS)ï¼š<code>sudo yum install git-core</code></li>
</ul>
<a id="more"></a>
<h2 id="å®‰è£…Node-js"><a href="#å®‰è£…Node-js" class="headerlink" title="å®‰è£…Node.js"></a>å®‰è£… Node.js</h2><p>Node.js æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨ <a href="https://github.com/creationix/nvm" target="_blank" rel="noopener">nvm (Node Version Manager)</a> æ¥ç®¡ç† node çš„ç‰ˆæœ¬ã€‚å¯¹äº windows å°ä¼™ä¼´æ¥è¯´ï¼Œå»ºè®®<a href="https://nodejs.org/zh-cn/download/" target="_blank" rel="noopener">ä½¿ç”¨ Node.js å®‰è£…ç¨‹åº</a>è¿›è¡Œå®‰è£…ï¼Œå–œæ¬¢æŠ˜è…¾çš„å°ä¼™ä¼´å¯ä»¥è¯•è¯• <a href="https://github.com/coreybutler/nvm-windows" target="_blank" rel="noopener">nvm-windows</a></p>
<p>å®‰è£… Node.js</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">nvm install stable</span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨<a href="http://npm.taobao.org/mirrors/node" target="_blank" rel="noopener">æ·˜å®çš„ Node.js é•œåƒ</a><br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># nvm ä½¿ç”¨é•œåƒå®‰è£…</span></span><br><span class="line">NVM_NODEJS_ORG_MIRROR=https://npm.taobao.org/mirrors/node nvm install stable</span><br><span class="line"></span><br><span class="line"><span class="comment"># windowså°ä¼™ä¼´å¦‚æœä½¿ç”¨ nvm-windowsï¼Œè®¾ç½®é•œåƒ</span></span><br><span class="line">nvm node_mirror https://npm.taobao.org/mirrors/node/</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="å®‰è£…Hexo"><a href="#å®‰è£…Hexo" class="headerlink" title="å®‰è£…Hexo"></a>å®‰è£… Hexo</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></tbody></table></figure>
<p>å›½å†…å°ä¼™ä¼´å»ºè®®ä½¿ç”¨<a href="https://npm.taobao.org/" target="_blank" rel="noopener">æ·˜å® NPM é•œåƒ</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…cnpm</span></span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line"><span class="comment"># ä½¿ç”¨cnpmå®‰è£…hexo</span></span><br><span class="line">cnpm install -g hexo-cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># windowså°ä¼™ä¼´å¦‚æœä½¿ç”¨ nvm-windowsï¼Œè®¾ç½®npmé•œåƒ</span></span><br><span class="line">nvm npm_mirror https://npm.taobao.org/mirrors/npm/</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä½¿ç”¨hexo"><a href="#ä½¿ç”¨hexo" class="headerlink" title="ä½¿ç”¨hexo"></a>ä½¿ç”¨ hexo</h1><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># --no-install æ˜¯ä½¿ç”¨åˆå§‹åŒ–åè·³è¿‡npm install</span></span><br><span class="line">hexo init é¡¹ç›®æ–‡ä»¶å¤¹ --no-install</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥é¡¹ç›®ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> é¡¹ç›®æ–‡ä»¶å¤¹</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">cnpm install</span><br></pre></td></tr></tbody></table></figure>
<p>æŸ¥çœ‹ <code>hexo init</code> æ›´å¤šå¸®åŠ©<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">hexo init -h</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="æœ¬åœ°å¯åŠ¨"><a href="#æœ¬åœ°å¯åŠ¨" class="headerlink" title="æœ¬åœ°å¯åŠ¨"></a>æœ¬åœ°å¯åŠ¨</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># s æ˜¯ server</span></span><br><span class="line"></span><br><span class="line">hexo s</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åä¼šè¾“å‡ºä»¥ä¸‹ä¿¡æ¯</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">INFO  Start processing</span><br><span class="line">INFO  Hexo is running at http://localhost:4000 . Press Ctrl+C to stop.</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶ååœ¨å¯ä»¥æœ¬åœ°æµè§ˆå™¨æ‰“å¼€ <a href="http://localhost:4000ï¼Œå°±å¯ä»¥è®¿é—®å¯åŠ¨å¥½çš„åšå®¢å•¦" target="_blank" rel="noopener">http://localhost:4000ï¼Œå°±å¯ä»¥è®¿é—®å¯åŠ¨å¥½çš„åšå®¢å•¦</a></p>
<p>æŸ¥çœ‹ <code>hexo server</code> æ›´å¤šå¸®åŠ©ï¼Œä¹Ÿå¯å‚è€ƒ <a href="https://hexo.io/zh-cn/docs/server" target="_blank" rel="noopener">Hexo æœåŠ¡å™¨</a><br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">hexo s -h</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="å®‰è£…Nextä¸»é¢˜"><a href="#å®‰è£…Nextä¸»é¢˜" class="headerlink" title="å®‰è£…Nextä¸»é¢˜"></a>å®‰è£… Next ä¸»é¢˜</h2><p>æˆ‘ä½¿ç”¨çš„ <a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">Next</a> ä¸»é¢˜</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> é¡¹ç›®æ–‡ä»¶å¤¹</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></tbody></table></figure>
<p>å°†<code>é¡¹ç›®ç›®å½•</code>ä¸‹çš„<code>_config.yml</code> é…ç½®æ–‡ä»¶ä¸­çš„ <code>theme: landscape</code> æ”¹ä¸º <code>theme: next</code>, ç„¶åé‡å¯ Hexo æœ¬åœ°æœåŠ¡ï¼Œå³å¯åœ¨æœ¬åœ°çœ‹åˆ°æ–°çš„ä¸»é¢˜æ ·å¼</p>
<p>å¦‚æœæƒ³æ”¹ä¸ºå…¶ä»–ä¸»é¢˜ï¼Œè¯·å‰å¾€ <a href="https://hexo.io/themes/" target="_blank" rel="noopener">Hexo Themes</a>ï¼Œè‡ªè¡Œé€‰å–åï¼ŒæŒ‰ç…§è¯´æ˜æ–‡æ¡£è¦æ±‚è‡ªè¡Œä¿®æ”¹é…ç½®</p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>Hexo å¤§éƒ¨ä»½çš„çš„é…ç½®åœ¨<code>é¡¹ç›®ç›®å½•</code>ä¸‹çš„<code>_config.yml</code> ä¸­ï¼Œæ ¹æ® <a href="https://hexo.io/zh-cn/docs/configuration" target="_blank" rel="noopener">Hexo å®˜æ–¹æ–‡æ¡£</a>æŒ‰ç…§è‡ªå·±éœ€è¦æ”¹åŠ¨å³å¯</p>
<p>è‡ªå·±æƒ³ä¸ªæ€§åŒ–é…ç½®ï¼Œä¾‹å¦‚åœ¨æ–‡ç« åº•éƒ¨å¢åŠ ç‰ˆæƒä¿¡æ¯ï¼Œç½‘ç«™åº•éƒ¨å­—æ•°ç»Ÿè®¡ç­‰æ›´å¤šï¼Œå¯ä»¥å‚è€ƒ <a href="https://segmentfault.com/a/1190000009544924" target="_blank" rel="noopener">Hexo çš„ Next ä¸»é¢˜ä¸ªæ€§åŒ–é…ç½®æ•™ç¨‹</a>ï¼Œå½“ç„¶è¿™ä¸ªå‚è€ƒå¤§éƒ¨åˆ†éƒ½æ˜¯ <code>next 5.x</code> ç‰ˆæœ¬ï¼Œæ–°çš„ç‰ˆæœ¬è¿˜æ˜¯å»ºè®®å‚è€ƒ <a href="https://github.com/theme-next" target="_blank" rel="noopener">theme-next</a> ä¸­çš„é…ç½®</p>
<h2 id="å†™æ–‡ç« "><a href="#å†™æ–‡ç« " class="headerlink" title="å†™æ–‡ç« "></a>å†™æ–‡ç« </h2><p>åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ç« </p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">hexo new æ–‡ç« å</span><br></pre></td></tr></tbody></table></figure>
<p>æ›´å¤šè¯´æ˜ï¼Œå‚è€ƒ <a href="https://hexo.io/zh-cn/docs/writing" target="_blank" rel="noopener">Hexo å†™ä½œ</a></p>
<h1 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h1><h2 id="å®‰è£…hexo-deployer-git"><a href="#å®‰è£…hexo-deployer-git" class="headerlink" title="å®‰è£…hexo-deployer-git"></a>å®‰è£… <code>hexo-deployer-git</code></h2><p>é¦–å…ˆå®‰è£… <a href="https://github.com/hexojs/hexo-deployer-git" target="_blank" rel="noopener">hexo-deployer-git</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cnpm install hexo-deployer-git --save</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ›å»ºä»“åº“"><a href="#åˆ›å»ºä»“åº“" class="headerlink" title="åˆ›å»ºä»“åº“"></a>åˆ›å»ºä»“åº“</h2><p>ä¸‹é¢è¦ç”¨åˆ° git ä»“åº“ï¼Œåˆ›å»º github.io ä»“åº“</p>
<ol>
<li>ç‚¹å‡» <code>New repository</code></li>
<li>è¾“å…¥ <code>Repository name</code>ï¼Œå¿…éœ€ä¸º<code>ç”¨æˆ·å.github.io</code> æ ¼å¼</li>
<li>ç‚¹å‡»æŒ‰é’® <code>Create repository</code></li>
<li>è¿›å…¥ä»“åº“<code>ç”¨æˆ·å.github.io</code>ï¼Œç‚¹å‡» <code>Settings</code>ï¼Œæ‰¾åˆ° <code>GitHub Pages</code> æ¨¡å—</li>
<li>ç‚¹å‡» <code>Choose a theme</code> é€‰æ‹©ä¸€ä¸ªé¡µé¢ä¸»é¢˜</li>
<li>ç„¶åè¿™ä¸ªé™æ€èµ„æºå­˜æ”¾çš„è¿œç¨‹ä»“åº“åœ°å€å°±åˆ›å»ºäº†</li>
</ol>
<h2 id="æŒ‡å®šä»“åº“ä½ç½®"><a href="#æŒ‡å®šä»“åº“ä½ç½®" class="headerlink" title="æŒ‡å®šä»“åº“ä½ç½®"></a>æŒ‡å®šä»“åº“ä½ç½®</h2><p>ä¸‹é¢å°†ç”Ÿæˆå¥½çš„é™æ€èµ„æºæ¨åˆ°è¿œç¨‹ä»“åº“ï¼Œå…ˆä¿®æ”¹åšå®¢é¡¹ç›®ç›®å½•ä¸‹çš„<code>_config.yml</code></p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">ç”Ÿæˆå¥½çš„é™æ€èµ„æºå­˜æ”¾çš„è¿œç¨‹ä»“åº“åœ°å€</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">[åˆ†æ”¯åç§°]</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="éƒ¨ç½²-1"><a href="#éƒ¨ç½²-1" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>å…ˆç”Ÿæˆæ–‡ä»¶åï¼Œå†å°†é™æ€èµ„æºæäº¤åˆ°è¿œç¨‹ä»“åº“</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># d æ˜¯ deploy</span></span><br><span class="line"><span class="comment"># g æ˜¯ generate</span></span><br><span class="line"></span><br><span class="line">hexo g -d</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">hexo d -g</span><br></pre></td></tr></tbody></table></figure>
<p>ç­‰ä¸ªä¸€ä¼šå„¿åï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€ <code>https://ç”¨æˆ·å.github.io</code> å°±å¯ä»¥è®¿é—®åšå®¢ç½‘ç«™äº†</p>
<hr>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>éƒ¨ç½²</tag>
        <tag>é…ç½®</tag>
      </tags>
  </entry>
  <entry>
    <title>Jekyll çš„ç®€å•å®‰è£…é…ç½®ä»¥åŠéƒ¨ç½²</title>
    <url>/2018/09/18/Jekyll%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>Jekyll æ˜¯ä¸€ä¸ªç®€å•çš„åšå®¢å½¢æ€çš„é™æ€ç«™ç‚¹ç”Ÿäº§æœºå™¨ </p>
</blockquote>
<h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><p>åœ¨æœ¬åœ°ä½¿ç”¨ Jekyll æ¡†æ¶ï¼Œéœ€è¦ç”µè„‘ä¸­å·²å®‰è£… <a href="http://git-scm.com" target="_blank" rel="noopener">Git</a>ã€<a href="http://ruby-lang.org" target="_blank" rel="noopener">Ruby</a></p>
<h2 id="å®‰è£…Git"><a href="#å®‰è£…Git" class="headerlink" title="å®‰è£…Git"></a>å®‰è£… Git</h2><ul>
<li>Windowsï¼šä¸‹è½½å¹¶å®‰è£… <a href="https://git-scm.com/download/win" target="_blank" rel="noopener">Git</a></li>
<li>Macï¼šä½¿ç”¨ <a href="https://brew.sh/index_zh-cn" target="_blank" rel="noopener">Homebrew</a> ï¼š<code>brew install git --with-gettext</code></li>
<li>Linux (Ubuntu, Debian)ï¼š<code>sudo apt-get install git-core</code></li>
<li>Linux (Fedora, Red Hat, CentOS)ï¼š<code>sudo yum install git-core</code></li>
</ul>
<a id="more"></a>
<h2 id="å®‰è£…Ruby"><a href="#å®‰è£…Ruby" class="headerlink" title="å®‰è£…Ruby"></a>å®‰è£… Ruby</h2><p>Ruby æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨ <a href="https://rvm.io" target="_blank" rel="noopener">rvm (Ruby Version Manager)</a> æ¥ç®¡ç† Ruby çš„ç‰ˆæœ¬ã€‚å¯¹äº windows å°ä¼™ä¼´æ¥è¯´ï¼Œå»ºè®®<a href="https://rubyinstaller.org/" target="_blank" rel="noopener">ä½¿ç”¨ Ruby å®‰è£…ç¨‹åº</a>è¿›è¡Œå®‰è£…</p>
<p>å®‰è£… Ruby</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Jekyll éœ€è¦ Ruby ç‰ˆæœ¬ &gt;= 2.1.0</span></span><br><span class="line">rvm install 2.5.1</span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨ <a href="https://ruby-china.org/wiki/ruby-mirror" target="_blank" rel="noopener">ruby-china çš„æºé•œåƒ</a><br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ›¿æ¢ rvm çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"ruby_url=https://cache.ruby-china.com/pub/ruby"</span> &gt; ~/.rvm/user/db</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="å®‰è£…Jekyll"><a href="#å®‰è£…Jekyll" class="headerlink" title="å®‰è£…Jekyll"></a>å®‰è£… Jekyll</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">gem install bundler jekyll</span><br></pre></td></tr></tbody></table></figure>
<p>å›½å†…å°ä¼™ä¼´å»ºè®®å…ˆä½¿ç”¨ <a href="https://gems.ruby-china.com" target="_blank" rel="noopener">ruby-china çš„ Gem é•œåƒ</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ›¿æ¢Gemæº</span></span><br><span class="line">gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢ Bundler çš„ Gem æºä»£ç é•œåƒå‘½ä»¤</span></span><br><span class="line">bundle config mirror.https://rubygems.org https://gems.ruby-china.com</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä½¿ç”¨Jekyll"><a href="#ä½¿ç”¨Jekyll" class="headerlink" title="ä½¿ç”¨Jekyll"></a>ä½¿ç”¨ Jekyll</h1><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Jekyll new åšå®¢æ–‡ä»¶å¤¹</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥åšå®¢ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> åšå®¢æ–‡ä»¶å¤¹</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">bundle install</span><br></pre></td></tr></tbody></table></figure>
<p>æŸ¥çœ‹ <code>jekyll new</code> æ›´å¤šå¸®åŠ©<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">jekyll new -h</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="æœ¬åœ°å¯åŠ¨"><a href="#æœ¬åœ°å¯åŠ¨" class="headerlink" title="æœ¬åœ°å¯åŠ¨"></a>æœ¬åœ°å¯åŠ¨</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># s æ˜¯ server</span></span><br><span class="line"></span><br><span class="line">jekyll s</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶ååœ¨å¯ä»¥æœ¬åœ°æµè§ˆå™¨æ‰“å¼€ <a href="http://localhost:4000ï¼Œå°±å¯ä»¥è®¿é—®å¯åŠ¨å¥½çš„åšå®¢å•¦" target="_blank" rel="noopener">http://localhost:4000ï¼Œå°±å¯ä»¥è®¿é—®å¯åŠ¨å¥½çš„åšå®¢å•¦</a></p>
<p>æŸ¥çœ‹ <code>jekyll server</code> æ›´å¤šå¸®åŠ©<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">jekyll s -h</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="ä½¿ç”¨Nextä¸»é¢˜"><a href="#ä½¿ç”¨Nextä¸»é¢˜" class="headerlink" title="ä½¿ç”¨Nextä¸»é¢˜"></a>ä½¿ç”¨ Next ä¸»é¢˜</h2><p>æˆ‘ä½¿ç”¨çš„ <a href="https://github.com/Simpleyyt/jekyll-theme-next" target="_blank" rel="noopener">Next</a> ä¸»é¢˜</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/Simpleyyt/jekyll-theme-next</span><br><span class="line"><span class="built_in">cd</span> jekyll-theme-next</span><br><span class="line">bundle install</span><br><span class="line">jekyll s <span class="comment"># å¯åŠ¨</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ­¤æ—¶<code>é¡¹ç›®ç›®å½•</code>å°±æ˜¯ <code>jekyll-theme-next</code>ï¼Œä¿®æ”¹<code>é¡¹ç›®ç›®å½•</code>ä¸‹çš„<code>_config.yml</code> æ–‡ä»¶ï¼Œå¿…é¡»é‡å¯ Hexo æœ¬åœ°æœåŠ¡ï¼Œå³å¯åœ¨æœ¬åœ°çœ‹åˆ°æ–°çš„ä¸»é¢˜æ ·å¼</p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>Jekyll å¤§éƒ¨ä»½çš„çš„é…ç½®åœ¨<code>é¡¹ç›®ç›®å½•</code>ä¸‹çš„<code>_config.yml</code> ä¸­ï¼Œæ ¹æ® <a href="http://jekyllrb.com" target="_blank" rel="noopener">Jekyll å®˜æ–¹æ–‡æ¡£</a>ï¼Œ<a href="http://jekyll.com.cn" target="_blank" rel="noopener">Jekyll ä¸­æ–‡æ–‡æ¡£</a>å’Œ <a href="http://theme-next.simpleyyt.com/" target="_blank" rel="noopener">Next æ–‡æ¡£</a>æŒ‰ç…§è‡ªå·±éœ€è¦æ”¹åŠ¨å³å¯</p>
<h2 id="å†™æ–‡ç« "><a href="#å†™æ–‡ç« " class="headerlink" title="å†™æ–‡ç« "></a>å†™æ–‡ç« </h2><p>éœ€è¦åœ¨<code>_posts</code> æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæ–‡ä»¶æ ¼å¼ä¸º<code>å¹´-æœˆ-æ—¥-æ ‡é¢˜.md</code>ï¼Œ<code>å¹´</code>æ˜¯å››ä½æ•°å­—ï¼Œ<code>æœˆ</code>å’Œ<code>æ—¥</code>éƒ½æ˜¯ä¸¤ä½</p>
<p>æ›´å¤šè¯´æ˜ï¼Œå‚è€ƒ <a href="https://www.jekyll.com.cn/docs/posts/" target="_blank" rel="noopener">Jekyll å†™ä½œ</a></p>
<h1 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h1><p>éƒ¨ç½²çš„åŸºæœ¬åŸç†åŒ <a href="/2018/09/17/Hexo%E7%9A%84%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2#éƒ¨ç½²">Hexo çš„éƒ¨ç½²</a> , ä½†æ˜¯ Jekyll æ²¡æœ‰ç±»ä¸ Hexo çš„ <code>hexo-deployer-git</code>ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨æŠŠè¿™é™æ€èµ„æºçš„ç›®å½•<code>_site</code> çš„ä¸­å†…å®¹æäº¤åˆ°è¿œç¨‹å°±å¯ä»¥äº†</p>
<hr>
]]></content>
      <categories>
        <category>Jekyll</category>
      </categories>
      <tags>
        <tag>éƒ¨ç½²</tag>
        <tag>é…ç½®</tag>
        <tag>Jekyll</tag>
      </tags>
  </entry>
  <entry>
    <title>Rails åŠ¨ä½œç¼“å­˜</title>
    <url>/2018/09/24/Rails%E5%8A%A8%E4%BD%9C%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<h1 id="åŠ¨ä½œç¼“å­˜"><a href="#åŠ¨ä½œç¼“å­˜" class="headerlink" title="åŠ¨ä½œç¼“å­˜"></a>åŠ¨ä½œç¼“å­˜</h1><p>æœ‰å‰ç½®è¿‡æ»¤å™¨çš„åŠ¨ä½œä¸èƒ½ä½¿ç”¨é¡µé¢ç¼“å­˜ï¼Œä¾‹å¦‚éœ€è¦éªŒè¯èº«ä»½çš„é¡µé¢ã€‚æ­¤æ—¶ï¼Œåº”è¯¥ä½¿ç”¨åŠ¨ä½œç¼“å­˜ã€‚åŠ¨ä½œç¼“å­˜çš„å·¥ä½œåŸç†ä¸é¡µé¢ç¼“å­˜ç±»ä¼¼ï¼Œä¸è¿‡å…¥ç«™è¯·æ±‚ä¼šç»è¿‡ Rails æ ˆå¤„ç†ï¼Œä»¥ä¾¿è¿è¡Œå‰ç½®è¿‡æ»¤å™¨ï¼Œç„¶åå†ä¼ºæœç¼“å­˜ã€‚è¿™æ ·ï¼Œå¯ä»¥åšèº«ä»½éªŒè¯å’Œå…¶ä»–é™åˆ¶ï¼ŒåŒæ—¶è¿˜èƒ½ä»ç¼“å­˜çš„å‰¯æœ¬ä¸­ä¼ºæœç»“æœã€‚</p>
<div class="note info"><p>åŠ¨ä½œç¼“å­˜å·²ä» Rails 4 ä¸­åˆ é™¤</p></div>
<p>åŠ¨ä½œç¼“å­˜ <a href="https://github.com/rails/actionpack-action_caching" target="_blank" rel="noopener">actionpack-action_caching çš„åœ°å€</a></p>
<a id="more"></a>
<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>åœ¨ Rails é¡¹ç›®ä¸­çš„ <code>Gemfile</code> æ–‡ä»¶ä¸­æ·»åŠ </p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">gem <span class="string">'actionpack-action_caching'</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åæ‰§è¡Œ <code>bundle install</code> å‘½ä»¤å®‰è£…</p>
<h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><p>è¯¦ç»†ä»‹ç»æŸ¥çœ‹åŠ¨ä½œç¼“å­˜ <a href="https://github.com/rails/actionpack-action_caching" target="_blank" rel="noopener">actionpack-action_caching</a></p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListsController</span> &lt; ApplicationController</span></span><br><span class="line">  before_action <span class="symbol">:authenticate</span>, <span class="symbol">except:</span> <span class="symbol">:public</span></span><br><span class="line"></span><br><span class="line">  caches_page   <span class="symbol">:public</span></span><br><span class="line">  caches_action <span class="symbol">:index</span>, <span class="symbol">:show</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListsController</span> &lt; ApplicationController</span></span><br><span class="line">  before_action <span class="symbol">:authenticate</span>, <span class="symbol">except:</span> <span class="symbol">:public</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># simple fragment cache</span></span><br><span class="line">  caches_action <span class="symbol">:current</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># expire cache after an hour</span></span><br><span class="line">  caches_action <span class="symbol">:archived</span>, <span class="symbol">expires_in:</span> <span class="number">1</span>.hour</span><br><span class="line"></span><br><span class="line">  <span class="comment"># cache unless it's a JSON request</span></span><br><span class="line">  caches_action <span class="symbol">:index</span>, <span class="symbol">unless:</span> -&gt; { request.format.json? }</span><br><span class="line"></span><br><span class="line">  <span class="comment"># custom cache path</span></span><br><span class="line">  caches_action <span class="symbol">:show</span>, <span class="symbol">cache_path:</span> { <span class="symbol">project:</span> <span class="number">1</span> }</span><br><span class="line"></span><br><span class="line">  <span class="comment"># custom cache path with a proc</span></span><br><span class="line">  caches_action <span class="symbol">:history</span>, <span class="symbol">cache_path:</span> -&gt; { request.domain }</span><br><span class="line"></span><br><span class="line">  <span class="comment"># custom cache path with a symbol</span></span><br><span class="line">  caches_action <span class="symbol">:feed</span>, <span class="symbol">cache_path:</span> <span class="symbol">:user_cache_path</span></span><br><span class="line"></span><br><span class="line">  protected</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_cache_path</span></span></span><br><span class="line">      <span class="keyword">if</span> params[<span class="symbol">:user_id</span>]</span><br><span class="line">        user_list_url(params[<span class="symbol">:user_id</span>], params[<span class="symbol">:id</span>])</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        list_url(params[<span class="symbol">:id</span>])</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Rails</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
        <tag>Rails</tag>
      </tags>
  </entry>
  <entry>
    <title>Rails å¯¹ HTTP æ¡ä»¶ GET è¯·æ±‚çš„æ”¯æŒ</title>
    <url>/2018/09/27/Rails%E5%AF%B9HTTP%E6%9D%A1%E4%BB%B6GET%E8%AF%B7%E6%B1%82%E7%9A%84%E6%94%AF%E6%8C%81/</url>
    <content><![CDATA[<p><a href="https://ruby-china.github.io/rails-guides/caching_with_rails.html#conditional-get-support" target="_blank" rel="noopener">åŸæ–‡åœ°å€</a></p>
<h1 id="å¯¹æ¡ä»¶-GET-è¯·æ±‚çš„æ”¯æŒ"><a href="#å¯¹æ¡ä»¶-GET-è¯·æ±‚çš„æ”¯æŒ" class="headerlink" title="å¯¹æ¡ä»¶ GET è¯·æ±‚çš„æ”¯æŒ"></a>å¯¹æ¡ä»¶ GET è¯·æ±‚çš„æ”¯æŒ</h1><p>æ¡ä»¶ GET è¯·æ±‚æ˜¯ HTTP è§„èŒƒçš„ä¸€ä¸ªç‰¹æ€§ï¼Œä»¥æ­¤å‘Šè¯‰ Web æµè§ˆå™¨ï¼ŒGET è¯·æ±‚çš„å“åº”è‡ªä¸Šæ¬¡è¯·æ±‚ä¹‹åæ²¡æœ‰å˜åŒ–ï¼Œå¯ä»¥æ”¾å¿ƒä»æµè§ˆå™¨çš„ç¼“å­˜ä¸­è¯»å–ã€‚</p>
<a id="more"></a>
<p>ä¸ºæ­¤ï¼Œè¦ä¼ é€’ <code>HTTP_IF_NONE_MATCH</code> å’Œ <code>HTTP_IF_MODIFIED_SINCE</code> é¦–éƒ¨ï¼Œå…¶å€¼åˆ†åˆ«ä¸ºå”¯ä¸€çš„å†…å®¹æ ‡è¯†ç¬¦å’Œä¸Šä¸€æ¬¡æ”¹åŠ¨æ—¶çš„æ—¶é—´æˆ³ã€‚æµè§ˆå™¨å‘é€çš„è¯·æ±‚ï¼Œå¦‚æœå†…å®¹æ ‡è¯†ç¬¦ï¼ˆ<code>etag</code>ï¼‰æˆ–ä¸Šä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´æˆ³ä¸æœåŠ¡å™¨ä¸­çš„ç‰ˆæœ¬åŒ¹é…ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åªéœ€è¿”å›ä¸€ä¸ªç©ºå“åº”ï¼ŒæŠŠçŠ¶æ€è®¾ä¸ºæœªä¿®æ”¹ã€‚</p>
<p>æœåŠ¡å™¨ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±ï¼‰è¦è´Ÿè´£æŸ¥çœ‹æœ€åä¿®æ”¹æ—¶é—´æˆ³å’Œ <code>HTTP_IF_NONE_MATCH</code> é¦–éƒ¨ï¼Œåˆ¤æ–­è¦ä¸è¦è¿”å›å®Œæ•´çš„å“åº”ã€‚æ—¢ç„¶ Rails æ”¯æŒæ¡ä»¶ GET è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±éå¸¸ç®€å•ï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductsController</span> &lt; ApplicationController</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    @product = Product.find(params[<span class="symbol">:id</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœæ ¹æ®æŒ‡å®šçš„æ—¶é—´æˆ³å’Œ etag å€¼åˆ¤æ–­è¯·æ±‚çš„å†…å®¹è¿‡æœŸäº†</span></span><br><span class="line">    <span class="comment"># ï¼ˆå³éœ€è¦é‡æ–°å¤„ç†ï¼‰æ‰§è¡Œè¿™ä¸ªå—</span></span><br><span class="line">    <span class="keyword">if</span> stale?(<span class="symbol">last_modified:</span> @product.updated_at.utc, <span class="symbol">etag:</span> @product.cache_key)</span><br><span class="line">      respond_to <span class="keyword">do</span> <span class="params">|wants|</span></span><br><span class="line">        <span class="comment"># ... æ­£å¸¸å¤„ç†å“åº”</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœè¯·æ±‚çš„å†…å®¹è¿˜æ–°é²œï¼ˆå³æœªä¿®æ”¹ï¼‰ï¼Œæ— éœ€åšä»»ä½•äº‹</span></span><br><span class="line">    <span class="comment"># render é»˜è®¤ä½¿ç”¨å‰é¢ stale? ä¸­çš„å‚æ•°åšæ£€æŸ¥ï¼Œä¼šè‡ªåŠ¨å‘é€ :not_modified å“åº”</span></span><br><span class="line">    <span class="comment"># å°±è¿™æ ·ï¼Œå·¥ä½œç»“æŸ</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>é™¤äº†æ•£åˆ—ï¼Œè¿˜å¯ä»¥ä¼ å…¥æ¨¡å‹ã€‚Rails ä¼šä½¿ç”¨ <code>updated_at</code> å’Œ <code>cache_key</code> æ–¹æ³•è®¾å®š <code>last_modified</code> å’Œ <code>etag</code>ï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductsController</span> &lt; ApplicationController</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    @product = Product.find(params[<span class="symbol">:id</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stale?(@product)</span><br><span class="line">      respond_to <span class="keyword">do</span> <span class="params">|wants|</span></span><br><span class="line">        <span class="comment"># ... æ­£å¸¸å¤„ç†å“åº”</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæ— éœ€ç‰¹æ®Šå¤„ç†å“åº”ï¼Œè€Œä¸”ä½¿ç”¨é»˜è®¤çš„æ¸²æŸ“æœºåˆ¶ï¼ˆå³ä¸ä½¿ç”¨ <code>respond_to</code>ï¼Œæˆ–è€…ä¸è‡ªå·±è°ƒç”¨ <code>render</code>ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>fresh_when</code> ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductsController</span> &lt; ApplicationController</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># å¦‚æœè¯·æ±‚çš„å†…å®¹æ˜¯æ–°é²œçš„ï¼Œè‡ªåŠ¨è¿”å› :not_modified</span></span><br><span class="line">  <span class="comment"># å¦åˆ™æ¸²æŸ“é»˜è®¤çš„æ¨¡æ¿ï¼ˆproduct.*ï¼‰</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    @product = Product.find(params[<span class="symbol">:id</span>])</span><br><span class="line">    fresh_when <span class="symbol">last_modified:</span> @product.published_at.utc, <span class="symbol">etag:</span> @product</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç¼“å­˜å“åº”ï¼Œä¾‹å¦‚æ°¸ä¸è¿‡æœŸçš„é™æ€é¡µé¢ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨ <code>http_cache_forever</code> è¾…åŠ©æ–¹æ³•ï¼Œè®©æµè§ˆå™¨å’Œä»£ç†æ— é™æœŸç¼“å­˜ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼“å­˜çš„å“åº”æ˜¯ç§æœ‰çš„ï¼Œåªåœ¨ç”¨æˆ·çš„ Web æµè§ˆå™¨ä¸­ç¼“å­˜ã€‚å¦‚æœæƒ³è®©ä»£ç†ç¼“å­˜å“åº”ï¼Œè®¾å®š <code>public: true</code>ï¼Œè®©ä»£ç†æŠŠç¼“å­˜çš„å“åº”æä¾›ç»™æ‰€æœ‰ç”¨æˆ·ã€‚</p>
<p>ä½¿ç”¨è¿™ä¸ªè¾…åŠ©æ–¹æ³•æ—¶ï¼Œ<code>last_modified</code> é¦–éƒ¨çš„å€¼è¢«è®¾ä¸º <code>Time.new(2011, 1, 1).utc</code>ï¼Œ<code>expires</code> é¦–éƒ¨çš„å€¼è¢«è®¾ä¸º 100 å¹´ã€‚</p>
<div class="note warning"><p>ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ—¶è¦å°å¿ƒï¼Œå› ä¸ºæµè§ˆå™¨å’Œä»£ç†ä¸ä¼šä½œåºŸç¼“å­˜çš„å“åº”ï¼Œé™¤éå¼ºåˆ¶æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€‚</p></div>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> &lt; ApplicationController</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></span><br><span class="line">    http_cache_forever(<span class="symbol">public:</span> <span class="literal">true</span>) <span class="keyword">do</span></span><br><span class="line">      render</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å¼º-Etag-ä¸å¼±-Etag"><a href="#å¼º-Etag-ä¸å¼±-Etag" class="headerlink" title="å¼º Etag ä¸å¼± Etag"></a>å¼º Etag ä¸å¼± Etag</h2><p>Rails é»˜è®¤ç”Ÿæˆå¼± ETagã€‚è¿™ç§ Etag å…è®¸è¯­ä¹‰ç­‰æ•ˆä½†ä¸»ä½“ä¸å®Œå…¨åŒ¹é…çš„å“åº”å…·æœ‰ç›¸åŒçš„ Etagã€‚å¦‚æœå“åº”ä¸»ä½“æœ‰å¾®å°æ”¹åŠ¨ï¼Œè€Œä¸æƒ³é‡æ–°æ¸²æŸ“é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§ Etagã€‚</p>
<p>ä¸ºäº†ä¸å¼º Etag åŒºåˆ«ï¼Œå¼± Etag å‰é¢æœ‰ <code>W/</code>ã€‚<br></p><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">W/<span class="string">"618bbc92e2d35ea1945008b42799b0e7"</span> <span class="comment"># =&gt; å¼± ETag</span></span><br><span class="line"><span class="string">"618bbc92e2d35ea1945008b42799b0e7"</span>   <span class="comment"># =&gt; å¼º ETag</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ä¸å¼± Etag ä¸åŒï¼Œå¼º Etag è¦æ±‚å“åº”å®Œå…¨ä¸€æ ·ï¼Œä¸èƒ½æœ‰ä¸€ä¸ªå­—èŠ‚çš„å·®å¼‚ã€‚åœ¨å¤§å‹è§†é¢‘æˆ– PDF æ–‡ä»¶å†…éƒ¨åš Range æŸ¥è¯¢æ—¶ç”¨å¾—åˆ°ã€‚æœ‰äº› CDNï¼Œå¦‚ Akamaiï¼Œåªæ”¯æŒå¼º Etagã€‚å¦‚æœç¡®å®æƒ³ç”Ÿæˆå¼º Etagï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductsController</span> &lt; ApplicationController</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    @product = Product.find(params[<span class="symbol">:id</span>])</span><br><span class="line">    fresh_when <span class="symbol">last_modified:</span> @product.published_at.utc, <span class="symbol">strong_etag:</span> @product</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹Ÿå¯ä»¥ç›´æ¥åœ¨å“åº”ä¸Šè®¾å®šå¼º Etagï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">response.strong_etag = response.body</span><br><span class="line"><span class="comment"># =&gt; "618bbc92e2d35ea1945008b42799b0e7"</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Rails</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
        <tag>Rails</tag>
      </tags>
  </entry>
  <entry>
    <title>Rails ä¸­çš„ ActiveSupport::Concern</title>
    <url>/2018/09/28/Rails%E4%B8%AD%E7%9A%84ActiveSupport-Concern/</url>
    <content><![CDATA[<h1 id="æ™®é€šçš„mixin"><a href="#æ™®é€šçš„mixin" class="headerlink" title="æ™®é€šçš„mixin"></a>æ™®é€šçš„ mixin</h1><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="comment"># self.includedæ˜¯includeæ—¶çš„é’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></span><br><span class="line">    <span class="comment"># baseæ‰©å±•</span></span><br><span class="line">    base.extend ClassMethods</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰“å¼€baseï¼Œåœ¨baseä¸­æ‰§è¡Œä»£ç </span></span><br><span class="line">    base.class_eval <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># è¿™é‡Œå†™ä¸€ä¸ªç±»includeæ—¶åœ¨ç±»éœ€è¦æ‰§è¡Œä»€ä¹ˆåŠ¨ä½œ</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></span><br><span class="line">    <span class="comment"># è¿™é‡Œå†™ä¸€ä¸ªç±»includeè¯¥moduleåç”Ÿæˆçš„ç±»æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è¿™é‡Œå†™ä¸€ä¸ªç±»includeè¯¥moduleåç”Ÿæˆçš„å®ä¾‹ç±»æ–¹æ³•</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h1 id="ä½¿ç”¨-ActiveSupport-Concern"><a href="#ä½¿ç”¨-ActiveSupport-Concern" class="headerlink" title="ä½¿ç”¨ ActiveSupport::Concern"></a>ä½¿ç”¨ ActiveSupport::Concern</h1><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'active_support/concern'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="comment"># æ‰©å±•å½“å‰module</span></span><br><span class="line">  extend ActiveSupport::Concern</span><br><span class="line"></span><br><span class="line">  <span class="comment"># è°ƒç”¨Concernä¸­å®šä¹‰çš„includedæ–¹æ³•</span></span><br><span class="line">  included <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œå†™ä¸€ä¸ªç±»includeæ—¶åœ¨ç±»éœ€è¦æ‰§è¡Œä»€ä¹ˆåŠ¨ä½œ</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è°ƒç”¨Concernä¸­å®šä¹‰çš„class_methodsæ–¹æ³•</span></span><br><span class="line">  class_methods <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œå†™ä¸€ä¸ªç±»includeè¯¥moduleåç”Ÿæˆçš„ç±»æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è¿™é‡Œå†™ä¸€ä¸ªç±»includeè¯¥moduleåç”Ÿæˆçš„å®ä¾‹ç±»æ–¹æ³•</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="è§£è¯»-ActiveSupport-Concern"><a href="#è§£è¯»-ActiveSupport-Concern" class="headerlink" title="è§£è¯» ActiveSupport::Concern"></a>è§£è¯» ActiveSupport::Concern</h1><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveSupport</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Concern</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®šä¹‰äº†ä¸€ä¸ªå¼‚å¸¸ç±»ï¼Œä¸èƒ½å¤šæ¬¡include</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MultipleIncludedBlocks</span> &lt; StandardError</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">        <span class="keyword">super</span> <span class="string">"Cannot define multiple 'included' blocks for a Concern"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self.extendedæ˜¯extendæ—¶çš„é’©å­æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">extended</span><span class="params">(base)</span></span></span><br><span class="line">      <span class="comment"># å®šä¹‰baseä¸­çš„@_dependencies</span></span><br><span class="line">      base.instance_variable_set(<span class="symbol">:</span>@_dependencies, [])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rubyåœ¨includeä¸€ä¸ªmoduleæ—¶ä¼šè°ƒç”¨append_featuresæ–¹æ³•ï¼Œè¿›è¡Œå®é™…çš„mixinæ“ä½œï¼ŒåŒ…æ‹¬å¢åŠ å¸¸é‡ï¼Œæ–¹æ³•å’Œå˜é‡åˆ°æ¨¡å—ä¸­</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append_features</span><span class="params">(base)</span></span></span><br><span class="line">      <span class="keyword">if</span> base.instance_variable_defined?(<span class="symbol">:</span>@_dependencies)</span><br><span class="line">        <span class="comment"># å¦‚æœæœ‰å¼•å…¥å·²ç»å®šä¹‰@_dependenciesæ—¶ï¼Œä¸€èˆ¬æ˜¯å¼•å…¥ä¸€ä¸ªå·²ç»extendè¿™ä¸ªConcernçš„moduleï¼Œæ‰ä¼šå®šä¹‰@_dependencies</span></span><br><span class="line">        <span class="comment"># å°†åextendè¿™ä¸ªConcernçš„moduleæ”¾å…¥åˆ°@_dependenciesä¸­</span></span><br><span class="line">        base.instance_variable_get(<span class="symbol">:</span>@_dependencies) &lt;&lt; <span class="keyword">self</span></span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> base &lt; <span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># @_dependenciesæ˜¯è¯¦è§ä¸Šé¢å®šä¹‰çš„self.extended</span></span><br><span class="line">        <span class="comment"># å…ˆå¼•å…¥åŒ…å«åœ¨@_dependenciesä¸­module</span></span><br><span class="line">        @_dependencies.each { <span class="params">|dep|</span> base.<span class="keyword">include</span>(dep) }</span><br><span class="line">        <span class="keyword">super</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ClassMethodsæ˜¯è¯¦è§ä¸‹é¢å®šä¹‰çš„class_methods</span></span><br><span class="line">        <span class="comment"># å¦‚æœå®šä¹‰ClassMethods,å°†ClassMethodsä¸­çš„æ–¹æ³•extendåˆ°baseä¸­</span></span><br><span class="line">        base.extend const_get(<span class="symbol">:ClassMethods</span>) <span class="keyword">if</span> const_defined?(<span class="symbol">:ClassMethods</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># @_included_blockæ˜¯è¯¦è§ä¸‹é¢å®šä¹‰çš„includedæ–¹æ³•</span></span><br><span class="line">        <span class="comment"># å¦‚æœå®šä¹‰@_included_block,åœ¨baseä¸­æ‰§è¡Œ@_included_blockä¸­çš„ä»£ç </span></span><br><span class="line">        base.class_eval(&amp;@_included_block) <span class="keyword">if</span> instance_variable_defined?(<span class="symbol">:</span>@_included_block)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># extendåï¼Œå°†å¯ä»¥ä½¿ç”¨includedè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">included</span><span class="params">(base = <span class="literal">nil</span>, &amp;block)</span></span></span><br><span class="line">      <span class="keyword">if</span> base.<span class="literal">nil</span>?</span><br><span class="line">        <span class="comment"># åˆ¤æ–­æ˜¯å¦å¤šæ¬¡include</span></span><br><span class="line">        raise MultipleIncludedBlocks <span class="keyword">if</span> instance_variable_defined?(<span class="symbol">:</span>@_included_block)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç±»å®ä¾‹ç±»å˜é‡</span></span><br><span class="line">        @_included_block = block</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">super</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># extendåï¼Œå°†å¯ä»¥ä½¿ç”¨class_methodsè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_methods</span><span class="params">(&amp;class_methods_module_definition)</span></span></span><br><span class="line">      <span class="comment"># extendæ—¶åˆ¤æ–­å½“å‰moduleæ˜¯å¦å®šä¹‰äº†ClassMethodsè¿™ä¸ªå¸¸é‡ï¼Œä¸åŒ…æ‹¬çˆ¶çº§</span></span><br><span class="line">      <span class="comment"># æœ‰çš„è¯å°±ä½¿ç”¨å·²ç»å®šä¹‰å¥½çš„ï¼Œæ²¡æœ‰å°±Module.newä¸€ä¸ª</span></span><br><span class="line">      mod = const_defined?(<span class="symbol">:ClassMethods</span>, <span class="literal">false</span>) ?</span><br><span class="line">        const_get(<span class="symbol">:ClassMethods</span>) <span class="symbol">:</span></span><br><span class="line">        const_set(<span class="symbol">:ClassMethods</span>, Module.new)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># extendåï¼Œè°ƒç”¨class_methodsæ–¹æ—¶å°†å—é‡Œçš„å®šå†™å…¥åˆ°ClassMethodsé‡Œ</span></span><br><span class="line">      mod.module_eval(&amp;class_methods_module_definition)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Rails</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
        <tag>Rails</tag>
      </tags>
  </entry>
  <entry>
    <title>Rails ç‰‡æ®µç¼“å­˜ä»¥åŠå…¶ä»–ç¼“å­˜</title>
    <url>/2018/09/25/Rails%E7%89%87%E6%AE%B5%E7%BC%93%E5%AD%98%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BB%96%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<p>æ›´å¤šè¯¦ç»†æŸ¥çœ‹<a href="https://ruby-china.github.io/rails-guides/caching_with_rails.html#fragment-caching" target="_blank" rel="noopener">åŸæ–‡åœ°å€</a></p>
<h1 id="ç‰‡æ®µç¼“å­˜"><a href="#ç‰‡æ®µç¼“å­˜" class="headerlink" title="ç‰‡æ®µç¼“å­˜"></a>ç‰‡æ®µç¼“å­˜</h1><p>åŠ¨æ€ Web åº”ç”¨ä¸€èˆ¬ä½¿ç”¨ä¸åŒçš„ç»„ä»¶æ„å»ºé¡µé¢ï¼Œä¸æ˜¯æ‰€æœ‰ç»„ä»¶éƒ½èƒ½ä½¿ç”¨åŒä¸€ç§ç¼“å­˜æœºåˆ¶ã€‚å¦‚æœé¡µé¢çš„ä¸åŒéƒ¨åˆ†éœ€è¦ä½¿ç”¨ä¸åŒçš„ç¼“å­˜æœºåˆ¶ï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹å¤±æ•ˆï¼Œå¯ä»¥ä½¿ç”¨ç‰‡æ®µç¼“å­˜ï¼ˆ<code>ActionView::Helpers::CacheHelper#cache</code>ï¼‰ã€‚ç‰‡æ®µç¼“å­˜æŠŠè§†å›¾é€»è¾‘çš„ä¸€éƒ¨åˆ†æ”¾åœ¨ <code>cache</code> å—ä¸­ï¼Œä¸‹æ¬¡è¯·æ±‚ä½¿ç”¨ç¼“å­˜å­˜å‚¨å™¨ä¸­çš„å‰¯æœ¬ä¼ºæœ<br><a id="more"></a></p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>å¦‚æœæƒ³ç¼“å­˜é¡µé¢ä¸­çš„å„ä¸ªå•†å“ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹è¿°ä»£ç ï¼š<br></p><figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line">&lt;%<span class="ruby"> @products.each <span class="keyword">do</span> <span class="params">|product|</span> </span>%&gt;</span><br><span class="line">  &lt;%<span class="ruby"> cache product <span class="keyword">do</span> </span>%&gt;</span><br><span class="line">    &lt;%=<span class="ruby"> render product </span>%&gt;</span><br><span class="line">  &lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;</span><br><span class="line">&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>é¦–æ¬¡è®¿é—®è¿™ä¸ªé¡µé¢æ—¶ï¼ŒRails ä¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰å”¯ä¸€é”®çš„ç¼“å­˜æ¡ç›®ã€‚ç¼“å­˜é”®ç±»ä¼¼ä¸‹é¢è¿™ç§</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">views/products/1-201505056193031061005000/bea67108094918eeba42cd4a6e786901</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸­é—´çš„æ•°å­—æ˜¯ <code>product_id</code> åŠ ä¸Šå•†å“è®°å½•çš„ <code>updated_at</code> å±æ€§ä¸­å­˜å‚¨çš„æ—¶é—´æˆ³ã€‚Rails ä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿ä¸ä¼ºæœè¿‡æœŸçš„æ•°æ®ã€‚å¦‚æœ <code>updated_at</code> çš„å€¼å˜äº†ï¼ŒRails ä¼šç”Ÿæˆä¸€ä¸ªæ–°é”®ï¼Œç„¶ååœ¨é‚£ä¸ªé”®ä¸Šå†™å…¥ä¸€ä¸ªæ–°ç¼“å­˜ï¼Œæ—§é”®ä¸Šçš„æ—§ç¼“å­˜ä¸å†ä½¿ç”¨ã€‚è¿™å«åŸºäºé”®çš„å¤±æ•ˆæ–¹å¼</p>
<p>è§†å›¾ç‰‡æ®µæœ‰å˜åŒ–æ—¶ï¼ˆä¾‹å¦‚è§†å›¾çš„ HTML æœ‰å˜ï¼‰ï¼Œç¼“å­˜çš„ç‰‡æ®µä¹Ÿå¤±æ•ˆã€‚ç¼“å­˜é”®æœ«å°¾é‚£ä¸ªå­—ç¬¦ä¸²æ˜¯æ¨¡æ¿æ ‘æ‘˜è¦ï¼Œæ˜¯åŸºäºç¼“å­˜çš„è§†å›¾ç‰‡æ®µçš„å†…å®¹è®¡ç®—çš„ MD5 å“ˆå¸Œå€¼ã€‚å¦‚æœè§†å›¾ç‰‡æ®µæœ‰å˜åŒ–ï¼ŒMD5 å“ˆå¸Œå€¼å°±å˜äº†ï¼Œå› æ­¤ç°æœ‰æ–‡ä»¶å¤±æ•ˆ</p>
<div class="note info"><p>Memcached ç­‰ç¼“å­˜å­˜å‚¨å™¨ä¼šè‡ªåŠ¨åˆ é™¤æ—§çš„ç¼“å­˜æ–‡ä»¶</p></div>
<p>ç‰¹å®šæ¡ä»¶ä¸‹ç¼“å­˜ä¸€ä¸ªç‰‡æ®µï¼Œå¯ä»¥ä½¿ç”¨ <code>cache_if</code> æˆ– <code>cache_unless</code><br></p><figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line">&lt;%<span class="ruby"> cache_if admin?, product <span class="keyword">do</span> </span>%&gt;</span><br><span class="line">  &lt;%=<span class="ruby"> render product </span>%&gt;</span><br><span class="line">&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>render</code> è¾…åŠ©æ–¹æ³•è¿˜èƒ½ç¼“å­˜æ¸²æŸ“é›†åˆçš„å•ä¸ªæ¨¡æ¿ã€‚è¿™ç”šè‡³æ¯”ä½¿ç”¨ <code>each</code> çš„å‰è¿°ç¤ºä¾‹æ›´å¥½ï¼Œå› ä¸ºæ˜¯ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰ç¼“å­˜æ¨¡æ¿çš„ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡è¯»å–ä¸€ä¸ªã€‚è‹¥æƒ³ç¼“å­˜é›†åˆï¼Œæ¸²æŸ“é›†åˆæ—¶ä¼ å…¥ <code>cached: true</code> é€‰é¡¹</p>
<figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line">&lt;%=<span class="ruby"> render <span class="symbol">partial:</span> <span class="string">'products/product'</span>, <span class="symbol">collection:</span> @products, <span class="symbol">cached:</span> <span class="literal">true</span> </span>%&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸­æ‰€æœ‰çš„ç¼“å­˜æ¨¡æ¿ä¸€æ¬¡æ€§è·å–ï¼Œé€Ÿåº¦æ›´å¿«ã€‚æ­¤å¤–ï¼Œå°šæœªç¼“å­˜çš„æ¨¡æ¿ä¹Ÿä¼šå†™å…¥ç¼“å­˜ï¼Œåœ¨ä¸‹æ¬¡æ¸²æŸ“æ—¶è·å–</p>
<h1 id="ä¿„ç½—æ–¯å¥—å¨ƒç¼“å­˜"><a href="#ä¿„ç½—æ–¯å¥—å¨ƒç¼“å­˜" class="headerlink" title="ä¿„ç½—æ–¯å¥—å¨ƒç¼“å­˜"></a>ä¿„ç½—æ–¯å¥—å¨ƒç¼“å­˜</h1><p>æœ‰æ—¶ï¼Œå¯èƒ½æƒ³æŠŠç¼“å­˜çš„ç‰‡æ®µåµŒå¥—åœ¨å…¶ä»–ç¼“å­˜çš„ç‰‡æ®µé‡Œã€‚è¿™å«ä¿„ç½—æ–¯å¥—å¨ƒç¼“å­˜ï¼ˆRussian doll cachingï¼‰<br>ä¿„ç½—æ–¯å¥—å¨ƒç¼“å­˜çš„ä¼˜ç‚¹æ˜¯ï¼Œæ›´æ–°å•ä¸ªå•†å“åï¼Œé‡æ–°ç”Ÿæˆå¤–å±‚ç‰‡æ®µæ—¶ï¼Œå…¶ä»–å†…å­˜ç‰‡æ®µå¯ä»¥å¤ç”¨<br>å‰ä¸€èŠ‚è¯´è¿‡ï¼Œå¦‚æœç¼“å­˜çš„æ–‡ä»¶å¯¹åº”çš„è®°å½•çš„ <code>updated_at</code> å±æ€§å€¼å˜äº†ï¼Œç¼“å­˜çš„æ–‡ä»¶å¤±æ•ˆã€‚ä½†æ˜¯ï¼Œå†…å±‚åµŒå¥—çš„ç‰‡æ®µä¸å¤±æ•ˆ</p>
<figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line">&lt;%<span class="ruby"> cache product <span class="keyword">do</span> </span>%&gt;</span><br><span class="line">  &lt;%=<span class="ruby"> render product.games </span>%&gt;</span><br><span class="line">&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸Šé¢è¿™ä¸ªä¼šæ¸²æŸ“ä¸‹é¢è¿™ä¸ª</p>
<figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;%<span class="ruby"> cache game <span class="keyword">do</span> </span>%&gt;</span><br><span class="line">  &lt;%=<span class="ruby"> render game </span>%&gt;</span><br><span class="line">&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæ¸¸æˆçš„ä»»ä½•ä¸€ä¸ªå±æ€§å˜äº†ï¼Œ<code>updated_at</code> çš„å€¼ä¼šè®¾ä¸ºå½“å‰æ—¶é—´ï¼Œå› æ­¤ç¼“å­˜å¤±æ•ˆã€‚ç„¶è€Œï¼Œå•†å“å¯¹è±¡çš„ <code>updated_at</code> å±æ€§ä¸å˜ï¼Œå› æ­¤å®ƒçš„ç¼“å­˜ä¸å¤±æ•ˆï¼Œä»è€Œå¯¼è‡´åº”ç”¨ä¼ºæœè¿‡æœŸçš„æ•°æ®ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ <code>touch</code> æ–¹æ³•æŠŠæ¨¡å‹ç»‘åœ¨ä¸€èµ·</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> &lt; ApplicationRecord</span></span><br><span class="line">  has_many <span class="symbol">:games</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span> &lt; ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:product</span>, <span class="symbol">touch:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç®¡ç†ä¾èµ–"><a href="#ç®¡ç†ä¾èµ–" class="headerlink" title="ç®¡ç†ä¾èµ–"></a>ç®¡ç†ä¾èµ–</h1><p>ä¸ºäº†æ­£ç¡®åœ°è®©ç¼“å­˜å¤±æ•ˆï¼Œè¦æ­£ç¡®åœ°å®šä¹‰ç¼“å­˜ä¾èµ–ã€‚Rails è¶³å¤Ÿæ™ºèƒ½ï¼Œèƒ½å¤„ç†å¸¸è§çš„æƒ…å†µï¼Œæ— éœ€è‡ªå·±æŒ‡å®šã€‚ä½†æ˜¯æœ‰æ—¶éœ€è¦å¤„ç†è‡ªå®šä¹‰çš„è¾…åŠ©æ–¹æ³•ï¼ˆä»¥æ­¤ä¸ºä¾‹ï¼‰ï¼Œå› æ­¤è¦è‡ªè¡Œå®šä¹‰</p>
<h2 id="éšå¼ä¾èµ–"><a href="#éšå¼ä¾èµ–" class="headerlink" title="éšå¼ä¾èµ–"></a>éšå¼ä¾èµ–</h2><p>å¤šæ•°æ¨¡æ¿ä¾èµ–å¯ä»¥ä»æ¨¡æ¿ä¸­çš„ <code>render</code> è°ƒç”¨ä¸­æ¨å¯¼å‡ºæ¥ã€‚ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ <code>ActionView::Digestor</code> çŸ¥é“å¦‚ä½•è§£ç çš„ <code>render</code> è°ƒç”¨</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">render <span class="symbol">partial:</span> <span class="string">"comments/comment"</span>, <span class="symbol">collection:</span> commentable.comments</span><br><span class="line">render <span class="string">"comments/comments"</span></span><br><span class="line">render <span class="string">'comments/comments'</span></span><br><span class="line">render(<span class="string">'comments/comments'</span>)</span><br><span class="line"></span><br><span class="line">render <span class="string">"header"</span> =&gt; render(<span class="string">"comments/header"</span>)</span><br><span class="line"></span><br><span class="line">render(@topic)         <span class="comment"># =&gt; render("topics/topic")</span></span><br><span class="line">render(topics)         <span class="comment"># =&gt; render("topics/topic")</span></span><br><span class="line">render(message.topics) <span class="comment"># =&gt; render("topics/topic")</span></span><br></pre></td></tr></tbody></table></figure>
<p>è€Œå¦ä¸€æ–¹é¢ï¼Œæœ‰äº›è°ƒç”¨è¦åšä¿®æ”¹æ–¹èƒ½è®©ç¼“å­˜æ­£ç¡®å·¥ä½œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¼ å…¥è‡ªå®šä¹‰çš„é›†åˆï¼Œè¦æŠŠä¸‹è¿°ä»£ç ï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">render @project.documents.where(<span class="symbol">published:</span> <span class="literal">true</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>æ”¹ä¸º</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">render <span class="symbol">partial:</span> <span class="string">"documents/document"</span>, <span class="symbol">collection:</span> @project.documents.where(<span class="symbol">published:</span> <span class="literal">true</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ˜¾å¼ä¾èµ–"><a href="#æ˜¾å¼ä¾èµ–" class="headerlink" title="æ˜¾å¼ä¾èµ–"></a>æ˜¾å¼ä¾èµ–</h2><p>æœ‰æ—¶ï¼Œæ¨¡æ¿ä¾èµ–æ¨å¯¼ä¸å‡ºæ¥ã€‚åœ¨è¾…åŠ©æ–¹æ³•ä¸­æ¸²æŸ“æ—¶ç»å¸¸æ˜¯è¿™æ ·</p>
<figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line">&lt;%=<span class="ruby"> render_sortable_todolists @project.todolists </span>%&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>æ­¤æ—¶ï¼Œè¦ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„æ³¨é‡Šæ ¼å¼ï¼š<br></p><figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;%# Template Dependency: todolists/todolist %&gt;</span></span><br><span class="line">&lt;%=<span class="ruby"> render_sortable_todolists @project.todolists </span>%&gt;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>æŸäº›æƒ…å†µä¸‹ï¼Œä¾‹å¦‚è®¾ç½®å•è¡¨ç»§æ‰¿ï¼Œå¯èƒ½è¦æ˜¾å¼å®šä¹‰ä¸€å †ä¾èµ–ã€‚æ­¤æ—¶æ— éœ€å†™å‡ºæ¯ä¸ªæ¨¡æ¿ï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦åŒ¹é…ä¸€ä¸ªç›®å½•ä¸­çš„å…¨éƒ¨æ¨¡æ¿ï¼š<br></p><figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;%# Template Dependency: events/* %&gt;</span></span><br><span class="line">&lt;%=<span class="ruby"> render_categorizable_events @person.events </span>%&gt;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å¯¹é›†åˆç¼“å­˜æ¥è¯´ï¼Œå¦‚æœå±€éƒ¨æ¨¡æ¿ä¸æ˜¯ä»¥å¹²å‡€çš„ç¼“å­˜è°ƒç”¨å¼€å¤´ï¼Œä¾ç„¶å¯ä»¥ä½¿ç”¨é›†åˆç¼“å­˜ï¼Œä¸è¿‡è¦åœ¨æ¨¡æ¿ä¸­çš„ä»»æ„ä½ç½®æ·»åŠ ä¸€ç§æ ¼å¼ç‰¹æ®Šçš„æ³¨é‡Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;%# Template Collection: notification %&gt;</span></span><br><span class="line">&lt;%<span class="ruby"> my_helper_that_calls_cache(some_arg, notification) <span class="keyword">do</span> </span>%&gt;</span><br><span class="line">  &lt;%=<span class="ruby"> notification.name </span>%&gt;</span><br><span class="line">&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å¤–éƒ¨ä¾èµ–"><a href="#å¤–éƒ¨ä¾èµ–" class="headerlink" title="å¤–éƒ¨ä¾èµ–"></a>å¤–éƒ¨ä¾èµ–</h2><p>å¦‚æœåœ¨ç¼“å­˜çš„å—ä¸­ä½¿ç”¨è¾…åŠ©æ–¹æ³•ï¼Œè€Œåæ›´æ–°äº†è¾…åŠ©æ–¹æ³•ï¼Œè¿˜è¦æ›´æ–°ç¼“å­˜ã€‚å…·ä½“æ–¹æ³•ä¸é™ï¼Œåªè¦èƒ½æ”¹å˜æ¨¡æ¿æ–‡ä»¶çš„ MD5 å€¼å°±è¡Œã€‚æ¨èçš„æ–¹æ³•ä¹‹ä¸€æ˜¯æ·»åŠ ä¸€ä¸ªæ³¨é‡Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight erb"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;%# Helper Dependency Updated: Jul 28, 2015 at 7pm %&gt;</span></span><br><span class="line">&lt;%=<span class="ruby"> some_helper_method(person) </span>%&gt;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä½å±‚ç¼“å­˜"><a href="#ä½å±‚ç¼“å­˜" class="headerlink" title="ä½å±‚ç¼“å­˜"></a>ä½å±‚ç¼“å­˜</h1><p>æœ‰æ—¶éœ€è¦ç¼“å­˜ç‰¹å®šçš„å€¼æˆ–æŸ¥è¯¢ç»“æœï¼Œè€Œä¸æ˜¯ç¼“å­˜è§†å›¾ç‰‡æ®µã€‚Rails çš„ç¼“å­˜æœºåˆ¶èƒ½å­˜å‚¨ä»»ä½•ç±»å‹çš„ä¿¡æ¯ã€‚</p>
<p>å®ç°ä½å±‚ç¼“å­˜æœ€æœ‰æ•ˆçš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>Rails.cache.fetch</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ—¢èƒ½è¯»å–ä¹Ÿèƒ½å†™å…¥ç¼“å­˜ã€‚ä¼ å…¥å•ä¸ªå‚æ•°æ—¶ï¼Œè·å–æŒ‡å®šçš„é”®ï¼Œè¿”å›ç¼“å­˜ä¸­çš„å€¼ã€‚å¦‚æœä¼ å…¥å—ï¼Œå—ä¸­çš„ä»£ç åœ¨ç¼“å­˜ç¼ºå¤±æ—¶æ‰§è¡Œã€‚å—è¿”å›çš„å€¼å°†å†™å…¥ç¼“å­˜ï¼Œå­˜åœ¨æŒ‡å®šé”®çš„åä¸‹ï¼Œç„¶åè¿”å›é‚£ä¸ªè¿”å›å€¼ã€‚å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„å€¼ï¼Œè€Œä¸æ‰§è¡Œå—ä¸­çš„ä»£ç ã€‚</p>
<p>ä¸‹é¢ä¸¾ä¸ªä¾‹å­ã€‚åº”ç”¨ä¸­æœ‰ä¸ª <code>Product</code> æ¨¡å‹ï¼Œå®ƒæœ‰ä¸ªå®ä¾‹æ–¹æ³•ï¼Œåœ¨ç«äº‰ç½‘ç«™ä¸­æŸ¥æ‰¾å•†å“çš„ä»·æ ¼ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›çš„æ•°æ®ç‰¹åˆ«é€‚åˆä½¿ç”¨ä½å±‚ç¼“å­˜ï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> &lt; ApplicationRecord</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">competing_price</span></span></span><br><span class="line">    Rails.cache.fetch(<span class="string">"<span class="subst">#{cache_key}</span>/competing_price"</span>, <span class="symbol">expires_in:</span> <span class="number">12</span>.hours) <span class="keyword">do</span></span><br><span class="line">      Competitor::API.find_price(id)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note warning"><p>æ³¨æ„ï¼Œè¿™ä¸ªç¤ºä¾‹ä½¿ç”¨äº† <code>cache_key</code> æ–¹æ³•ï¼Œå› æ­¤å¾—åˆ°çš„ç¼“å­˜é”®ç±»ä¼¼è¿™ç§ï¼š<code>products/233-20140225082222765838000/competing_price</code>ã€‚<code>cache_key</code> æ–¹æ³•æ ¹æ®æ¨¡å‹çš„ <code>id</code> å’Œ <code>updated_at</code> å±æ€§ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¿™æ˜¯å¸¸è§çš„çº¦å®šï¼Œæœ‰ä¸ªå¥½å¤„æ˜¯ï¼Œå•†å“æ›´æ–°åç¼“å­˜è‡ªåŠ¨å¤±æ•ˆã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨ä½å±‚ç¼“å­˜ç¼“å­˜å®ä¾‹å±‚ä¿¡æ¯æ—¶ï¼Œéœ€è¦ç”Ÿæˆç¼“å­˜é”®ã€‚</p></div>
<h1 id="SQL-ç¼“å­˜"><a href="#SQL-ç¼“å­˜" class="headerlink" title="SQL ç¼“å­˜"></a>SQL ç¼“å­˜</h1><p>æŸ¥è¯¢ç¼“å­˜æ˜¯ Rails æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼ŒæŠŠå„ä¸ªæŸ¥è¯¢çš„ç»“æœé›†ç¼“å­˜èµ·æ¥ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­é‡åˆ°äº†ç›¸åŒçš„æŸ¥è¯¢ï¼ŒRails ä¼šä½¿ç”¨ç¼“å­˜çš„ç»“æœé›†ï¼Œè€Œä¸å†æ¬¡åˆ°æ•°æ®åº“ä¸­è¿è¡ŒæŸ¥è¯¢ã€‚</p>
<p>ä¾‹å¦‚ï¼š<br></p><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductsController</span> &lt; ApplicationController</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></span><br><span class="line">    <span class="comment"># è¿è¡ŒæŸ¥æ‰¾æŸ¥è¯¢</span></span><br><span class="line">    @products = Product.all</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å†æ¬¡è¿è¡Œç›¸åŒçš„æŸ¥è¯¢</span></span><br><span class="line">    @products = Product.all</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å†æ¬¡è¿è¡Œç›¸åŒçš„æŸ¥è¯¢æ—¶ï¼Œæ ¹æœ¬ä¸ä¼šå‘ç»™æ•°æ®åº“ã€‚é¦–æ¬¡è¿è¡ŒæŸ¥è¯¢å¾—åˆ°çš„ç»“æœå­˜å‚¨åœ¨æŸ¥è¯¢ç¼“å­˜ä¸­ï¼ˆå†…å­˜é‡Œï¼‰ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢ä»å†…å­˜ä¸­è·å–ã€‚</p>
<p>ç„¶è€Œè¦çŸ¥é“ï¼ŒæŸ¥è¯¢ç¼“å­˜åœ¨åŠ¨ä½œå¼€å¤´åˆ›å»ºï¼Œåˆ°åŠ¨ä½œæœ«å°¾é”€æ¯ï¼Œåªåœ¨åŠ¨ä½œçš„å­˜ç»­æ—¶é—´å†…å­˜åœ¨ã€‚å¦‚æœæƒ³æŒä¹…åŒ–å­˜å‚¨æŸ¥è¯¢ç»“æœï¼Œä½¿ç”¨ä½å±‚ç¼“å­˜ä¹Ÿèƒ½å®ç°</p>
<hr>
]]></content>
      <categories>
        <category>Rails</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
        <tag>Rails</tag>
      </tags>
  </entry>
  <entry>
    <title>Rails é¡µé¢ç¼“å­˜</title>
    <url>/2018/09/23/Rails%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<h1 id="é¡µé¢ç¼“å­˜"><a href="#é¡µé¢ç¼“å­˜" class="headerlink" title="é¡µé¢ç¼“å­˜"></a>é¡µé¢ç¼“å­˜</h1><p>é¡µé¢ç¼“å­˜æ˜¯ Rails æä¾›çš„ä¸€ç§ç¼“å­˜æœºåˆ¶ï¼Œè®© Web æœåŠ¡å™¨ï¼ˆå¦‚ Apache å’Œ NGINXï¼‰ç›´æ¥è®¿é—®é™æ€é¡µé¢ï¼Œè€Œä¸ç»ç”± Rails åŠ¨æ€ç”Ÿæˆã€‚è™½ç„¶è¿™ç§ç¼“å­˜çš„é€Ÿåº¦è¶…å¿«ï¼Œä½†æ˜¯ä¸é€‚ç”¨äºæ‰€æœ‰æƒ…å†µï¼ˆä¾‹å¦‚éœ€è¦éªŒè¯èº«ä»½çš„é¡µé¢ï¼‰ã€‚æ­¤å¤–ï¼Œå› ä¸º Web æœåŠ¡å™¨ç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿä¸­è®¿é—®æ–‡ä»¶ï¼Œæ‰€ä»¥è¦è‡ªè¡Œå®ç°ç¼“å­˜å¤±æ•ˆæœºåˆ¶</p>
<div class="note info"><p>é¡µé¢ç¼“å­˜å·²ä» Rails 4 ä¸­åˆ é™¤</p></div>
<p>é¡µé¢ç¼“å­˜ <a href="https://github.com/rails/actionpack-page_caching" target="_blank" rel="noopener">actionpack-page_caching çš„åœ°å€</a></p>
<a id="more"></a>
<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>åœ¨ Rails é¡¹ç›®ä¸­çš„ <code>Gemfile</code> æ–‡ä»¶ä¸­æ·»åŠ </p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">gem <span class="string">'actionpack-page_caching'</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åæ‰§è¡Œ <code>bundle install</code> å‘½ä»¤å®‰è£…</p>
<h1 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h1><p>è®¾ç½®ç¼“å­˜æ–‡ä»¶å­˜æ”¾ä½ç½® <code>page_cache_directory</code></p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">config.action_controller.page_cache_directory = <span class="string">"<span class="subst">#{Rails.root}</span>/public/cached_paâ€‹â€‹ges"</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹Ÿå¯ä»¥ç»™ <code>Controller</code> å•ç‹¬è®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸‰ç§æ–¹å¼</p>
<p>æŒ‡å‘ä¸€ä¸ª <code>lambda</code> è¡¨è¾¾å¼ï¼Œè¿è¡Œæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ <code>lambda</code> çš„ <code>call</code> æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeblogController</span> &lt; ApplicationController</span></span><br><span class="line">  <span class="keyword">self</span>.page_cache_directory = -&gt; { Rails.root.join(<span class="string">"public"</span>, request.domain) }</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹Ÿå¯æŒ‡å‘ä¸€ä¸ªæ–¹æ³•çš„ <code>symbol</code> å</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeblogController</span> &lt; ApplicationController</span></span><br><span class="line">  <span class="keyword">self</span>.page_cache_directory = <span class="symbol">:domain_cache_directory</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">domain_cache_directory</span></span></span><br><span class="line">      Rails.root.join(<span class="string">"public"</span>, request.domain)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹Ÿå¯ä»¥æŒ‡å‘å®ç° <code>call</code> ç±»æ–¹æ³•çš„å¯¹è±¡</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DomainCacheDirectory</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">call</span><span class="params">(request)</span></span></span><br><span class="line">    Rails.root.join(<span class="string">"public"</span>, request.domain)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeblogController</span> &lt; ApplicationController</span></span><br><span class="line">  <span class="keyword">self</span>.page_cache_directory = DomainCacheDirectory</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><h2 id="è®¾ç½®-1"><a href="#è®¾ç½®-1" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h2><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeblogController</span> &lt; ActionController::Base</span></span><br><span class="line">  caches_page <span class="symbol">:show</span>, <span class="symbol">:new</span> <span class="comment"># è®¾ç½®newå’Œshowé¡µé¢ç¼“å­˜</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç”Ÿæˆpublic/cached_paâ€‹â€‹ges/weblog/new.html</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">new</span></span></span><br><span class="line">    @list = List.new</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç”Ÿæˆpublic/cached_paâ€‹â€‹ges/weblog/:id.html</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    @list = List.find(params[<span class="symbol">:id</span>])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ›´æ–°é¡µé¢ç¼“å­˜"><a href="#æ›´æ–°é¡µé¢ç¼“å­˜" class="headerlink" title="æ›´æ–°é¡µé¢ç¼“å­˜"></a>æ›´æ–°é¡µé¢ç¼“å­˜</h2><p>æ•°æ®æ›´æ–°åï¼Œå°†å·²ç”Ÿæˆçš„é¡µé¢ç¼“å­˜è¿‡æœŸ</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeblogController</span> &lt; ActionController::Base</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update</span></span></span><br><span class="line">    List.update(params[<span class="symbol">:list</span>][<span class="symbol">:id</span>], params[<span class="symbol">:list</span>])</span><br><span class="line">    <span class="comment"># è®¾ç½®public/cached_paâ€‹â€‹ges/weblog/:id.htmlå·²è¿‡æœŸ</span></span><br><span class="line">    expire_page <span class="symbol">action:</span> <span class="string">'show'</span>, <span class="symbol">id:</span> params[<span class="symbol">:list</span>][<span class="symbol">:id</span>]</span><br><span class="line">    <span class="comment"># è·³è½¬åˆ°showï¼Œç”Ÿæˆæ–°çš„public/cached_paâ€‹â€‹ges/weblog/:id.html</span></span><br><span class="line">    redirect_to <span class="symbol">action:</span> <span class="string">'show'</span>, <span class="symbol">id:</span> params[<span class="symbol">:list</span>][<span class="symbol">:id</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Nginxé…ç½®"><a href="#Nginxé…ç½®" class="headerlink" title="Nginxé…ç½®"></a>Nginx é…ç½®</h2><p>å¦‚æœé¡µé¢ç¼“å­˜æ–‡ä»¶å­˜åœ¨ï¼Œå°†é¡µé¢ç¼“å­˜ä½œä¸ºå“åº”å†…å®¹è¿”å›</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Index HTML Files</span></span><br><span class="line"><span class="attribute">if</span> (-f <span class="variable">$document_root</span>/cached_paâ€‹â€‹ges/<span class="variable">$uri</span>/index.html) {</span><br><span class="line">  <span class="attribute">rewrite</span> (.*) /cached_paâ€‹â€‹ges/<span class="variable">$1</span>/index.html <span class="literal">break</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># Other HTML Files</span></span><br><span class="line"><span class="attribute">if</span> (-f <span class="variable">$document_root</span>/cached_paâ€‹â€‹ges/<span class="variable">$uri</span>.html) {</span><br><span class="line">  <span class="attribute">rewrite</span> (.*) /cached_paâ€‹â€‹ges/<span class="variable">$1</span>.html <span class="literal">break</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># All</span></span><br><span class="line"><span class="attribute">if</span> (-f <span class="variable">$document_root</span>/cached_paâ€‹â€‹ges/<span class="variable">$uri</span>) {</span><br><span class="line">  <span class="attribute">rewrite</span> (.*) /cached_paâ€‹â€‹ges/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Rails</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
        <tag>Rails</tag>
      </tags>
  </entry>
  <entry>
    <title>Rails ç¼“å­˜å­˜å‚¨å™¨</title>
    <url>/2018/09/26/Rails%E7%BC%93%E5%AD%98%E5%AD%98%E5%82%A8%E5%99%A8/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>Rails ä¸ºå­˜å‚¨ç¼“å­˜æ•°æ®ï¼ˆSQL ç¼“å­˜å’Œé¡µé¢ç¼“å­˜é™¤å¤–ï¼‰æä¾›äº†ä¸åŒçš„å­˜å‚¨å™¨ã€‚</p>
</blockquote>
<p><a href="https://ruby-china.github.io/rails-guides/caching_with_rails.html#cache-stores" target="_blank" rel="noopener">åŸæ–‡åœ°å€</a></p>
<a id="more"></a>
<h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><p><code>config.cache_store</code> é…ç½®é€‰é¡¹ç”¨äºè®¾å®šåº”ç”¨çš„é»˜è®¤ç¼“å­˜å­˜å‚¨å™¨ã€‚å¯ä»¥è®¾å®šå…¶ä»–å‚æ•°ï¼Œä¼ ç»™ç¼“å­˜å­˜å‚¨å™¨çš„æ„é€ æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">config.cache_store = <span class="symbol">:memory_store</span>, { <span class="symbol">size:</span> <span class="number">64</span>.megabytes }</span><br></pre></td></tr></tbody></table></figure>
<div class="note warning"><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥åœ¨é…ç½®å—å¤–éƒ¨è°ƒç”¨ <code>ActionController::Base.cache_store</code>ã€‚</p></div>
<p>ç¼“å­˜å­˜å‚¨å™¨é€šè¿‡ <code>Rails.cache</code> è®¿é—®ã€‚</p>
<h1 id="ActiveSupport-Cache-Store"><a href="#ActiveSupport-Cache-Store" class="headerlink" title="ActiveSupport::Cache::Store"></a>ActiveSupport::Cache::Store</h1><p>è¿™ä¸ªç±»æ˜¯åœ¨ Rails ä¸­ä¸ç¼“å­˜äº¤äº’çš„åŸºç¡€ã€‚è¿™æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ã€‚ä½ å¿…é¡»æ ¹æ®å­˜å‚¨å™¨å¼•æ“å…·ä½“å®ç°è¿™ä¸ªç±»ã€‚Rails æä¾›äº†å‡ ä¸ªå®ç°ï¼Œè¯´æ˜å¦‚ä¸‹ã€‚</p>
<p>ä¸»è¦è°ƒç”¨çš„æ–¹æ³•æœ‰ <code>read</code>ã€<code>write</code>ã€<code>delete</code>ã€<code>exist?</code> å’Œ <code>fetch</code>ã€‚<code>fetch</code> æ–¹æ³•æ¥å—ä¸€ä¸ªå—ï¼Œè¿”å›ç¼“å­˜ä¸­ç°æœ‰çš„å€¼ï¼Œæˆ–è€…æŠŠæ–°å€¼å†™å…¥ç¼“å­˜ã€‚</p>
<p>æ‰€æœ‰ç¼“å­˜å®ç°æœ‰äº›å…±ç”¨çš„é€‰é¡¹ï¼Œå¯ä»¥ä¼ ç»™æ„é€ æ–¹æ³•ï¼Œæˆ–è€…ä¼ ç»™ä¸ç¼“å­˜æ¡ç›®äº¤äº’çš„å„ä¸ªæ–¹æ³•ã€‚</p>
<ul>
<li><code>:namespace</code>ï¼šåœ¨ç¼“å­˜å­˜å‚¨å™¨ä¸­åˆ›å»ºå‘½åç©ºé—´ã€‚å¦‚æœä¸å…¶ä»–åº”ç”¨å…±ç”¨åŒä¸€ä¸ªç¼“å­˜å­˜å‚¨å™¨ï¼Œè¿™ä¸ªé€‰é¡¹ç‰¹åˆ«æœ‰ç”¨ã€‚</li>
<li><code>:compress</code>ï¼šæŒ‡å®šå‹ç¼©ç¼“å­˜ã€‚é€šè¿‡ç¼“æ…¢çš„ç½‘ç»œä¼ è¾“å¤§é‡ç¼“å­˜æ—¶ç”¨å¾—ç€ã€‚</li>
<li><code>:compress_threshold</code>ï¼šä¸ <code>:compress</code> é€‰é¡¹æ­é…ä½¿ç”¨ï¼ŒæŒ‡å®šä¸€ä¸ªé˜ˆå€¼ï¼Œæœªè¾¾åˆ°æ—¶ä¸å‹ç¼©ç¼“å­˜ã€‚é»˜è®¤ä¸º 16 åƒå­—èŠ‚ã€‚</li>
<li><code>:expires_in</code>ï¼šä¸ºç¼“å­˜æ¡ç›®è®¾å®šå¤±æ•ˆæ—¶é—´ï¼ˆç§’æ•°ï¼‰ï¼Œå¤±æ•ˆåè‡ªåŠ¨ä»ç¼“å­˜ä¸­åˆ é™¤ã€‚</li>
<li><code>:race_condition_ttl</code>ï¼šä¸ <code>:expires_in</code> é€‰é¡¹æ­é…ä½¿ç”¨ã€‚é¿å…å¤šä¸ªè¿›ç¨‹åŒæ—¶é‡æ–°ç”Ÿæˆç›¸åŒçš„ç¼“å­˜æ¡ç›®ï¼ˆä¹Ÿå« dog pile effectï¼‰ï¼Œé˜²æ­¢è®©ç¼“å­˜æ¡ç›®è¿‡æœŸæ—¶å‡ºç°æ¡ä»¶ç«äº‰ã€‚è¿™ä¸ªé€‰é¡¹è®¾å®šåœ¨é‡æ–°ç”Ÿæˆæ–°å€¼æ—¶å¤±æ•ˆçš„æ¡ç›®è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨å¤šä¹…ï¼ˆç§’æ•°ï¼‰ã€‚å¦‚æœä½¿ç”¨ <code>:expires_in</code> é€‰é¡¹ï¼Œæœ€å¥½ä¹Ÿè®¾å®šè¿™ä¸ªé€‰é¡¹ã€‚</li>
</ul>
<h3 id="è‡ªå®šä¹‰ç¼“å­˜å­˜å‚¨å™¨"><a href="#è‡ªå®šä¹‰ç¼“å­˜å­˜å‚¨å™¨" class="headerlink" title="è‡ªå®šä¹‰ç¼“å­˜å­˜å‚¨å™¨"></a>è‡ªå®šä¹‰ç¼“å­˜å­˜å‚¨å™¨</h3><p>ç¼“å­˜å­˜å‚¨å™¨å¯ä»¥è‡ªå·±å®šä¹‰ï¼Œåªéœ€æ‰©å±• <code>ActiveSupport::Cache::Store</code> ç±»ï¼Œå®ç°ç›¸åº”çš„æ–¹æ³•ã€‚è¿™æ ·ï¼Œä½ å¯ä»¥æŠŠä»»ä½•ç¼“å­˜æŠ€æœ¯å¸¦åˆ°ä½ çš„ Rails åº”ç”¨ä¸­ã€‚</p>
<p>è‹¥æƒ³ä½¿ç”¨è‡ªå®šä¹‰çš„ç¼“å­˜å­˜å‚¨å™¨ï¼Œåªéœ€æŠŠ <code>cache_store</code> è®¾ä¸ºè‡ªå®šä¹‰ç±»çš„å®ä¾‹ï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">config.cache_store = MyCacheStore.new</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ActiveSupport-Cache-MemoryStore"><a href="#ActiveSupport-Cache-MemoryStore" class="headerlink" title="ActiveSupport::Cache::MemoryStore"></a>ActiveSupport::Cache::MemoryStore</h1><p>è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨æŠŠç¼“å­˜æ¡ç›®æ”¾åœ¨å†…å­˜ä¸­ï¼Œä¸ Ruby è¿›ç¨‹æ”¾åœ¨ä¸€èµ·ã€‚å¯ä»¥æŠŠ<code>:size</code> é€‰é¡¹ä¼ ç»™æ„é€ æ–¹æ³•ï¼ŒæŒ‡å®šç¼“å­˜çš„å¤§å°é™åˆ¶ï¼ˆé»˜è®¤ä¸º <code>32Mb</code>ï¼‰ã€‚è¶…è¿‡åˆ†é…çš„å¤§å°åï¼Œä¼šæ¸…ç†ç¼“å­˜ï¼ŒæŠŠæœ€ä¸å¸¸ç”¨çš„æ¡ç›®åˆ é™¤ã€‚</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">config.cache_store = <span class="symbol">:memory_store</span>, { <span class="symbol">size:</span> <span class="number">64</span>.megabytes }</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœè¿è¡Œå¤šä¸ª Ruby on Rails æœåŠ¡å™¨è¿›ç¨‹ï¼ˆä¾‹å¦‚ä½¿ç”¨ Phusion Passenger æˆ– Puma é›†ç¾¤æ¨¡å¼ï¼‰ï¼Œå„ä¸ªå®ä¾‹ä¹‹é—´æ— æ³•å…±äº«ç¼“å­˜æ•°æ®ã€‚è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨ä¸é€‚åˆå¤§å‹åº”ç”¨ä½¿ç”¨ã€‚ä¸è¿‡ï¼Œé€‚åˆåªæœ‰å‡ ä¸ªæœåŠ¡å™¨è¿›ç¨‹çš„ä½æµé‡å°å‹åº”ç”¨ä½¿ç”¨ï¼Œä¹Ÿé€‚åˆåœ¨å¼€å‘ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨</p>
<h1 id="ActiveSupport-Cache-FileStore"><a href="#ActiveSupport-Cache-FileStore" class="headerlink" title="ActiveSupport::Cache::FileStore"></a>ActiveSupport::Cache::FileStore</h1><p>è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç¼“å­˜æ¡ç›®ã€‚åˆå§‹åŒ–è¿™ä¸ªå­˜å‚¨å™¨æ—¶ï¼Œå¿…é¡»æŒ‡å®šå­˜å‚¨æ–‡ä»¶çš„ç›®å½•ï¼š</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">config.cache_store = <span class="symbol">:file_store</span>, <span class="string">"/path/to/cache/directory"</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨æ—¶ï¼Œåœ¨åŒä¸€å°ä¸»æœºä¸­è¿è¡Œçš„å¤šä¸ªæœåŠ¡å™¨è¿›ç¨‹å¯ä»¥å…±äº«ç¼“å­˜ã€‚è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨é€‚åˆä¸€åˆ°ä¸¤ä¸ªä¸»æœºçš„ä¸­ä½æµé‡ç½‘ç«™ä½¿ç”¨ã€‚è¿è¡Œåœ¨ä¸åŒä¸»æœºä¸­çš„å¤šä¸ªæœåŠ¡å™¨è¿›ç¨‹è‹¥æƒ³å…±äº«ç¼“å­˜ï¼Œå¯ä»¥ä½¿ç”¨å…±äº«çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯ä¸å»ºè®®è¿™ä¹ˆåšã€‚</p>
<p>ç¼“å­˜é‡ä¸€ç›´å¢åŠ ï¼Œç›´åˆ°å¡«æ»¡ç£ç›˜ï¼Œæ‰€ä»¥å»ºè®®ä½ å®šæœŸæ¸…ç†æ—§ç¼“å­˜æ¡ç›®ã€‚</p>
<p>è¿™æ˜¯é»˜è®¤çš„ç¼“å­˜å­˜å‚¨å™¨</p>
<h1 id="ActiveSupport-Cache-MemCacheStore"><a href="#ActiveSupport-Cache-MemCacheStore" class="headerlink" title="ActiveSupport::Cache::MemCacheStore"></a>ActiveSupport::Cache::MemCacheStore</h1><p>è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨ä½¿ç”¨ Danga çš„ <code>memcached</code> æœåŠ¡å™¨ä¸ºåº”ç”¨æä¾›ä¸­å¿ƒåŒ–ç¼“å­˜ã€‚Rails é»˜è®¤ä½¿ç”¨è‡ªå¸¦çš„ <code>dalli</code> gemã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„ç½‘ç«™ç›®å‰æœ€å¸¸ä½¿ç”¨çš„ç¼“å­˜å­˜å‚¨å™¨ã€‚é€šè¿‡å®ƒå¯ä»¥å®ç°å•ä¸ªå…±äº«çš„ç¼“å­˜é›†ç¾¤ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œæœ‰è¾ƒå¥½çš„å†—ä½™ã€‚</p>
<p>åˆå§‹åŒ–è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨æ—¶ï¼Œè¦æŒ‡å®šé›†ç¾¤ä¸­æ‰€æœ‰ <code>memcached</code> æœåŠ¡å™¨çš„åœ°å€ã€‚å¦‚æœä¸æŒ‡å®šï¼Œå‡å®š <code>memcached</code> è¿è¡Œåœ¨æœ¬åœ°çš„é»˜è®¤ç«¯å£ä¸Šï¼Œä½†æ˜¯å¯¹å¤§å‹ç½‘ç«™æ¥è¯´ï¼Œè¿™æ ·åšå¹¶ä¸å¥½ã€‚</p>
<p>è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨çš„ <code>write</code> å’Œ <code>fetch</code> æ–¹æ³•æ¥å—ä¸¤ä¸ªé¢å¤–çš„é€‰é¡¹ï¼Œä»¥ä¾¿åˆ©ç”¨ <code>memcached</code> çš„ç‹¬æœ‰ç‰¹æ€§ã€‚æŒ‡å®š<code>:raw</code> æ—¶ï¼Œç›´æ¥æŠŠå€¼å‘ç»™æœåŠ¡å™¨ï¼Œä¸åšåºåˆ—åŒ–ã€‚å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²æˆ–æ•°å­—ã€‚<code>memcached</code> çš„ç›´æ¥æ“ä½œï¼Œå¦‚ <code>increment</code> å’Œ <code>decrement</code>ï¼Œåªèƒ½ç”¨äºåŸå§‹å€¼ã€‚è¿˜å¯ä»¥æŒ‡å®š<code>:unless_exist</code> é€‰é¡¹ï¼Œä¸è®© <code>memcached</code> è¦†ç›–ç°æœ‰æ¡ç›®ã€‚</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">config.cache_store = <span class="symbol">:mem_cache_store</span>, <span class="string">"cache-1.example.com"</span>, <span class="string">"cache-2.example.com"</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ActiveSupport-Cache-NullStore"><a href="#ActiveSupport-Cache-NullStore" class="headerlink" title="ActiveSupport::Cache::NullStore"></a>ActiveSupport::Cache::NullStore</h1><p>è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨åªåº”è¯¥åœ¨å¼€å‘æˆ–æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå®ƒå¹¶ä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ã€‚åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå¦‚æœä»£ç ç›´æ¥ä¸ <code>Rails.cache</code> äº¤äº’ï¼Œä½†æ˜¯ç¼“å­˜å¯èƒ½å¯¹ä»£ç çš„ç»“æœæœ‰å½±å“ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨ã€‚åœ¨è¿™ä¸ªç¼“å­˜å­˜å‚¨å™¨ä¸Šè°ƒç”¨ <code>fetch</code> å’Œ <code>read</code> æ–¹æ³•ä¸è¿”å›ä»»ä½•å€¼ã€‚</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">config.cache_store = <span class="symbol">:null_store</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç¼“å­˜é”®"><a href="#ç¼“å­˜é”®" class="headerlink" title="ç¼“å­˜é”®"></a>ç¼“å­˜é”®</h1><p>ç¼“å­˜ä¸­ä½¿ç”¨çš„é”®å¯ä»¥æ˜¯èƒ½å“åº” <code>cache_key</code> æˆ– <code>to_param</code> æ–¹æ³•çš„ä»»ä½•å¯¹è±¡ã€‚å¦‚æœæƒ³å®šåˆ¶ç”Ÿæˆé”®çš„æ–¹å¼ï¼Œå¯ä»¥è¦†ç›– <code>cache_key</code> æ–¹æ³•ã€‚Active Record æ ¹æ®ç±»åå’Œè®°å½• ID ç”Ÿæˆç¼“å­˜é”®ã€‚</p>
<p>ç¼“å­˜é”®çš„å€¼å¯ä»¥æ˜¯æ•£åˆ—æˆ–æ•°ç»„ï¼š<br></p><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># è¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç¼“å­˜é”®</span></span><br><span class="line">Rails.cache.read(<span class="symbol">site:</span> <span class="string">"mysite"</span>, <span class="symbol">owners:</span> [owner_1, owner_2])</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>Rails.cache</code> ä½¿ç”¨çš„é”®ä¸å­˜å‚¨å¼•æ“ä½¿ç”¨çš„å¹¶ä¸ç›¸åŒï¼Œå­˜å‚¨å¼•æ“ä½¿ç”¨çš„é”®å¯èƒ½å«æœ‰å‘½åç©ºé—´ï¼Œæˆ–è€…æ ¹æ®åç«¯çš„é™åˆ¶åšè°ƒæ•´ã€‚è¿™æ„å‘³ç€ï¼Œä½¿ç”¨ <code>Rails.cache</code> å­˜å‚¨å€¼æ—¶ä½¿ç”¨çš„é”®å¯èƒ½æ— æ³•ç”¨äºä¾› <code>dalli</code> gem è·å–ç¼“å­˜æ¡ç›®ã€‚ç„¶è€Œï¼Œä½ ä¹Ÿæ— éœ€æ‹…å¿ƒä¼šè¶…å‡º <code>memcached</code> çš„å¤§å°é™åˆ¶ï¼Œæˆ–è€…è¿èƒŒå¥æ³•è§„åˆ™</p>
<hr>
]]></content>
      <categories>
        <category>Rails</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
        <tag>Rails</tag>
      </tags>
  </entry>
  <entry>
    <title>Ruby ä¸­çš„ includeï¼Œextend ä¸ prepend</title>
    <url>/2018/09/30/Ruby%E4%B8%AD%E7%9A%84include%EF%BC%8Cextend%E4%B8%8Eprepend/</url>
    <content><![CDATA[<h1 id="include-extend-prepend"><a href="#include-extend-prepend" class="headerlink" title="include, extend, prepend"></a>include, extend, prepend</h1><p>å‚è€ƒåœ°å€ï¼š<a href="https://ruby-china.org/topics/21501" target="_blank" rel="noopener">ruby include extend prepend ä½¿ç”¨æ–¹æ³•</a><br><a id="more"></a><br></p><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">A</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    puts <span class="string">'a method'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">aa_method</span></span></span><br><span class="line">    puts <span class="string">'aa method'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">B</span></span></span><br><span class="line">  extend A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">C</span></span></span><br><span class="line">  <span class="keyword">include</span> A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span></span></span><br><span class="line">  extend A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BB</span></span></span><br><span class="line">  <span class="keyword">include</span> A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CC</span></span></span><br><span class="line">  prepend A</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    puts <span class="string">'a method in CC'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">B.ancestors <span class="comment"># =&gt; [B]</span></span><br><span class="line">C.ancestors <span class="comment"># =&gt; [C, A]</span></span><br><span class="line">AA.ancestors <span class="comment"># =&gt; [AA, Object, Kernel, BasicObject]</span></span><br><span class="line">BB.ancestors <span class="comment"># =&gt; [BB, A, Object, Kernel, BasicObject]</span></span><br><span class="line">CC.ancestors <span class="comment"># =&gt; [A, CC, Object, Kernel, BasicObject]</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>BB å°†æ–°å¢ä¸€ä¸ªç±»æ–¹æ³•ï¼ŒAA çš„ç¥–å…ˆé“¾ä¸­æ²¡æœ‰ A<br>CC å°†æ–°å¢ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼ŒBB çš„ç¥–å…ˆé“¾ä¸­æœ‰ A</p>
<p>Ruby <code>prepend</code> ä¸ <code>include</code> ç±»ä¼¼ï¼Œé¦–å…ˆéƒ½æ˜¯æ·»åŠ å®ä¾‹æ–¹æ³•çš„ï¼Œä¸åŒçš„æ˜¯æ‰©å±• module åœ¨ç¥–å…ˆé“¾ä¸Šçš„æ”¾ç½®ä½ç½®ä¸åŒ</p>
<h1 id="å½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œ-Rubyæ˜¯å¦‚ä½•æ‰¾åˆ°æ–¹æ³•å®šä¹‰çš„"><a href="#å½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œ-Rubyæ˜¯å¦‚ä½•æ‰¾åˆ°æ–¹æ³•å®šä¹‰çš„" class="headerlink" title="å½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œ Rubyæ˜¯å¦‚ä½•æ‰¾åˆ°æ–¹æ³•å®šä¹‰çš„"></a>å½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œ Ruby æ˜¯å¦‚ä½•æ‰¾åˆ°æ–¹æ³•å®šä¹‰çš„</h1><ol>
<li>å®ä¾‹æ–¹æ³•ï¼Œé¦–å…ˆåœ¨å®ä¾‹ä¸­æŸ¥æ‰¾ï¼Œç„¶åå†å®ä¾‹å¯¹è±¡çš„å•ä»¶ç±»ä¸­æŸ¥æ‰¾ï¼Œä¹‹åæ²¿ç¥–å…ˆé“¾ä¾æ¬¡å‘ä¸Šæ‰¾</li>
<li>ç±»æ–¹æ³•ï¼Œé¦–å…ˆåœ¨ç±»çš„å•ä»¶ç±»ä¸­æŸ¥æ‰¾ï¼Œç„¶åæ²¿ç€ç±»çš„å•ä»¶ç±»çš„ç¥–å…ˆé“¾ä¸€æ¬¡å‘ä¸Šæ‰¾ï¼ˆç±»çš„å•ä»¶ç±»çš„ç¥–å…ˆé“¾ = ç±»çš„ç¥–å…ˆé“¾çš„å„ä¸ªèŠ‚ç‚¹çš„å•ä»¶ç±»ç»„æˆçš„é“¾ï¼‰</li>
</ol>
<hr>
]]></content>
      <categories>
        <category>Ruby</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
      </tags>
  </entry>
  <entry>
    <title>Ruby ä¸­çš„é’©å­æ–¹æ³•</title>
    <url>/2018/09/29/Ruby%E4%B8%AD%E7%9A%84%E9%92%A9%E5%AD%90%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>é’©å­æ–¹æ³•æä¾›äº†ä¸€ç§æ–¹å¼ç”¨äºåœ¨ç¨‹åºè¿è¡Œæ—¶æ‰©å±•ç¨‹åºçš„è¡Œä¸º</p>
</blockquote>
<p>å‚è€ƒåœ°å€ï¼š<a href="https://ruby-china.org/topics/25397" target="_blank" rel="noopener">Ruby ä¸­ä¸€äº›é‡è¦çš„é’©å­æ–¹æ³•</a></p>
<a id="more"></a>
<h1 id="included"><a href="#included" class="headerlink" title="included"></a>included</h1><p><code>included</code> æ–¹æ³•æ˜¯åŸºäº <code>include</code> çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ä¸€äº› <code>module</code> æˆ–è€… <code>class</code> ä¸­ <code>include</code> äº†ä¸€ä¸ª <code>module</code> æ—¶å®ƒä¼šè¢«è°ƒç”¨ã€‚å®é™…åœ¨æ‰§è¡Œ <code>included</code> ä¹‹å‰ï¼Œæ¨¡å—ä¸­çš„ <code>append_features</code> è¢«è°ƒç”¨å¹¶æ‰§è¡Œå…·ä½“çš„ <code>include</code> æ“ä½œï¼Œæ³¨æ„ä½¿ç”¨æ—¶ä¸è¦éšæ„è¦†ç›– Ruby çš„ <code>append_features</code> æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></span><br><span class="line">    puts <span class="string">"<span class="subst">#{base}</span> included <span class="subst">#{<span class="keyword">self</span>}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    puts <span class="string">"a_method in M"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># =&gt; "C included M"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">O</span></span></span><br><span class="line">  <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># =&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>å½“æ‰§è¡Œ <code>include M</code> æ—¶ï¼ŒM ä¸­çš„ <code>included</code> æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨ï¼Œ<code>base</code> æ—¢æ˜¯æ‰§è¡Œ <code>include</code> æ—¶åŒ…å«è¯¥ <code>module</code> çš„ç±»å</p>
<h1 id="extended"><a href="#extended" class="headerlink" title="extended"></a>extended</h1><p>æ‰©å±• (extend) ä¸€ä¸ªæ¨¡å—ï¼Œè¿™ä¸ åŒ…å« (<code>include</code>) æœ‰ç‚¹ä¸åŒã€‚ <code>extend</code> æ˜¯å°†å®šä¹‰åœ¨ æ¨¡å— (module) å†…çš„æ–¹æ³•åº”ç”¨ä¸ºç±»çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯å®ä¾‹çš„æ–¹æ³•ï¼Œ<code>extended</code> å°±æ˜¯ <code>extend</code> ç›¸å¯¹åº”çš„é’©å­æ–¹æ³•ï¼Œæ³¨æ„ä½¿ç”¨æ—¶ä¸è¦éšæ„è¦†ç›– Ruby çš„ <code>extend_object</code> æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">extended</span><span class="params">(base)</span></span></span><br><span class="line">    puts <span class="string">"<span class="subst">#{base}</span> extended <span class="subst">#{<span class="keyword">self</span>}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    puts <span class="string">"a_method in M"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  extend M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># =&gt; "C extended M"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">O</span></span></span><br><span class="line">  extend M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># =&gt; "O extended M"</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="prepended"><a href="#prepended" class="headerlink" title="prepended"></a>prepended</h1><p><code>prepend</code> æ˜¯åœ¨ Ruby 2.0 ä¸­å¼•å…¥çš„ï¼Œå¹¶ä¸”ä¸ <code>include</code> å’Œ <code>extend</code> å¾ˆä¸ä¸€æ ·ã€‚ ä½¿ç”¨ <code>include</code> å’Œ <code>extend</code> å¼•å…¥çš„æ–¹æ³•å¯ä»¥è¢«ç›®æ ‡æ¨¡å— / ç±»é‡æ–°å®šä¹‰è¦†ç›–ï¼Œè€Œ <code>prepend</code> æ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒä¼šå°† <code>prepend</code> å¼•å…¥çš„æ¨¡å— ä¸­çš„æ–¹æ³•è¦†ç›–æ‰æˆ‘ä»¬æ¨¡å— / ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œ<code>prepended</code> å°±æ˜¯ <code>prepend</code> çš„é’©å­æ–¹æ³•ï¼Œæ³¨æ„ä½¿ç”¨æ—¶ä¸è¦éšæ„è¦†ç›– Ruby çš„ <code>prepend_features</code> æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">prepended</span><span class="params">(base)</span></span></span><br><span class="line">    puts <span class="string">"<span class="subst">#{base}</span> prepended to <span class="subst">#{<span class="keyword">self</span>}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    puts <span class="string">"a_method in M"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  prepend M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># =&gt; "C prepended to M"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">O</span></span></span><br><span class="line">  prepend M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># =&gt; "O prepended to M"</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="inherited"><a href="#inherited" class="headerlink" title="inherited"></a>inherited</h1><p>ç»§æ‰¿æ˜¯é¢å‘å¯¹è±¡ä¸­ä¸€ä¸ªæœ€é‡è¦çš„æ¦‚å¿µã€‚Ruby æ˜¯ä¸€é—¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¹¶ä¸”æä¾›äº†ä»åŸº / çˆ¶ç±»ç»§æ‰¿ä¸€ä¸ªå­ç±»çš„åŠŸèƒ½ï¼Œ<code>inherited</code> å°±æ˜¯ç»§æ‰¿çš„é’©å­æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">inherited</span><span class="params">(base)</span></span></span><br><span class="line">    puts <span class="string">"<span class="subst">#{base}</span> inherits <span class="subst">#{<span class="keyword">self</span>}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    puts <span class="string">"a_method in M"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &lt; M;</span> <span class="keyword">end</span></span><br><span class="line"><span class="comment"># =&gt; "C inherits M"</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="methodçš„é’©å­æ–¹æ³•"><a href="#methodçš„é’©å­æ–¹æ³•" class="headerlink" title="methodçš„é’©å­æ–¹æ³•"></a>method çš„é’©å­æ–¹æ³•</h1><p>å®šä¹‰ï¼Œåˆ é™¤ï¼Œå–æ¶ˆå½“å‰ç±»ä¸­å®šä¹‰çš„æ–¹æ³•æ—¶ä¼šè§¦å‘ç±»æˆ–è€…å•ä¾‹ç±»çš„ç›¸å¯¹åº”çš„é’©å­æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method_added</span><span class="params">(method_name)</span></span></span><br><span class="line">    puts <span class="string">"Adding <span class="subst">#{method_name.inspect}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method_removed</span><span class="params">(method_name)</span></span></span><br><span class="line">    puts <span class="string">"Removing <span class="subst">#{method_name.inspect}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method_undefined</span><span class="params">(method_name)</span></span></span><br><span class="line">    puts <span class="string">"Undefined <span class="subst">#{method_name.inspect}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è§¦å‘singleton_method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">singleton_method_added</span><span class="params">(method_name)</span></span></span><br><span class="line">    puts <span class="string">"Adding singleton <span class="subst">#{method_name.inspect}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è§¦å‘singleton_method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">singleton_method_removed</span><span class="params">(method_name)</span></span></span><br><span class="line">    puts <span class="string">"Removing singleton <span class="subst">#{method_name.inspect}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è§¦å‘singleton_method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">singleton_method_undefined</span><span class="params">(method_name)</span></span></span><br><span class="line">    puts <span class="string">"Undefined singleton <span class="subst">#{method_name.inspect}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è§¦å‘singleton_method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">singleton_class_method_added</span><span class="params">()</span></span>; <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># è§¦å‘method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">class_method_added</span><span class="params">()</span></span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è§¦å‘singleton_method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">singleton_class_method_removed</span><span class="params">()</span></span>; <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># è§¦å‘method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">class_method_removed</span><span class="params">()</span></span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è§¦å‘singleton_method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">singleton_class_method_undefined</span><span class="params">()</span></span>; <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># è§¦å‘method_addedé’©å­æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">class_method_undefined</span><span class="params">()</span></span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">    <span class="comment"># è§¦å‘singleton_method_removedé’©å­æ–¹æ³•</span></span><br><span class="line">    remove_method <span class="symbol">:singleton_class_method_removed</span></span><br><span class="line">    <span class="comment"># è§¦å‘singleton_method_undefinedé’©å­æ–¹æ³•</span></span><br><span class="line">    undef_method <span class="symbol">:singleton_class_method_undefined</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># è§¦å‘method_removedé’©å­æ–¹æ³•</span></span><br><span class="line">  remove_method <span class="symbol">:class_method_removed</span></span><br><span class="line">  <span class="comment"># è§¦å‘method_undefinedé’©å­æ–¹æ³•</span></span><br><span class="line">  undef_method <span class="symbol">:class_method_undefined</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Adding singleton :singleton_method_added</span></span><br><span class="line"><span class="comment"># Adding singleton :singleton_method_removed</span></span><br><span class="line"><span class="comment"># Adding singleton :singleton_method_undefined</span></span><br><span class="line"><span class="comment"># Adding singleton :singleton_class_method_added</span></span><br><span class="line"><span class="comment"># Adding :class_method_added</span></span><br><span class="line"><span class="comment"># Adding singleton :singleton_class_method_removed</span></span><br><span class="line"><span class="comment"># Adding :class_method_removed</span></span><br><span class="line"><span class="comment"># Adding singleton :singleton_class_method_undefined</span></span><br><span class="line"><span class="comment"># Adding :class_method_undefined</span></span><br><span class="line"><span class="comment"># Removing singleton :singleton_class_method_removed</span></span><br><span class="line"><span class="comment"># Undefined singleton :singleton_class_method_undefined</span></span><br><span class="line"><span class="comment"># Removing :class_method_removed</span></span><br><span class="line"><span class="comment"># Undefined :class_method_undefined</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Ruby</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
      </tags>
  </entry>
  <entry>
    <title>Ruby çš„ loadï¼Œrequire, autoload</title>
    <url>/2018/10/01/Ruby%E7%9A%84load%EF%BC%8Crequire-autoload/</url>
    <content><![CDATA[<!-- * åŠ è½½å…¶ä»–æ–‡ä»¶ -->
<p>å‚è€ƒåœ°å€ï¼š<a href="https://ruby-china.org/topics/35350" target="_blank" rel="noopener">Ruby ä¸­ require,load,autoload,extend,include,prepend çš„åŒºåˆ«</a></p>
<h1 id="load-filename-wrap-false-gt-true"><a href="#load-filename-wrap-false-gt-true" class="headerlink" title="load(filename, wrap=false) # => true"></a>load(filename, wrap=false) # =&gt; true</h1><p>æ¯æ¬¡è°ƒç”¨éƒ½ä¼šåŠ è½½å¹¶æ‰§è¡Œæ–‡ä»¶æ–‡ä»¶åä¸­çš„ Ruby ç¨‹åºã€‚å¦‚æœè¯¥æ–‡ä»¶ä¸åœ¨ç»å¯¹è·¯å¾„ä¸­ï¼Œåˆ™åœ¨ <code>$:</code> ä¸­æŸ¥æ‰¾è¯¥æ–‡ä»¶ã€‚å¦‚æœ <code>wrap</code> å‚æ•°ä¸º <code>true</code>ï¼Œåˆ™åŠ è½½è„šæœ¬åœ¨åŒ¿åæ¨¡å—ä¸‹æ‰§è¡Œï¼Œä»è€Œä¿æŠ¤è°ƒç”¨ç¨‹åºçš„å…¨å±€åç§°ç©ºé—´ã€‚ä»»ä½•æƒ…å†µä¸‹ï¼ŒåŠ è½½æ–‡ä»¶ä¸­çš„ä»»ä½•å±€éƒ¨å˜é‡éƒ½ä¸ä¼šåŠ è½½åˆ°è°ƒç”¨ç¨‹åºçš„ç¯å¢ƒä¸­<br><a id="more"></a></p>
<h1 id="require-name-gt-true-or-false"><a href="#require-name-gt-true-or-false" class="headerlink" title="require(name) # => true or false"></a>require(name) # =&gt; true or false</h1><p>åŠ è½½æŒ‡å®šåç§°çš„æ–‡ä»¶ï¼Œå¦‚æœåŠ è½½æˆåŠŸè¿”å› <code>true</code>, å¦‚æœå·²ç»åŠ è½½è¿”å› <code>false</code><br>å¦‚æœæ–‡ä»¶ä¸åœ¨ç»å¯¹è·¯å¾„ä¸­ï¼Œåˆ™å°†åœ¨ <code>$LOAD_PATH</code> <code>($:)</code> ä¸­æŸ¥æ‰¾<br>å¦‚æœæ–‡ä»¶ååç¼€ä¸º<code>.rb</code>ï¼Œåˆ™åŠ è½½æºæ–‡ä»¶ã€‚å¦‚æœæ‰©å±•åæ˜¯å½“å‰ç³»ç»Ÿå¹³å°ä¸Šçš„äºŒè¿›åˆ¶åº“æ–‡ä»¶ï¼Œå¦‚<code>.so</code>ï¼Œ<code>.o</code> æˆ–è€…<code>.dll</code>ï¼Œåˆ™ Ruby ä¼šäºŒè¿›åˆ¶åº“åŠ è½½ä¸º Ruby æ‰©å±•ã€‚å¦åˆ™ï¼ŒRuby ä¼šå°è¯•æ·»åŠ <code>.rb</code>ï¼Œ<code>.so</code> ç­‰ç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚å¦åˆ™ï¼Œå°±ä¼šè§¦å‘ LoadError å¼‚å¸¸<br>Ruby æ‰©å±•åç»™å‡ºçš„æ–‡ä»¶åå¯ä»¥ä½¿ç”¨ä»»ä½•å…±äº«åº“æ‰©å±•ï¼Œä¾‹å¦‚ï¼Œåœ¨ Linux ä¸Šï¼Œå¥—æ¥å­—æ‰©å±•åä¸º <code>socket.so</code>ï¼Œ<code>require "socket.dll"</code> å°†åŠ è½½å¥—æ¥å­—æ‰©å±•å<br>åŠ è½½æ–‡ä»¶çš„è·¯å¾„å°†è¢«æ·»åŠ åˆ° <code>$LOADED_FEATURES</code> <code>($")</code> ä¸­<br>åŠ è½½çš„æºæ–‡ä»¶ä¸­çš„ä»»ä½•å¸¸é‡æˆ–å…¨å±€å˜é‡éƒ½å°†åœ¨è°ƒç”¨ç¨‹åºçš„å…¨å±€å‘½åç©ºé—´ä¸­å¯ç”¨</p>
<h1 id="autoload-module-filename-gt-nil"><a href="#autoload-module-filename-gt-nil" class="headerlink" title="autoload(module, filename) # => nil"></a>autoload(module, filename) # =&gt; nil</h1><p><code>module</code> é€šå¸¸æ˜¯æ¨¡å—åæˆ–è€…ç±»åï¼Œåªæœ‰åœ¨è°ƒç”¨æ¨¡å—æˆ–è€…ç±»æ—¶æ‰ä¼šåŠ è½½æ–‡ä»¶</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># m.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  puts <span class="string">'Load M module'</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">hello</span></span></span><br><span class="line">      puts <span class="string">'Hello'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## require ï¼šåªåŠ è½½ä¸€æ¬¡</span></span><br><span class="line">puts <span class="string">"first load: <span class="subst">#{(<span class="keyword">require</span> <span class="string">'./m.rb'</span>)}</span>"</span></span><br><span class="line"><span class="comment">#= &gt; load M module</span></span><br><span class="line"><span class="comment">#= &gt; first load: true</span></span><br><span class="line">puts <span class="string">"load again: <span class="subst">#{(<span class="keyword">require</span> <span class="string">'./m.rb'</span>)}</span>"</span></span><br><span class="line"><span class="comment">#= &gt; load again: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># load ï¼šå¤šæ¬¡åŠ è½½</span></span><br><span class="line">puts <span class="string">"first load: <span class="subst">#{(load <span class="string">'./m.rb'</span>)}</span>"</span></span><br><span class="line"><span class="comment">#= &gt; load M module</span></span><br><span class="line"><span class="comment">#= &gt; first load: true</span></span><br><span class="line">puts <span class="string">"load again: <span class="subst">#{(load <span class="string">'./m.rb'</span>)}</span>"</span></span><br><span class="line"><span class="comment">#= &gt; load M module</span></span><br><span class="line"><span class="comment">#= &gt; load again: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># autoload ï¼šè°ƒç”¨æ—¶æ‰åŠ è½½</span></span><br><span class="line">puts <span class="string">"first load: <span class="subst">#{autoload(<span class="symbol">:M</span>,<span class="string">'./m.rb'</span>)}</span>"</span></span><br><span class="line"><span class="comment">#= &gt; first load:</span></span><br><span class="line">puts <span class="string">"load again: <span class="subst">#{autoload(<span class="symbol">:M</span>,<span class="string">'./m.rb'</span>)}</span>"</span></span><br><span class="line"><span class="comment">#= &gt; load again:</span></span><br><span class="line"></span><br><span class="line">M::A.hello</span><br><span class="line"><span class="comment"># =&gt; Load M module</span></span><br><span class="line"><span class="comment">#= &gt; Hello</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Ruby</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
      </tags>
  </entry>
  <entry>
    <title>Ruby å…ƒç¼–ç¨‹ - æ³•æœ¯æ‰‹å†Œ</title>
    <url>/2018/09/20/Ruby%E5%85%83%E7%BC%96%E7%A8%8B-%E6%B3%95%E6%9C%AF%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>è¿™é‡Œåˆ—å‡ºäº†ã€ŠRuby å…ƒç¼–ç¨‹ã€‹ä»‹ç»çš„æ‰€ç”¨æ³•æœ¯ </p>
</blockquote>
<h1 id="ç¯ç»•åˆ«å-Around-Alias"><a href="#ç¯ç»•åˆ«å-Around-Alias" class="headerlink" title="ç¯ç»•åˆ«å Around Alias"></a>ç¯ç»•åˆ«å Around Alias</h1><p>ä»ä¸€ä¸ªé‡æ–°å®šä¹‰çš„æ–¹æ³•ä¸­è°ƒç”¨åŸå§‹çš„ã€è¢«é‡å‘½åçš„ç‰ˆæœ¬</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">  alias_method <span class="symbol">:old_reverse</span>, <span class="symbol">:reverse</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">    <span class="string">"x<span class="subst">#{old_reverse}</span>x"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">'abc'</span>.reverse <span class="comment"># =&gt; 'xcbax'</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h1 id="ç™½æ¿ç±»-Blank-Slate"><a href="#ç™½æ¿ç±»-Blank-Slate" class="headerlink" title="ç™½æ¿ç±» Blank Slate"></a>ç™½æ¿ç±» Blank Slate</h1><p>ç§»é™¤ä¸€ä¸ªå¯¹è±¡ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼Œä»¥ä¾¿å§ä»–ä»¬è½¬æ¢æˆå¹½çµæ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args)</span></span></span><br><span class="line">    <span class="string">"<span class="subst">#{name}</span> is a ghost method"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.to_s <span class="comment"># =&gt; "#&lt;C:...&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; BasicObject</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args)</span></span></span><br><span class="line">    <span class="string">"<span class="subst">#{name}</span> is a ghost method"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">blank_slate = B.new</span><br><span class="line">blank_slate.to_s <span class="comment"># =&gt; "to_s is a ghost method"</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç±»æ‰©å±•-Class-Extension"><a href="#ç±»æ‰©å±•-Class-Extension" class="headerlink" title="ç±»æ‰©å±• Class Extension"></a>ç±»æ‰©å±• Class Extension</h1><p>é€šè¿‡å‘ç±»çš„å•ä»¶ç±»ä¸­åŠ å…¥æ¨¡å—æ¥å®šä¹‰ç±»æ–¹æ³•ï¼Œæ˜¯å¯¹è±¡æ‰©å±•çš„ä¸€ä¸ªç‰¹ä¾‹</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    <span class="string">'a method'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; C</span></span><br><span class="line">  <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">C.a_method <span class="comment"># =&gt; 'a method'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç±»å®ä¾‹å˜é‡-Class-Instance-Variable"><a href="#ç±»å®ä¾‹å˜é‡-Class-Instance-Variable" class="headerlink" title="ç±»å®ä¾‹å˜é‡ Class Instance Variable"></a>ç±»å®ä¾‹å˜é‡ Class Instance Variable</h1><p>åœ¨ä¸€ä¸ª Class å¯¹è±¡çš„å®ä¾‹å˜é‡ä¸­å­˜å‚¨ç±»çº§åˆ«çš„çŠ¶æ€</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  @my_class_instance_variable = <span class="string">'some value'</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">class_attribute</span></span></span><br><span class="line">    @my_class_instance_variable</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">C.class_attribute <span class="comment"># =&gt; 'some value'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç±»å®-Class-Macro"><a href="#ç±»å®-Class-Macro" class="headerlink" title="ç±»å® Class Macro"></a>ç±»å® Class Macro</h1><p>åœ¨ç±»å®šä¹‰ä¸­ä½¿ç”¨æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; C</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span><span class="params">(arg)</span></span></span><br><span class="line">    <span class="string">"a_method(<span class="subst">#{arg}</span> called)"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  a_method <span class="symbol">:x</span> <span class="comment"># =&gt; "a_method(x) called"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æ´å‡€å®¤-Clean-Room"><a href="#æ´å‡€å®¤-Clean-Room" class="headerlink" title="æ´å‡€å®¤ Clean Room"></a>æ´å‡€å®¤ Clean Room</h1><p>ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ä½œä¸ºæ‰§è¡Œä¸€ä¸ªä»£ç å—çš„ç¯å¢ƒ</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CleanRoom</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_userful_method</span> <span class="title">x</span></span></span><br><span class="line">    x * <span class="number">2</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">CleanRoom.new.instance_eval { a_userful_method(<span class="number">3</span>) } <span class="comment"># =&gt; 6</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä»£ç å¤„ç†å™¨-Code-Processor"><a href="#ä»£ç å¤„ç†å™¨-Code-Processor" class="headerlink" title="ä»£ç å¤„ç†å™¨ Code Processor"></a>ä»£ç å¤„ç†å™¨ Code Processor</h1><p>å¤„ç†ä»å¤–éƒ¨æ´»çš„çš„ä»£ç å­—ç¬¦ä¸²</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">File.readlines(<span class="string">'a_file_containing_lines_of_ruby.txt'</span>).each <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">  puts <span class="string">"<span class="subst">#{line.chomp}</span> ==&gt; <span class="subst">#{eval(line)}</span>"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =&gt; 1 + 1 ==&gt; 2</span></span><br><span class="line"><span class="comment"># =&gt; Math.log10(100) ==&gt; 2.0</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä¸Šä¸‹æ–‡æ¢é’ˆ-Context-Probe"><a href="#ä¸Šä¸‹æ–‡æ¢é’ˆ-Context-Probe" class="headerlink" title="ä¸Šä¸‹æ–‡æ¢é’ˆ Context Probe"></a>ä¸Šä¸‹æ–‡æ¢é’ˆ Context Probe</h1><p>æ‰§è¡Œä¸€ä¸ªä»£ç å—æ¥è·å–ä¸€ä¸ªå¯¹è±¡ä¸Šä¸‹æ–‡ä¸­çš„ä¿¡æ¯</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">    @x = <span class="string">'a private instance variable'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.instance_eval { @x } <span class="comment"># =&gt; 'a private instance variable'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="å»¶è¿Ÿæ‰§è¡Œ-Deferred-Evaluation"><a href="#å»¶è¿Ÿæ‰§è¡Œ-Deferred-Evaluation" class="headerlink" title="å»¶è¿Ÿæ‰§è¡Œ Deferred Evaluation"></a>å»¶è¿Ÿæ‰§è¡Œ Deferred Evaluation</h1><p>åœ¨ proc æˆ– lambda ä¸­å­˜å‚¨ä¸€æ®µä»£ç åŠå…¶ä¸Šä¸‹æ–‡ï¼Œç”¨äºä»¥åæ‰§è¡Œ</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">store</span><span class="params">(&amp;block)</span></span></span><br><span class="line">    @my_code_capsule = block</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(*args)</span></span></span><br><span class="line">    @my_code_capsule.call(*args)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.store { $X = <span class="number">1</span> }</span><br><span class="line">$X = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">obj.execute</span><br><span class="line">$X <span class="comment"># =&gt; 1</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="åŠ¨æ€æ´¾å‘-Dynamic-Dispatch"><a href="#åŠ¨æ€æ´¾å‘-Dynamic-Dispatch" class="headerlink" title="åŠ¨æ€æ´¾å‘ Dynamic Dispatch"></a>åŠ¨æ€æ´¾å‘ Dynamic Dispatch</h1><p>åœ¨è¿è¡Œæ˜¯å†³å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">method_to_call = <span class="symbol">:reverse</span></span><br><span class="line">obj = <span class="string">'abc'</span></span><br><span class="line">obj.send(method_to_call) <span class="comment"># =&gt; 'reverse'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="åŠ¨æ€æ–¹æ³•-Dynamic-Method"><a href="#åŠ¨æ€æ–¹æ³•-Dynamic-Method" class="headerlink" title="åŠ¨æ€æ–¹æ³• Dynamic Method"></a>åŠ¨æ€æ–¹æ³• Dynamic Method</h1><p>åœ¨è¿è¡Œæ˜¯å†³å®šæ€æ ·å®šä¹‰ä¸€ä¸ªæ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">C.class_eval <span class="keyword">do</span></span><br><span class="line">  define_method <span class="symbol">:a_method</span> <span class="keyword">do</span></span><br><span class="line">    <span class="string">'a dynamic method'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">c.a_method <span class="comment"># =&gt; 'a dynamic method'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="åŠ¨æ€ä»£ç†-Dynamic-Proxy"><a href="#åŠ¨æ€ä»£ç†-Dynamic-Proxy" class="headerlink" title="åŠ¨æ€ä»£ç† Dynamic Proxy"></a>åŠ¨æ€ä»£ç† Dynamic Proxy</h1><p>æŠŠä¸èƒ½å¯¹åº”æŸä¸ªæ–¹æ³•åçš„æ¶ˆæ¯è½¬å‘ç»™å¦å¤–ä¸€ä¸ªå¯¹è±¡</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDynamicProxy</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(target)</span></span></span><br><span class="line">    @target = target</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args, &amp;block)</span></span></span><br><span class="line">    <span class="string">"result: <span class="subst">#{@target.send(name, *args, &amp;block)}</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = MyDynamicProxy.new(<span class="string">'a string'</span>)</span><br><span class="line">obj.reverse <span class="comment"># =&gt; 'result: gnirts a'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æ‰å¹³ä½œç”¨åŸŸ-Flat-Scope"><a href="#æ‰å¹³ä½œç”¨åŸŸ-Flat-Scope" class="headerlink" title="æ‰å¹³ä½œç”¨åŸŸ Flat Scope"></a>æ‰å¹³ä½œç”¨åŸŸ Flat Scope</h1><p>ä½¿ç”¨é—­åŒ…åœ¨ä¸¤ä¸ªä½œç”¨åŸŸä¹‹é—´å…±äº«å˜é‡</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">an_attribute</span></span></span><br><span class="line">    @attr</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">a_variable = <span class="number">100</span></span><br><span class="line">obj.instance_eval <span class="keyword">do</span></span><br><span class="line">  @attr = a_variable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj.an_attribute <span class="comment"># =&gt; 100</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="å¹½çµæ–¹æ³•-Ghost-Method"><a href="#å¹½çµæ–¹æ³•-Ghost-Method" class="headerlink" title="å¹½çµæ–¹æ³• Ghost Method"></a>å¹½çµæ–¹æ³• Ghost Method</h1><p>å“åº”ä¸€ä¸ªæ²¡æœ‰å…³è”æ–¹æ³•çš„æ¶ˆæ¯</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args)</span></span></span><br><span class="line">    name.to_s.reverse</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.my_ghost_method <span class="comment"># =&gt; 'dohtem_tsohg_ym'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="é’©å­æ–¹æ³•-Hook-Method"><a href="#é’©å­æ–¹æ³•-Hook-Method" class="headerlink" title="é’©å­æ–¹æ³• Hook Method"></a>é’©å­æ–¹æ³• Hook Method</h1><p>å¤å†™ä¸€ä¸ªæ–¹æ³•æ¥æˆªè·å¯¹è±¡æ¨¡å‹äº‹ä»¶</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">$INHERITORS = []</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">inherited</span><span class="params">(subclass)</span></span></span><br><span class="line">    $INHERITORS &lt;&lt; subclass</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> &lt; C</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span> &lt; D</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span> &lt; E</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">$INHERITORS <span class="comment"># =&gt; [D, E ,F]</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="å†…æ ¸æ–¹æ³•-Kernel-Method"><a href="#å†…æ ¸æ–¹æ³•-Kernel-Method" class="headerlink" title="å†…æ ¸æ–¹æ³• Kernel Method"></a>å†…æ ¸æ–¹æ³• Kernel Method</h1><p>åœ¨ Kernel æ¨¡å—ä¸­å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œä½¿å¾—æ‰€æœ‰å¯¹è±¡éƒ½å¯ä½¿ç”¨</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Kernel</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    <span class="string">'a kernel method'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a_method <span class="comment"># =&gt; 'a kernel method'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æƒ°æ€§å®ä¾‹å˜é‡-Lazy-Instance-Variable"><a href="#æƒ°æ€§å®ä¾‹å˜é‡-Lazy-Instance-Variable" class="headerlink" title="æƒ°æ€§å®ä¾‹å˜é‡ Lazy Instance Variable"></a>æƒ°æ€§å®ä¾‹å˜é‡ Lazy Instance Variable</h1><p>ç­‰ç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªå®ä¾‹å˜é‡æ—¶æ‰å¯¹å®ƒè¿›è¡Œåˆå§‹åŒ–</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">attribute</span></span></span><br><span class="line">    @attribute = @attribute <span class="params">||</span> <span class="string">'some value'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.attribute <span class="comment"># =&gt; 'some value'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æ‹Ÿæ€æ–¹æ³•-Mimic-Method"><a href="#æ‹Ÿæ€æ–¹æ³•-Mimic-Method" class="headerlink" title="æ‹Ÿæ€æ–¹æ³• Mimic Method"></a>æ‹Ÿæ€æ–¹æ³• Mimic Method</h1><p>æŠŠä¸€ä¸ªæ–¹æ³•ä¼ªè£…æˆå¦å¤–ä¸€ç§è¯­è¨€æ„ä»¶</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BaseClass</span> <span class="title">name</span></span></span><br><span class="line">  name == <span class="string">'string'</span> ? String : Object</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &lt; BaseClass '<span class="title">string</span>' <span class="comment"># ä¸€ä¸ªçœ‹èµ·åƒç±»çš„æ–¹æ³•</span></span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:an_attribute</span> <span class="comment"># ä¸€ä¸ªçœ‹èµ·åƒå…³é”®å­—çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.an_attribute = <span class="number">1</span> <span class="comment"># ä¸€ä¸ªçœ‹èµ·åƒå±æ€§çš„æ–¹æ³•</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="çŒ´å­æ‰“è¡¥ä¸-Monkeypatch"><a href="#çŒ´å­æ‰“è¡¥ä¸-Monkeypatch" class="headerlink" title="çŒ´å­æ‰“è¡¥ä¸ Monkeypatch"></a>çŒ´å­æ‰“è¡¥ä¸ Monkeypatch</h1><p>ä¿®æ”¹å·²æœ‰ç±»çš„ç‰¹æ€§</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">'abc'</span>.reverse <span class="comment"># =&gt; 'cba'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">    <span class="string">'override'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">'abc'</span>.reverse <span class="comment"># =&gt; 'override'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="å‘½åç©ºé—´-Namespace"><a href="#å‘½åç©ºé—´-Namespace" class="headerlink" title="å‘½åç©ºé—´ Namespace"></a>å‘½åç©ºé—´ Namespace</h1><p>åœ¨ä¸€ä¸ªæ¨¡å—ä¸­å®šä¹‰å¸¸é‡ï¼Œä»¥é˜²æ­¢å‘½åå†²çª</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyNamespace</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Array</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">      <span class="string">'to_a method in array of the my namespace'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Array.new.to_s <span class="comment"># =&gt; []</span></span><br><span class="line">MyNamespace::Array.new.to_s <span class="comment"># =&gt; 'to_a method in array of the my namespace'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç©ºæŒ‡é’ˆä¿æŠ¤-Nil-Guard"><a href="#ç©ºæŒ‡é’ˆä¿æŠ¤-Nil-Guard" class="headerlink" title="ç©ºæŒ‡é’ˆä¿æŠ¤ Nil Guard"></a>ç©ºæŒ‡é’ˆä¿æŠ¤ Nil Guard</h1><p>ç”¨â€™||â€™æ“ä½œç¬¦è¦†å†™ä¸€ä¸ªç©ºå¼•ç”¨</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">x = <span class="literal">nil</span></span><br><span class="line">y = x <span class="params">||</span> <span class="string">'a value'</span> <span class="comment"># =&gt; 'a value'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="å¯¹è±¡æ‰©å±•-Object-Extension"><a href="#å¯¹è±¡æ‰©å±•-Object-Extension" class="headerlink" title="å¯¹è±¡æ‰©å±• Object Extension"></a>å¯¹è±¡æ‰©å±• Object Extension</h1><p>é€šè¿‡ä¸€ä¸ªå¯¹è±¡çš„å•ä»¶ç±»æ··å…¥æ¨¡å—æ¥å®šä¹‰å•ä»¶æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">obj = Object.new</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    <span class="string">'a singleton method in M'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></span><br><span class="line">  <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj.a_method <span class="comment"># =&gt; 'a singleton method'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æ‰“å¼€ç±»-Open-Class"><a href="#æ‰“å¼€ç±»-Open-Class" class="headerlink" title="æ‰“å¼€ç±» Open Class"></a>æ‰“å¼€ç±» Open Class</h1><p>ä¿®æ”¹å·²æœ‰çš„ç±»</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">    <span class="string">'a method'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">'abc'</span>.a_method <span class="comment"># =&gt; 'a method'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä¸‹åŒ…å«åŒ…è£…å™¨-Prepended-Wrapper"><a href="#ä¸‹åŒ…å«åŒ…è£…å™¨-Prepended-Wrapper" class="headerlink" title="ä¸‹åŒ…å«åŒ…è£…å™¨ Prepended Wrapper"></a>ä¸‹åŒ…å«åŒ…è£…å™¨ Prepended Wrapper</h1><p>è°ƒç”¨ä¸€ä¸ªç”¨ prepend æ–¹å¼è¦†å†™çš„æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">    <span class="string">"x<span class="subst">#{<span class="keyword">super</span>}</span>x"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">String.class_eval <span class="keyword">do</span></span><br><span class="line">  prepend M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">'abc'</span>.reverse <span class="comment"># =&gt; 'xcbax'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç»†åŒ–-Refinement"><a href="#ç»†åŒ–-Refinement" class="headerlink" title="ç»†åŒ– Refinement"></a>ç»†åŒ– Refinement</h1><p>ä¸ºç±»æ‰“è¡¥ä¸ï¼Œä½œç”¨èŒƒå›´ä»…åˆ°æ–‡ä»¶ç»“æŸï¼Œæˆ–ä»…é™äºåŒ…å«æ¨¡å—çš„ä½œç”¨åŸŸä¸­</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyRefinement</span></span></span><br><span class="line">  refine String <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">      <span class="string">'refinement reverse'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">'abc'</span>.reverse <span class="comment"># =&gt; 'cba'</span></span><br><span class="line">using MyRefinement</span><br><span class="line"><span class="string">'abc'</span>.reverse <span class="comment"># =&gt; 'refine reverse'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç»†åŒ–å°è£…å™¨-Refinement-Wrapper"><a href="#ç»†åŒ–å°è£…å™¨-Refinement-Wrapper" class="headerlink" title="ç»†åŒ–å°è£…å™¨ Refinement Wrapper"></a>ç»†åŒ–å°è£…å™¨ Refinement Wrapper</h1><p>åœ¨ç»†åŒ–ä¸­è°ƒç”¨éç»†åŒ–çš„æ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">StringRefinement</span></span></span><br><span class="line">  refine String <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">      <span class="string">"x<span class="subst">#{<span class="keyword">super</span>}</span>x"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">using StringRefinement</span><br><span class="line"><span class="string">'abc'</span>.reverse <span class="comment"># =&gt; 'xcbax'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æ²™ç›’-Sandbox"><a href="#æ²™ç›’-Sandbox" class="headerlink" title="æ²™ç›’ Sandbox"></a>æ²™ç›’ Sandbox</h1><p>åœ¨ä¸€ä¸ªå®‰å…¨çš„ç¯å¢ƒä¸­æ‰§è¡Œæœªæˆæƒçš„ä»£ç </p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sandbox</span> <span class="title">&amp;</span><span class="title">code</span></span></span><br><span class="line">  proc <span class="keyword">do</span></span><br><span class="line">    $SAFE = <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">  <span class="keyword">end</span>.call</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  sandbox { File.delete <span class="string">'a_file'</span> }</span><br><span class="line"><span class="keyword">rescue</span> Exception =&gt; ex</span><br><span class="line">  ex <span class="comment"># =&gt;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä½œç”¨åŸŸé—¨-Scope-Gate"><a href="#ä½œç”¨åŸŸé—¨-Scope-Gate" class="headerlink" title="ä½œç”¨åŸŸé—¨ Scope Gate"></a>ä½œç”¨åŸŸé—¨ Scope Gate</h1><p>ç”¨ class, module æˆ– def å…³é”®å­—æ¥éš”ç¦»ä½œç”¨åŸŸ</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">defined</span>? a <span class="comment"># =&gt; 'local-variable'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MModule</span></span></span><br><span class="line">  b = <span class="number">1</span></span><br><span class="line">  <span class="keyword">defined</span>? a <span class="comment"># =&gt; nil</span></span><br><span class="line">  <span class="keyword">defined</span>? b <span class="comment"># =&gt; 'local-variable'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">defined</span>? a <span class="comment"># =&gt; 'local-variable'</span></span><br><span class="line"><span class="keyword">defined</span>? b <span class="comment"># =&gt; nil</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="Self-Yield"><a href="#Self-Yield" class="headerlink" title="Self Yield"></a>Self Yield</h1><p>æŠŠ self ä¼ ç»™å½“å‰ä»£ç å—</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:name</span>, <span class="symbol">:surname</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">joe = Person.new <span class="keyword">do</span> <span class="params">|person|</span></span><br><span class="line">  person.name = <span class="string">'Joe'</span></span><br><span class="line">  person.surname = <span class="string">'Smith'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="å…±äº«ä½œç”¨åŸŸ-Shared-Scope"><a href="#å…±äº«ä½œç”¨åŸŸ-Shared-Scope" class="headerlink" title="å…±äº«ä½œç”¨åŸŸ Shared Scope"></a>å…±äº«ä½œç”¨åŸŸ Shared Scope</h1><p>åœ¨åŒä¸€ä¸ªæ‰å¹³ä½œç”¨åŸŸçš„å¤šä¸ªä¸Šä¸‹æ–‡ä¸­å…±äº«å˜é‡</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">lambda <span class="keyword">do</span></span><br><span class="line">  shared = <span class="number">10</span></span><br><span class="line">  <span class="keyword">self</span>.class_eval <span class="keyword">do</span></span><br><span class="line">    defined_method <span class="symbol">:counter</span> <span class="keyword">do</span></span><br><span class="line">      shared</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    defined_method <span class="symbol">:down</span> <span class="keyword">do</span></span><br><span class="line">      shared -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>.call</span><br><span class="line"></span><br><span class="line">counter <span class="comment"># =&gt; 10</span></span><br><span class="line"><span class="number">3</span>.times { down }</span><br><span class="line">counter <span class="comment"># =&gt; 7</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="å•ä»¶æ–¹æ³•-Singleton-Method"><a href="#å•ä»¶æ–¹æ³•-Singleton-Method" class="headerlink" title="å•ä»¶æ–¹æ³• Singleton Method"></a>å•ä»¶æ–¹æ³• Singleton Method</h1><p>åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–¹æ³•</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">obj = <span class="string">'abc'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">obj_singleton_method</span></span></span><br><span class="line">    <span class="string">'x'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj.obj_singleton_method <span class="comment"># =&gt; 'x'</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä»£ç å­—ç¬¦ä¸²-String-of-Code"><a href="#ä»£ç å­—ç¬¦ä¸²-String-of-Code" class="headerlink" title="ä»£ç å­—ç¬¦ä¸² String of Code"></a>ä»£ç å­—ç¬¦ä¸² String of Code</h1><p>æ‰§è¡Œä¸€æ®µè¡¨ç¤º ruby ä»£ç çš„å­—ç¬¦ä¸²</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">string_of_code = <span class="string">'1 + 1'</span></span><br><span class="line">eval(string_of_code) <span class="comment"># =&gt; 2</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç¬¦å·åˆ°Proc-Symbol-To-Proc"><a href="#ç¬¦å·åˆ°Proc-Symbol-To-Proc" class="headerlink" title="ç¬¦å·åˆ°Proc Symbol To Proc"></a>ç¬¦å·åˆ° Proc Symbol To Proc</h1><p>æŠŠä¸€ä¸ªè°ƒç”¨å•ä¸ªæ–¹çš„å—è½¬æ¢ä¸ºä¸€ä¸ªç¬¦å·</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">(<span class="number">1</span>..<span class="number">6</span>).map(&amp;<span class="symbol">:even?</span>) <span class="comment"># =&gt; [false, true, false, true, false, true]</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Ruby</category>
      </categories>
      <tags>
        <tag>Ruby</tag>
        <tag>å…ƒç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ Nginx éƒ¨ç½²é™æ€ç½‘ç«™</title>
    <url>/2018/09/17/%E4%BD%BF%E7%94%A8Nginx%E9%83%A8%E7%BD%B2%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>Nginxï¼ˆå‘éŸ³åŒ engine xï¼‰æ˜¯ä¸€ä¸ªå¼‚æ­¥æ¡†æ¶çš„ Web æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ç”¨ä½œåå‘ä»£ç†ï¼Œè´Ÿè½½å¹³è¡¡å™¨ å’Œ HTTP ç¼“å­˜ </p>
</blockquote>
<h1 id="é…ç½®é™æ€ç½‘ç«™"><a href="#é…ç½®é™æ€ç½‘ç«™" class="headerlink" title="é…ç½®é™æ€ç½‘ç«™"></a>é…ç½®é™æ€ç½‘ç«™</h1><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>; <span class="comment"># ç«¯å£å·</span></span><br><span class="line">    <span class="attribute">server_name</span> example.com; <span class="comment"># åŸŸå</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / {</span><br><span class="line">        <span class="attribute">root</span> /var/www/project_dir; <span class="comment"># é™æ€é¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="attribute">index</span> index.html; <span class="comment"># ç½‘ç«™åˆå§‹é¡µ</span></span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">404</span> /index.html; <span class="comment"># é™æ€é¡µé¢é‡å®šå‘æœåŠ¡å™¨é”™è¯¯é¡µé¢</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<p>å°†ä»¥ä¸Šé…ç½®å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åç¼–è¾‘ <code>nginx.conf</code>ï¼ˆä½¿ç”¨ <code>nginx -t</code> å¯ä»¥çœ‹åˆ°å…·ä½“è·¯å¾„ï¼‰ï¼Œç”¨ <code>include é…ç½®æ–‡ä»¶çš„è·¯å¾„;</code> å¼•å…¥åˆ°é…ç½®ä¸­ï¼Œé€€å‡ºç¼–è¾‘å™¨ï¼Œä½¿ç”¨ <code>nginx -t</code> æ¥æµ‹è¯•é…ç½®æ˜¯å¦æœ‰è¯¯ï¼Œæœ‰é—®é¢˜çš„æ”¹å¥½åå†è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œä½¿ç”¨ <code>nginx -s reload</code> é‡æ–°åŠ è½½ Nginx é…ç½®</p>
<hr>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>éƒ¨ç½²ï¼Œé™æ€</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ acme.sh çš„ DNS API é…ç½®ç”Ÿæˆé€šé…åŸŸåè¯ä¹¦</title>
    <url>/2020/07/11/%E4%BD%BF%E7%94%A8acme.sh%E7%9A%84DNS%20API%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E9%80%9A%E9%85%8D%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6/</url>
    <content><![CDATA[<h1 id="å‚è€ƒåœ°å€"><a href="#å‚è€ƒåœ°å€" class="headerlink" title="å‚è€ƒåœ°å€"></a>å‚è€ƒåœ°å€</h1><ul>
<li><a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi" target="_blank" rel="noopener">acme.sh DNS API è¯´æ˜</a></li>
</ul>
<h2 id="DNS-API-é…ç½®"><a href="#DNS-API-é…ç½®" class="headerlink" title="DNS API é…ç½®"></a>DNS API é…ç½®</h2><p>æˆ‘ç”¨çš„ä½¿ç”¨<a href="https://www.aliyun.com/minisite/goods?userCode=cma2zz5m" target="_blank" rel="noopener">é˜¿é‡Œäº‘</a>åŸŸåæœåŠ¡ï¼Œå…¶ä»–å¯ä»¥æŸ¥çœ‹<a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi" target="_blank" rel="noopener">ä½¿ç”¨è¯´æ˜</a></p>
<p>é¦–å…ˆï¼Œéœ€è¦ç™»å½•åˆ° Aliyun å¸æˆ·ä»¥<a href="https://ak-console.aliyun.com/#/accesskey" target="_blank" rel="noopener">è·å– API å¯†é’¥</a>ã€‚</p>
<a id="more"></a>
<p>ç„¶åå°†ä»¥ä¸‹é…ç½®å†™å…¥åˆ° <code>~/.bashrc</code> æ–‡ä»¶ä¸­ï¼Œç„¶åæ‰§è¡Œ <code>source ~/.bashrc</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> Ali_Key=<span class="string">"è·å–åˆ°çš„é˜¿é‡Œäº‘DNS API Key"</span></span><br><span class="line"><span class="built_in">export</span> Ali_Secret=<span class="string">"è·å–åˆ°çš„é˜¿é‡Œäº‘DNS API Secret"</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å®‰è£…-acme-sh"><a href="#å®‰è£…-acme-sh" class="headerlink" title="å®‰è£… acme.sh"></a>å®‰è£… acme.sh</h2><p>å·²ç»å®‰è£…å¥½çš„è¯·è·³è¿‡</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl https://get.acme.sh | sh</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ‰§è¡Œé¢å‘è¯ä¹¦å‘½ä»¤"><a href="#æ‰§è¡Œé¢å‘è¯ä¹¦å‘½ä»¤" class="headerlink" title="æ‰§è¡Œé¢å‘è¯ä¹¦å‘½ä»¤"></a>æ‰§è¡Œé¢å‘è¯ä¹¦å‘½ä»¤</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">acme.sh --issue --force -d example.com -d *.example.com --dns dns_ali</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å°†è¯ä¹¦å®‰è£…åˆ°æŒ‡å®šä½ç½®"><a href="#å°†è¯ä¹¦å®‰è£…åˆ°æŒ‡å®šä½ç½®" class="headerlink" title="å°†è¯ä¹¦å®‰è£…åˆ°æŒ‡å®šä½ç½®"></a>å°†è¯ä¹¦å®‰è£…åˆ°æŒ‡å®šä½ç½®</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">acme.sh --installcert -d example.com --key-file example.com.keyçš„è·¯å¾„ --fullchain-file fullchain.cerçš„è·¯å¾„ --reloadcmd <span class="string">"systemctl force-reload nginx"</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Nginx-é…ç½®"><a href="#Nginx-é…ç½®" class="headerlink" title="Nginx é…ç½®"></a>Nginx é…ç½®</h2><p>ç„¶åå‚è€ƒ<a href="/2018/10/06/%E5%85%8D%E8%B4%B9%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%AB%99%E6%B7%BB%E5%8A%A0HTTPS%E5%AE%89%E5%85%A8%E5%8A%A0%E5%AF%86/#%E4%BF%AE%E6%94%B9-Nginx-%E9%85%8D%E7%BD%AE">ä¿®æ”¹ - Nginx - é…ç½®</a></p>
<p>ç°åœ¨æƒ³è¦è·å¾— A+ è¯„çº§ï¼Œéœ€è¦è®¾ç½® nginx ä¸­çš„ <code>ssl_protocols</code> åªæä¾› TLSv1.2 æˆ–è€…æ›´é«˜çš„åè®®ï¼Œç¦ç”¨ä¸å®‰å…¨æˆ–ä¸åœ¨å—æ”¯æŒçš„åè®®ï¼Œæˆ‘å°†åŸå…ˆçš„ <code>ssl_protocols</code> æ›´æ”¹ä¸ºï¼š</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><a href="https://myssl.com/" target="_blank" rel="noopener">HTTPS è¯„çº§ https://myssl.com/</a></p>
<hr>
]]></content>
      <tags>
        <tag>é…ç½®</tag>
        <tag>Nginx</tag>
        <tag>acme.sh</tag>
        <tag>DNS</tag>
        <tag>HTTPS</tag>
      </tags>
  </entry>
  <entry>
    <title>å…è´¹ç»™è‡ªå·±çš„ç½‘ç«™æ·»åŠ  HTTPS å®‰å…¨åŠ å¯†</title>
    <url>/2018/10/06/%E5%85%8D%E8%B4%B9%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%AB%99%E6%B7%BB%E5%8A%A0HTTPS%E5%AE%89%E5%85%A8%E5%8A%A0%E5%AF%86/</url>
    <content><![CDATA[<h1 id="å‚è€ƒåœ°å€"><a href="#å‚è€ƒåœ°å€" class="headerlink" title="å‚è€ƒåœ°å€"></a>å‚è€ƒåœ°å€</h1><ul>
<li><a href="https://ruby-china.org/topics/31983" target="_blank" rel="noopener">ä½¿ç”¨ acme.sh ç»™ Nginx å®‰è£… Letâ€™s Encrypt æä¾›çš„å…è´¹ SSL è¯ä¹¦</a></li>
<li><a href="https://github.com/Neilpang/acme.sh/wiki/%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener">acme.sh è¯´æ˜</a></li>
<li><a href="https://www.textarea.com/zhicheng/fenxiang-yige-https-a-di-nginx-peizhi-320/" target="_blank" rel="noopener">åˆ†äº«ä¸€ä¸ª HTTPS A+ çš„ nginx é…ç½®</a></li>
</ul>
<h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><p>è¶…æ–‡æœ¬ä¼ è¾“å®‰å…¨åè®®ï¼ˆè‹±è¯­ï¼šHypertext Transfer Protocol Secureï¼Œç¼©å†™ï¼šHTTPSï¼Œå¸¸ç§°ä¸º HTTP over TLSï¼ŒHTTP over SSL æˆ– HTTP Secureï¼‰æ˜¯ä¸€ç§é€è¿‡è®¡ç®—å™¨ç½‘ä¸Šè¿›è¡Œå®‰å…¨é€šä¿¡çš„ä¼ è¾“åè®®ã€‚HTTPS ç»ç”± HTTP è¿›è¡Œé€šä¿¡ï¼Œä½†åˆ©ç”¨ SSL/TLS æ¥åŠ å¯†æ•°æ®åŒ…ã€‚HTTPS å¼€å‘çš„ä¸»è¦ç›®çš„ï¼Œæ˜¯æä¾›å¯¹ç½‘ç«™æœåŠ¡å™¨çš„èº«ä»½è®¤è¯ï¼Œä¿æŠ¤äº¤æ¢æ•°æ®çš„éšç§ä¸å®Œæ•´æ€§ã€‚è¿™ä¸ªåè®®ç”±ç½‘æ™¯å…¬å¸ï¼ˆNetscapeï¼‰åœ¨ 1994 å¹´é¦–æ¬¡æå‡ºï¼Œéšåæ‰©å±•åˆ°äº’è”ç½‘ä¸Šã€‚</p>
<a id="more"></a>
<h1 id="å®‰è£…-acme-sh"><a href="#å®‰è£…-acme-sh" class="headerlink" title="å®‰è£… acme.sh"></a>å®‰è£… acme.sh</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl  https://get.acme.sh | sh</span><br><span class="line"><span class="comment"># é‡æ–°è½½å…¥</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£…è¿‡ç¨‹ä¸ä¼šæ±¡æŸ“å·²æœ‰çš„ç³»ç»Ÿä»»ä½•åŠŸèƒ½å’Œæ–‡ä»¶ï¼Œæ‰€æœ‰çš„ä¿®æ”¹éƒ½é™åˆ¶åœ¨å®‰è£…ç›®å½•ä¸­: <code>~/.acme.sh/</code></p>
<h1 id="ç”Ÿæˆè¯ä¹¦"><a href="#ç”Ÿæˆè¯ä¹¦" class="headerlink" title="ç”Ÿæˆè¯ä¹¦"></a>ç”Ÿæˆè¯ä¹¦</h1><p><code>acme.sh</code> å®ç°äº† <code>acme</code> åè®®æ”¯æŒçš„æ‰€æœ‰éªŒè¯åè®®ã€‚ ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼éªŒè¯ï¼š<code>http</code> å’Œ <code>dns</code> éªŒè¯ã€‚æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>http</code> æ–¹å¼ï¼Œ<code>http</code> æ–¹å¼éœ€è¦åœ¨ä½ çš„ç½‘ç«™æ ¹ç›®å½•ä¸‹æ”¾ç½®ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªç›®å½•éœ€è¦è¯»å†™æƒé™ï¼Œæ¥éªŒè¯ä½ çš„åŸŸåæ‰€æœ‰æƒï¼Œå®ŒæˆéªŒè¯ã€‚å…¶ä»–æ–¹å¼å¯ä»¥å‚è€ƒ <a href="https://github.com/Neilpang/acme.sh/wiki/%E8%AF%B4%E6%98%8E#2-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6" target="_blank" rel="noopener">acme.sh ç”Ÿæˆè¯ä¹¦</a>ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">acme.sh --issue -d mydomain.com -w /home/user/www/mydomain.com/</span><br></pre></td></tr></tbody></table></figure>
<h1 id="copy-å®‰è£…è¯ä¹¦"><a href="#copy-å®‰è£…è¯ä¹¦" class="headerlink" title="copy / å®‰è£…è¯ä¹¦"></a>copy / å®‰è£…è¯ä¹¦</h1><p>æ³¨æ„ï¼Œé»˜è®¤ç”Ÿæˆçš„è¯ä¹¦éƒ½æ”¾åœ¨å®‰è£…ç›®å½•ä¸‹ï¼š<code>~/.acme.sh/</code>ï¼Œè¯·ä¸è¦ç›´æ¥ä½¿ç”¨æ­¤ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š ä¸è¦ç›´æ¥è®© <code>nginx</code>/<code>apache</code> çš„é…ç½®æ–‡ä»¶ä½¿ç”¨è¿™ä¸‹é¢çš„æ–‡ä»¶ã€‚è¿™é‡Œé¢çš„æ–‡ä»¶éƒ½æ˜¯å†…éƒ¨ä½¿ç”¨ï¼Œè€Œä¸”ç›®å½•ç»“æ„å¯èƒ½ä¼šå˜åŒ–ã€‚</p>
<p>æ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨ <code>--installcert</code> å‘½ä»¤ï¼Œå¹¶æŒ‡å®šç›®æ ‡ä½ç½®ï¼Œç„¶åè¯ä¹¦æ–‡ä»¶ä¼šè¢« copy åˆ°ç›¸åº”çš„ä½ç½®ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># key-file æœåŠ¡å™¨ç«¯çš„</span></span><br><span class="line">acme.sh --installcert -d mydomain.com \</span><br><span class="line">        --key-file /home/user/.nginx/ssl/mydomain.com.key \</span><br><span class="line">        --fullchain-file /home/user/.nginx/ssl/fullchain.cer \</span><br><span class="line">        --reloadcmd <span class="string">"sudo service nginx force-reload"</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œç”¨çš„æ˜¯ <code>service nginx force-reload</code>ï¼Œä¸æ˜¯ <code>service nginx reload</code>ï¼Œæ®æµ‹è¯•ï¼Œ<code>reload</code> å¹¶ä¸ä¼šé‡æ–°åŠ è½½è¯ä¹¦ï¼Œæ‰€ä»¥ç”¨çš„ <code>force-reload</code></p>
<p><code>--installcert</code> å‘½ä»¤å¯ä»¥æºå¸¦å¾ˆå¤šå‚æ•°ï¼Œæ¥æŒ‡å®šç›®æ ‡æ–‡ä»¶ã€‚å¹¶ä¸”å¯ä»¥æŒ‡å®š <code>reloadcmd</code>ï¼Œå½“è¯ä¹¦æ›´æ–°ä»¥åï¼Œ<code>reloadcmd</code> ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œè®©æœåŠ¡å™¨ç”Ÿæ•ˆï¼Œè¯¦ç»†å‚æ•°è¯·å‚è€ƒ: <a href="https://github.com/Neilpang/acme.sh#3-install-the-issued-cert-to-apachenginx-etc" target="_blank" rel="noopener">https://github.com/Neilpang/acme.sh#3-install-the-issued-cert-to-apachenginx-etc</a></p>
<p><code>Nginx</code> çš„é…ç½® <code>ssl_certificate</code> ä½¿ç”¨ <code>/home/user/.nginx/ssl/fullchain.cer</code>ï¼Œè€Œé <code>/home/user/.nginx/ssl/mydomain.com.cer</code>ï¼Œå¦åˆ™ <a href="https://www.ssllabs.com/ssltest/" target="_blank" rel="noopener">SSL Labs</a> çš„æµ‹è¯•ä¼šæŠ¥ <code>Chain issues Incomplete</code> é”™è¯¯</p>
<h1 id="ä¿®æ”¹-visudo"><a href="#ä¿®æ”¹-visudo" class="headerlink" title="ä¿®æ”¹ visudo"></a>ä¿®æ”¹ visudo</h1><p>ä¿®æ”¹ä¸€ä¸‹ <code>sudoer</code> æ–‡ä»¶ï¼Œè®© <code>sudo service nginx force-reload</code> ä¸éœ€è¦è¾“å…¥å¯†ç </p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo visudo</span><br></pre></td></tr></tbody></table></figure>
<p>æ–‡ä»¶å†…æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œ<code>user</code> æ˜¯ <code>acme.sh</code> å®‰è£…æ‰€ç”¨çš„è´¦å·<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">user ALL=(ALL) NOPASSWD: /usr/sbin/service nginx force-reload</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="nanoç¼–è¾‘å™¨çš„ç®€å•ä½¿ç”¨"><a href="#nanoç¼–è¾‘å™¨çš„ç®€å•ä½¿ç”¨" class="headerlink" title="nanoç¼–è¾‘å™¨çš„ç®€å•ä½¿ç”¨"></a>nano ç¼–è¾‘å™¨çš„ç®€å•ä½¿ç”¨</h2><ul>
<li><p>ç§»åŠ¨å…‰æ ‡<br>ç”¨ <code>Ctrl+b</code> ç§»åŠ¨åˆ°ä¸Šä¸€å­—ç¬¦ï¼Œ<code>Ctrl+f</code> ç§»åŠ¨åˆ°ä¸‹ä¸€å­—ç¬¦<br>ç”¨ <code>Ctrl+p</code> ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œï¼Œ<code>Ctrl+n</code> ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ<br>ç”¨ <code>Ctrl+y</code> ç§»åŠ¨åˆ°ä¸Šä¸€é¡µï¼Œ<code>Ctrl+v</code> ç§»åŠ¨åˆ°ä¸‹ä¸€é¡µ</p>
</li>
<li><p>ä¿å­˜<br>ä½¿ç”¨ <code>Ctrl+o</code> æ¥ä¿å­˜æ‰€åšçš„ä¿®æ”¹ï¼Œå›è½¦å³å¯</p>
</li>
<li><p>é€€å‡º<br>æŒ‰ <code>Ctrl+x</code></p>
</li>
<li><p>å…¶ä»–<br>å…¶ä¸­ <code>^</code> è¡¨ç¤º <code>Ctrl</code> é”®ï¼Œ<code>M</code> è¡¨ç¤º <code>Alt</code> é”®</p>
</li>
</ul>
<h2 id="ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨"><a href="#ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨" class="headerlink" title="ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨"></a>ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨</h2><p>å¦‚æœè§‰å¾— nano ä¸å¥½ç”¨ï¼Œå¯ä»¥è®¾ç½®ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨ï¼Œè¾“å…¥ä»¥ä¸‹åï¼ŒæŒ‰ç…§æç¤ºé€‰æ‹©å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo update-alternatives --config editor</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç”Ÿæˆ-dhparam-pem-æ–‡ä»¶"><a href="#ç”Ÿæˆ-dhparam-pem-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ dhparam.pem æ–‡ä»¶"></a>ç”Ÿæˆ dhparam.pem æ–‡ä»¶</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">openssl dhparam -out /home/user/.nginx/ssl/dhparam.pem 2048</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ä¿®æ”¹-Nginx-é…ç½®"><a href="#ä¿®æ”¹-Nginx-é…ç½®" class="headerlink" title="ä¿®æ”¹ Nginx é…ç½®"></a>ä¿®æ”¹ Nginx é…ç½®</h1><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> mydomain.com;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¯ä¹¦æ–‡ä»¶</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /home/user/.nginx/ssl/fullchain.cer;</span><br><span class="line">    <span class="comment"># è¯ä¹¦ç§é’¥</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /home/user/.nginx/ssl/mydomain.com.key;</span><br><span class="line">    <span class="comment"># ä¸ºDHEå¯†ç æŒ‡å®šå…·æœ‰DHå‚æ•°çš„æ–‡ä»¶</span></span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /home/user/.nginx/ssl/dhparam.pem;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼€å¯ç¼“å­˜ï¼Œæœ‰åˆ©äºå‡å°‘SSLæ¡æ‰‹å¼€é”€</span></span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="comment"># SSLä¼šè¯è¿‡æœŸæ—¶é—´ï¼Œæœ‰åˆ©äºå‡å°‘æœåŠ¡å™¨å¼€é”€</span></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line">    <span class="comment"># æŒ‡å®šå¯ç”¨çš„SSLåè®®</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">    <span class="comment"># å±è”½ä¸å®‰å…¨çš„åŠ å¯†æ–¹å¼</span></span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">"ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA"</span>;</span><br><span class="line">    <span class="comment"># æŒ‡å®šåœ¨ä½¿ç”¨SSLv3å’ŒTLSåè®®æ—¶ï¼ŒæœåŠ¡å™¨å¯†ç åº”ä¼˜å…ˆäºå®¢æˆ·ç«¯å¯†ç </span></span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># å¼€å¯HSTSï¼Œå¼ºåˆ¶å…¨ç«™åŠ å¯†ï¼Œå¦‚æœä½ çš„ç½‘ç«™è¦å¼•ç”¨ä¸åŠ å¯†çš„èµ„æºï¼Œæˆ–è€…è€ƒè™‘å°†æ¥å–æ¶ˆåŠ å¯†ï¼Œå°±ä¸è¦å¼€è¿™ä¸ª</span></span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">"max-age=63072000; includeSubdomains; preload"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ... å…¶ä»–é…ç½®</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>é…ç½®å¥½åï¼Œæ‰§è¡Œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æµ‹è¯•é…ç½®æ˜¯å¦æœ‰é—®é¢˜</span></span><br><span class="line">sudo service nginx configtest</span><br><span class="line"><span class="comment"># é‡å¯nginxæœåŠ¡</span></span><br><span class="line">sudo service nginx restart</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="æµ‹è¯•SSLæœåŠ¡"><a href="#æµ‹è¯•SSLæœåŠ¡" class="headerlink" title="æµ‹è¯•SSLæœåŠ¡"></a>æµ‹è¯• SSL æœåŠ¡</h1><p>æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤å®Œæ•´é…å¥½åï¼Œåº”è¯¥æ˜¯ A+<br>æµ‹è¯•åœ°å€ï¼š<a href="https://www.ssllabs.com/ssltest/" target="_blank" rel="noopener">https://www.ssllabs.com/ssltest/</a></p>
<h1 id="åç»­ç»´æŠ¤"><a href="#åç»­ç»´æŠ¤" class="headerlink" title="åç»­ç»´æŠ¤"></a>åç»­ç»´æŠ¤</h1><p>ç›®å‰ç”±äº <code>acme</code> åè®®å’Œ <code>letsencrypt CA</code> éƒ½åœ¨é¢‘ç¹çš„æ›´æ–°ï¼Œå› æ­¤ <code>acme.sh</code> ä¹Ÿç»å¸¸æ›´æ–°ä»¥ä¿æŒåŒæ­¥.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">acme.sh --upgrade</span><br><span class="line"><span class="comment"># å¼€å¯è‡ªåŠ¨æ›´æ–°</span></span><br><span class="line">acme.sh --upgrade --auto-upgrade</span><br><span class="line"><span class="comment"># å…³é—­è‡ªåŠ¨æ›´æ–°</span></span><br><span class="line">acme.sh --upgrade --auto-upgrade 0</span><br></pre></td></tr></tbody></table></figure>
<p>ç›®å‰è¯ä¹¦åœ¨ 60 å¤©ä»¥åä¼šè‡ªåŠ¨æ›´æ–°ï¼Œéœ€è¦å®šæœŸé‡æ–°ç”³è¯·ï¼Œè¿™éƒ¨åˆ† <code>acme.sh</code> å·²ç»å¸®ä½ åšäº†ï¼Œåœ¨å®‰è£…çš„æ—¶å€™å¾€ <code>crontab</code> å¢åŠ äº†ä¸€è¡Œæ¯å¤©æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ‰§è¡Œ <code>crontab -l</code>ï¼Œä¼šçœ‹åˆ°ä»¥ä¸‹ä¿¡æ¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">49 0 * * * <span class="string">"/home/user/.acme.sh"</span>/acme.sh --cron --home <span class="string">"/home/user/.acme.sh"</span> &gt; /dev/null</span><br></pre></td></tr></tbody></table></figure>
<p>ä½ å¯ä»¥å°è¯•æ‰§è¡Œä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦æ­£ç¡®è¿è¡Œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">"/home/user/.acme.sh"</span>/acme.sh --cron --home <span class="string">"/home/user/.acme.sh"</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>æœ€åèµ°ä¸€ä¸‹ <code>acme.sh --cron</code> çš„æµç¨‹çœ‹çœ‹èƒ½å¦æ­£ç¡®æ‰§è¡Œ<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">acme.sh --cron -f</span><br></pre></td></tr></tbody></table></figure><p></p>
<hr>
]]></content>
      <categories>
        <category>é…ç½®</category>
      </categories>
      <tags>
        <tag>é…ç½®</tag>
        <tag>Nginx</tag>
        <tag>acme.sh</tag>
        <tag>HTTPS</tag>
      </tags>
  </entry>
  <entry>
    <title>å‘ Gogs ä»“åº“æ¨é€ä»£ç åï¼Œè‡ªåŠ¨æ›´æ–°è¿œç¨‹ä»“åº“çš„ä»£ç </title>
    <url>/2018/09/20/%E5%90%91Gogs%E4%BB%93%E5%BA%93%E6%8E%A8%E9%80%81%E4%BB%A3%E7%A0%81%E5%90%8E%EF%BC%8C%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E7%9A%84%E4%BB%A3%E7%A0%81/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>Gogs æœåŠ¡åŒåšå®¢é™æ€æœåŠ¡åœ¨åŒä¸€æœåŠ¡å™¨ï¼Œæˆ‘æƒ³æ¯æ¬¡ push åï¼ŒGogs æ¥å—æˆåŠŸåä¼šè‡ªåŠ¨æ›´æ–°è¿œç¨‹æœåŠ¡å™¨çš„èµ„æº</p>
</blockquote>
<a id="more"></a>
<p>ç”¨ Hexo æ¡†æ¶å†™å®Œåšå®¢åï¼Œä½¿ç”¨ <code>hexo d -g</code> ä¼šå°†ç”Ÿæˆå¥½çš„é™æ€èµ„æºæ¨é€åˆ°è‡ªå·±çš„è¿œç¨‹ä»“åº“ï¼Œè¿œç¨‹æœåŠ¡å™¨æ¯æ¬¡éƒ½è¦ç™»ä¸Šå»æ‰‹åŠ¨ <code>git pull</code>ï¼Œè€Œå†™ä¸ª <code>crontab</code> æœ‰åˆè§‰å¾—ä¸æ€ä¹ˆå¥½ï¼Œç„¶åå°±æ‰¾åˆ°äº† <a href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90" target="_blank" rel="noopener">Git æœåŠ¡ç«¯é’©å­</a><code>post-receive</code> æ­¤æŒ‚é’©åœ¨æ•´ä¸ªè¿‡ç¨‹å®Œç»“ä»¥åè¿è¡Œï¼Œå¯ä»¥ç”¨æ¥æ›´æ–°å…¶ä»–ç³»ç»ŸæœåŠ¡æˆ–è€…é€šçŸ¥ç”¨æˆ·</p>
<p>è¿™ä¸ªé’©å­åœ¨ Gogs çš„ <code>gogs-repositories</code> ç›®å½•ä¸‹ï¼Œæ¯ä¸€ä¸ªä»“åº“ç›®å½•ä¸‹éƒ½æœ‰ <code>hooks/post-receive</code> è¿™ä¸ªé’©å­ï¼Œå°†ä»¥ä¸‹æ”¹å¥½åæ·»åŠ åˆ°æ–‡ä»¶å†…å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">unset</span> GIT_DIR</span><br><span class="line">NowPath=`<span class="built_in">pwd</span>`</span><br><span class="line">DeployPath=<span class="string">"/var/www/blog"</span> <span class="comment"># è¦å°†è¿™é‡Œçš„è·¯å¾„ä¿®æ”¹ä¸ºè¿œç¨‹æœåŠ¡å™¨ä¸Šå­˜æ”¾åšå®¢é™æ€èµ„æºçš„ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$DeployPath</span></span><br><span class="line">git pull origin master</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$NowPath</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure>
<hr>
]]></content>
      <categories>
        <category>Gogs</category>
      </categories>
      <tags>
        <tag>Gogs</tag>
        <tag>è‡ªåŠ¨éƒ¨ç½²</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨ Ubuntu ä¸Šéƒ¨ç½² Gogs</title>
    <url>/2018/09/22/%E5%9C%A8Ubuntu%E4%B8%8A%E9%83%A8%E7%BD%B2Gogs/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>Gogs æ˜¯ä¸€æ¬¾ææ˜“æ­å»ºçš„è‡ªåŠ© Git æœåŠ¡ã€‚</p>
</blockquote>
<h1 id="ä¸ºä»€ä¹ˆé€‰æ‹©Gogs"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©Gogs" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹©Gogs"></a>ä¸ºä»€ä¹ˆé€‰æ‹© Gogs</h1><p>æˆ‘ä¹‹å‰ä¹Ÿéƒ¨ç½²è¿‡ Gitlabï¼Œä½†æ˜¯å¤ªåƒèµ„æºäº†ï¼ŒGogs ç›¸æ¯”å°±å¾ˆè½»é‡ï¼Œæ­£å¥½åˆé€‚æ­å»ºç§äºº Git æœåŠ¡å™¨ã€‚</p>
<a id="more"></a>
<h1 id="å®‰è£…Nginxå’Œæ•°æ®åº“"><a href="#å®‰è£…Nginxå’Œæ•°æ®åº“" class="headerlink" title="å®‰è£…Nginxå’Œæ•°æ®åº“"></a>å®‰è£… Nginx å’Œæ•°æ®åº“</h1><p>è¦éƒ¨ç½² Gogsï¼Œéœ€è¦å®‰è£… Nginx å’Œæ•°æ®åº“</p>
<p>å®‰è£… Nginx</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nginx</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å®‰è£…å’Œåˆå§‹åŒ–æ•°æ®åº“"><a href="#å®‰è£…å’Œåˆå§‹åŒ–æ•°æ®åº“" class="headerlink" title="å®‰è£…å’Œåˆå§‹åŒ–æ•°æ®åº“"></a>å®‰è£…å’Œåˆå§‹åŒ–æ•°æ®åº“</h2><p>Gogs æ”¯æŒ MySQLï¼ŒPostgreSQLï¼ŒSQLite3ï¼ŒMSSQL å’Œ TiDBï¼Œè¿™é‡Œæˆ‘é€‰æ‹© PostgreSQL</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install postgresql</span><br></pre></td></tr></tbody></table></figure>
<p>å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œé…ç½®æ•°æ®åº“</p>
<h3 id="è®¾ç½®å¯†ç "><a href="#è®¾ç½®å¯†ç " class="headerlink" title="è®¾ç½®å¯†ç "></a>è®¾ç½®å¯†ç </h3><p>å®‰è£…å®Œæ¯•åéœ€è¦æ›´æ”¹ postgres ç”¨æˆ·çš„å¯†ç ï¼Œå¦åˆ™å°±æ²¡æ³•ä½¿ç”¨è¿™ä¸ªæ•°æ®åº“æœåŠ¡å™¨ã€‚ä»¥ postgres è¿™ä¸ªç³»ç»Ÿç”¨æˆ·çš„èº«ä»½è¿è¡Œ psql å‘½ä»¤</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo -u postgres psql</span><br></pre></td></tr></tbody></table></figure>
<p>è¿›å…¥ psql å‘½ä»¤æ¥å£</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> postgres <span class="keyword">WITH</span> <span class="keyword">PASSWORD</span> <span class="string">'è¿™é‡Œå†™postgresç”¨æˆ·çš„æ–°å¯†ç '</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>æ‰§è¡Œå®Œæ¯•åï¼Œ<code>\q</code> é€€å‡º</p>
<h3 id="åˆ›å»ºPostgreSQLçš„æ–°ç”¨æˆ·å’Œæ•°æ®åº“"><a href="#åˆ›å»ºPostgreSQLçš„æ–°ç”¨æˆ·å’Œæ•°æ®åº“" class="headerlink" title="åˆ›å»ºPostgreSQLçš„æ–°ç”¨æˆ·å’Œæ•°æ®åº“"></a>åˆ›å»º PostgreSQL çš„æ–°ç”¨æˆ·å’Œæ•°æ®åº“</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -D æ²¡æœ‰åˆ›å»ºæ•°æ®åº“çš„æƒé™</span></span><br><span class="line"><span class="comment"># -A æ²¡æœ‰æ–°å»ºç”¨æˆ·çš„æƒé™</span></span><br><span class="line"><span class="comment"># -P ä¸ºæ–°ç”¨æˆ·è®¾ç½®å¯†ç </span></span><br><span class="line">sudo -u postgres createuser -D -A -P gogs <span class="comment"># åˆ›å»ºç”¨æˆ·æ—¶ä¼šæç¤ºä½ è¾“å…¥å¯†ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ•°æ®åº“gogs-dbï¼Œä»¥ gogs ä½œä¸ºå®ƒçš„æ‰€æœ‰è€…</span></span><br><span class="line">sudo -u postgres createdb -O gogs gogs-db</span><br></pre></td></tr></tbody></table></figure>
<h1 id="å®‰è£…Gogs"><a href="#å®‰è£…Gogs" class="headerlink" title="å®‰è£…Gogs"></a>å®‰è£… Gogs</h1><h2 id="åˆ›å»ºæ–°ç”¨æˆ·"><a href="#åˆ›å»ºæ–°ç”¨æˆ·" class="headerlink" title="åˆ›å»ºæ–°ç”¨æˆ·"></a>åˆ›å»ºæ–°ç”¨æˆ·</h2><p>ä¸ºä»€ä¹ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘¢ï¼Ÿä¹‹å‰æˆ‘ä¹Ÿä¸€ç›´åœ¨çº ç»“ã€‚åæ¥ï¼Œå‘ç”Ÿäº†å¯†é’¥å†²çªï¼Œè¿™ä¸ªå°±æ˜¯å› ä¸ºç®¡ç†å‘˜å¯†é’¥æœˆ Gogs è¿è¡Œåº”ç”¨çš„ç”¨æˆ·å¯†é’¥ä¸€æ ·æ‰€å¯¼è‡´çš„ï¼Œå¦‚æœ Gogs è¿è¡Œåº”ç”¨çš„ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ä¹Ÿå°±ä¸ä¼šæœ‰è¿™ä¸ªæƒ…å†µäº†</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">useradd -m git</span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ°gitç”¨æˆ·</span></span><br><span class="line">sudo su git</span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ°gitç”¨æˆ·çš„HOMEç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸‹é¢æ“ä½œéƒ½æ˜¯åœ¨ git ç”¨æˆ·ä¸‹æ“ä½œ</p>
<h2 id="ä¸‹è½½Gogsç¨‹åº"><a href="#ä¸‹è½½Gogsç¨‹åº" class="headerlink" title="ä¸‹è½½Gogsç¨‹åº"></a>ä¸‹è½½ Gogs ç¨‹åº</h2><p>æˆ‘ä½¿ç”¨çš„æ˜¯ <a href="https://gogs.io/docs/installation/install_from_binary#%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8D%87%E7%BA%A7%EF%BC%9F" target="_blank" rel="noopener">Gogs äºŒè¿›åˆ¶å®‰è£…åŒ…</a>ï¼Œä¸‹è½½çš„æ˜¯ Linuxï¼Œ64 ä½ï¼ŒTAR.GZï¼Œå¯ä»¥ç”¨ <code>curl</code> æˆ–è€… <code>wget</code> ä¸‹è½½æ–‡ä»¶</p>
<p>ç¤ºä¾‹<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨curl</span></span><br><span class="line">curl -O https://dl.gogs.io/0.11.66/gogs_0.11.66_linux_amd64.tar.gz</span><br><span class="line"><span class="comment"># ä½¿ç”¨ wget</span></span><br><span class="line">wget https://dl.gogs.io/0.11.66/gogs_0.11.66_linux_amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>è§£å‹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">tar -zxvf gogs_0.11.66_linux_amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å¯åŠ¨GogsæœåŠ¡"><a href="#å¯åŠ¨GogsæœåŠ¡" class="headerlink" title="å¯åŠ¨GogsæœåŠ¡"></a>å¯åŠ¨ Gogs æœåŠ¡</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> gogs</span><br><span class="line">./gogs web</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åå†æµè§ˆå™¨è¾“å…¥ <code>IP:3000</code>ï¼Œç«¯å£å·é»˜è®¤æ˜¯ 3000ï¼Œè¿™ä¸ªæ—¶å€™è¿›å…¥åº”è¯¥è¿›å…¥çš„æ˜¯ <code>/install</code>ï¼Œå…·ä½“å°±æ˜¯ä¸€äº› Gogs ç¨‹åºçš„åŸºæœ¬è®¾ç½®ï¼Œå¡«å®Œæäº¤åï¼Œè¿›å…¥å‘½ä»¤è¡ŒæŒ‰ <code>ctl+c</code> ç»“æŸç¨‹åºï¼Œå°±å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥äº†</p>
<h1 id="Gogså®ˆæŠ¤è¿›ç¨‹"><a href="#Gogså®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="Gogså®ˆæŠ¤è¿›ç¨‹"></a>Gogs å®ˆæŠ¤è¿›ç¨‹</h1><p>è¿™éƒ¨åˆ†ä¸»è¦ä¿®æ”¹ Gogs é¡¹ç›®ä¸­çš„ <code>scripts</code> é‡Œçš„æ–‡ä»¶ï¼Œä»¥ä¸‹æ–‡ä»¶è¯·æ ¹æ®å®é™…æƒ…å†µåšä¿®æ”¹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vim scripts/init/debian/gogs</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides:          gogs</span></span><br><span class="line"><span class="comment"># Required-Start:    $syslog $network</span></span><br><span class="line"><span class="comment"># Required-Stop:     $syslog</span></span><br><span class="line"><span class="comment"># Should-Start:      mysql postgresql</span></span><br><span class="line"><span class="comment"># Should-Stop:       mysql postgresql</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: A self-hosted Git service written in Go.</span></span><br><span class="line"><span class="comment"># Description:       A self-hosted Git service written in Go.</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: Danny Boisvert</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do NOT "set -e"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PATH should only include /usr/* if it runs after the mountnfs.sh script</span></span><br><span class="line">PATH=/sbin:/usr/sbin:/bin:/usr/bin</span><br><span class="line">DESC=<span class="string">"Gogs"</span></span><br><span class="line">NAME=gogs</span><br><span class="line">SERVICEVERBOSE=yes</span><br><span class="line">PIDFILE=/var/run/<span class="variable">$NAME</span>.pid</span><br><span class="line">SCRIPTNAME=/etc/init.d/<span class="variable">$NAME</span></span><br><span class="line">WORKINGDIR=/home/git/gogs <span class="comment"># è¿™æ˜¯Gogsè¿è¡Œåº”ç”¨çš„é¡¹ç›®è·¯å¾„</span></span><br><span class="line">DAEMON=<span class="variable">$WORKINGDIR</span>/<span class="variable">$NAME</span></span><br><span class="line">DAEMON_ARGS=<span class="string">"web"</span></span><br><span class="line">USER=git <span class="comment"># è¿™æ˜¯Gogsè¿è¡Œåº”ç”¨çš„ç”¨æˆ·</span></span><br><span class="line"><span class="comment"># ä»¥ä¸‹ä¸åšä¿®æ”¹</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åé€€å‡ºï¼Œæ¥ç€ä¿®æ”¹ä¸‹ä¸€ä¸ªæ–‡ä»¶</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vim scripts/systemd/gogs.service</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Gogs</span><br><span class="line">After=syslog.target</span><br><span class="line">After=network.target</span><br><span class="line"><span class="comment"># ä¿®æ”¹è¿™é‡Œï¼Œå¦‚æœç”¨åˆ°å…¶ä»–æœåŠ¡çš„è¯</span></span><br><span class="line"><span class="comment"># After=mariadb.service mysqld.service postgresql.service memcached.service redis.service</span></span><br><span class="line"><span class="comment"># æˆ‘è¿™åªç”¨åˆ°äº†postgresql</span></span><br><span class="line">After=postgresql.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=git <span class="comment"># è¿™æ˜¯Gogsè¿è¡Œåº”ç”¨çš„ç”¨æˆ·</span></span><br><span class="line">Group=git <span class="comment"># è¯¥ç”¨æˆ·çš„ç»„</span></span><br><span class="line">WorkingDirectory=/home/git/gogs <span class="comment"># è¿™æ˜¯Gogsè¿è¡Œåº”ç”¨çš„é¡¹ç›®è·¯å¾„</span></span><br><span class="line"><span class="comment"># /home/git/gogs/gogsè¿™æ˜¯Gogsè¿è¡Œåº”ç”¨ç¨‹åºçš„ä½ç½®</span></span><br><span class="line">ExecStart=/home/git/gogs/gogs web</span><br><span class="line">Restart=always</span><br><span class="line"><span class="comment"># Environment=USERåæ˜¯Gogsè¿è¡Œåº”ç”¨çš„ç”¨æˆ·</span></span><br><span class="line"><span class="comment"># HOMEæ˜¯è¯¥ç”¨æˆ·çš„HOMEè·¯å¾„</span></span><br><span class="line">Environment=USER=git HOME=/home/git</span><br><span class="line"><span class="comment"># ä»¥ä¸‹ä¸åšä¿®æ”¹</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¿®æ”¹å®Œä¹‹åï¼Œè½¯è¿æ¥æ–‡ä»¶åˆ°ç›¸åº”ä½ç½®</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># é€€å‡ºgitç”¨æˆ·ï¼Œåˆ‡åˆ°ç®¡ç†å‘˜</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">sudo ln -s /home/git/gogs/scripts/init/debian/gogs /etc/init.d/gogs</span><br><span class="line">sudo ln -s /home/git/gogs/scripts/systemd/gogs.service  /etc/systemd/system/gogs.service</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ <code>service</code> å‘½ä»¤æ¥ç®¡ç† Gogs çš„æœåŠ¡çŠ¶æ€äº†</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ä¾‹å¦‚ï¼Œå¯åŠ¨gogsæœåŠ¡</span></span><br><span class="line">sudo service gogs start</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Nginxåå‘ä»£ç†GogsæœåŠ¡"><a href="#Nginxåå‘ä»£ç†GogsæœåŠ¡" class="headerlink" title="Nginxåå‘ä»£ç†GogsæœåŠ¡"></a>Nginx åå‘ä»£ç† Gogs æœåŠ¡</h1><p>åªéœ€è¦åœ¨ Nginx é…ç½®é‡Œæ–°å¼•å…¥ä¸€ä¸ª <code>server</code> å°±å¯ä»¥äº†</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>; <span class="comment"># ç«¯å£å·</span></span><br><span class="line">    <span class="attribute">server_name</span> gogs.example.com; <span class="comment"># åŸŸå</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / {</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:3000; <span class="comment"># Gogs æœåŠ¡åœ°å€</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>æ·»åŠ å®Œåï¼Œæ‰§è¡Œ <code>sudo nginx -t</code> æŸ¥çœ‹æ˜¯å¦æœ‰è¯¯ï¼Œç„¶åä½¿ç”¨ <code>sudo nginx -s reload</code> é‡è½½ Nginxï¼Œå°±å¯ä»¥äº†</p>
<hr>
]]></content>
      <categories>
        <category>Gogs</category>
      </categories>
      <tags>
        <tag>Gogs</tag>
        <tag>éƒ¨ç½²</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³ NFS è¯»å†™æ–‡ä»¶å¼‚å¸¸</title>
    <url>/2020/07/19/%E8%A7%A3%E5%86%B3NFS%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6%E5%BC%82%E5%B8%B8/</url>
    <content><![CDATA[<p>åº”ç”¨ç¨‹åºåœ¨è¯»å– Linux ç¯å¢ƒä½¿ç”¨ NFS æŒ‚è½½çš„æ–‡ä»¶æ—¶ï¼Œå‘ç°å‡  Kb çš„æ–‡ä»¶è¯»å–æ—¶å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯è¯»å–ä¸Š Mb çš„æ–‡ä»¶æ—¶ç‰¹åˆ«æ…¢ã€‚å¤šæ–¹æœç´¢å’Œè¯¢é—®ï¼Œæ˜¯å› ä¸ºå‡çº§å†…æ ¸åï¼Œéœ€è¦ä¿®æ”¹åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡å³å¯è§£å†³é—®é¢˜</p>
<a id="more"></a>
<h1 id="åŸæ–‡åœ°å€"><a href="#åŸæ–‡åœ°å€" class="headerlink" title="åŸæ–‡åœ°å€"></a>åŸæ–‡åœ°å€</h1><ul>
<li>é˜¿é‡Œäº‘ - <a href="https://help.aliyun.com/knowledge_detail/125389.html#task-1130493" target="_blank" rel="noopener">å¦‚ä½•ä¿®æ”¹åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚</a></li>
</ul>
<h1 id="å¦‚ä½•ä¿®æ”¹åŒæ—¶å‘èµ·çš„NFSè¯·æ±‚æ•°é‡"><a href="#å¦‚ä½•ä¿®æ”¹åŒæ—¶å‘èµ·çš„NFSè¯·æ±‚æ•°é‡" class="headerlink" title="å¦‚ä½•ä¿®æ”¹åŒæ—¶å‘èµ·çš„NFSè¯·æ±‚æ•°é‡"></a>å¦‚ä½•ä¿®æ”¹åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡</h1><p>NFS å®¢æˆ·ç«¯å¯¹äºåŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡è¿›è¡Œäº†æ§åˆ¶ï¼Œé»˜è®¤ç¼–è¯‘çš„å†…æ ¸ä¸­æ­¤å‚æ•°å€¼ä¸º 2ï¼Œä¸¥é‡å½±å“æ€§èƒ½ï¼Œå»ºè®®ä¿®æ”¹ä¸º 128ã€‚æœ¬æ–‡ä»‹ç»å¦‚ä½•ä¿®æ”¹åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ä¿®æ”¹åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡ã€‚</p>
<p><strong>è¯´æ˜</strong> ä½¿ç”¨æ–¹æ³•ä¸€ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦é‡å¯æœåŠ¡å™¨ ECSï¼Œé‡å¯æœåŠ¡å™¨å¯èƒ½å½±å“æ‚¨çš„ä¸šåŠ¡ä½¿ç”¨ã€‚å¦‚æœæ‚¨ä¸æƒ³é‡å¯æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•äºŒä¿®æ”¹åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡ã€‚</p>
<h2 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h2><ol>
<li><p>å®‰è£… NFS å®¢æˆ·ç«¯ï¼Œè¯¦æƒ…è¯·å‚è§<a href="https://help.aliyun.com/document_detail/90529.html#section-kvj-d02-szj" target="_blank" rel="noopener">å®‰è£… NFS å®¢æˆ·ç«¯</a>ã€‚</p>
</li>
<li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡ä¿®æ”¹ä¸º 128ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"options sunrpc tcp_slot_table_entries=128"</span> &gt;&gt; /etc/modprobe.d/sunrpc.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"options sunrpc tcp_max_slot_table_entries=128"</span> &gt;&gt;  /etc/modprobe.d/sunrpc.conf</span><br></pre></td></tr></tbody></table></figure>
<p><strong>è¯´æ˜</strong> æ‚¨åªéœ€åœ¨é¦–æ¬¡å®‰è£… NFS å®¢æˆ·ç«¯åæ‰§è¡Œä¸€æ¬¡æ­¤æ“ä½œï¼ˆå¿…é¡»é€šè¿‡ root ç”¨æˆ·æ“ä½œï¼‰ï¼Œä¹‹åæ— éœ€é‡å¤æ‰§è¡Œã€‚</p>
</li>
<li><p>é‡å¯äº‘æœåŠ¡å™¨ ECSã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œè¯¦æƒ…è¯·å‚è§<a href="https://help.aliyun.com/document_detail/90529.html#section-spc-nlh-cfb" target="_blank" rel="noopener">æŒ‚è½½ NFS æ–‡ä»¶ç³»ç»Ÿ</a>ã€‚</p>
</li>
<li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ä¿®æ”¹ç»“æœã€‚</p>
<p>å¦‚æœè¿”å›å€¼ä¸º 128ï¼Œåˆ™è¯´æ˜ä¿®æ”¹æˆåŠŸã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cat /proc/sys/sunrpc/tcp_slot_table_entries</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h2 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h2><ol>
<li><p>å®‰è£… NFS å®¢æˆ·ç«¯ï¼Œè¯¦æƒ…è¯·å‚è§<a href="https://help.aliyun.com/document_detail/90529.html#section-kvj-d02-szj" target="_blank" rel="noopener">å®‰è£… NFS å®¢æˆ·ç«¯</a>ã€‚</p>
</li>
<li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡ä¿®æ”¹ä¸º 128ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"options sunrpc tcp_slot_table_entries=128"</span> &gt;&gt; /etc/modprobe.d/sunrpc.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"options sunrpc tcp_max_slot_table_entries=128"</span> &gt;&gt;  /etc/modprobe.d/sunrpc.conf</span><br></pre></td></tr></tbody></table></figure>
<p><strong>è¯´æ˜</strong> æ‚¨åªéœ€åœ¨é¦–æ¬¡å®‰è£… NFS å®¢æˆ·ç«¯åæ‰§è¡Œä¸€æ¬¡æ­¤æ“ä½œï¼ˆå¿…é¡»é€šè¿‡ root ç”¨æˆ·æ“ä½œï¼‰ï¼Œä¹‹åæ— éœ€é‡å¤æ‰§è¡Œã€‚</p>
</li>
<li><p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œè¯¦æƒ…è¯·å‚è§<a href="https://help.aliyun.com/document_detail/90529.html#section-spc-nlh-cfb" target="_blank" rel="noopener">æŒ‚è½½ NFS æ–‡ä»¶ç³»ç»Ÿ</a>ã€‚</p>
</li>
<li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå†æ¬¡å°†åŒæ—¶å‘èµ·çš„ NFS è¯·æ±‚æ•°é‡ä¿®æ”¹ä¸º 128ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sysctl -w sunrpc.tcp_slot_table_entries=128</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>å¸è½½æ–‡ä»¶ç³»ç»Ÿï¼Œè¯¦æƒ…è¯·å‚è§<a href="https://help.aliyun.com/document_detail/91479.html#task-f5r-3kk-2fb" target="_blank" rel="noopener">åœ¨ Linux ç³»ç»Ÿä¸­å¸è½½æ–‡ä»¶ç³»ç»Ÿ</a>ã€‚</p>
</li>
<li><p>é‡æ–°æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œè¯¦æƒ…è¯·å‚è§<a href="https://help.aliyun.com/document_detail/90529.html#section-spc-nlh-cfb" target="_blank" rel="noopener">æŒ‚è½½ NFS æ–‡ä»¶ç³»ç»Ÿ</a>ã€‚</p>
</li>
<li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ä¿®æ”¹ç»“æœã€‚</p>
<p>å¦‚æœè¿”å›å€¼ä¸º 128ï¼Œåˆ™è¯´æ˜ä¿®æ”¹æˆåŠŸã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cat /proc/sys/sunrpc/tcp_slot_table_entries</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<hr>
]]></content>
      <categories>
        <category>NFS</category>
      </categories>
      <tags>
        <tag>NFS</tag>
      </tags>
  </entry>
</search>
